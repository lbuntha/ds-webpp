const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BxcSyS5K.js","assets/index-BjK2osQV.js","assets/index-CY9_X8xj.css"])))=>i.map(i=>d[i]);
import{u as G,r as n,j as e,f as x,_ as Y}from"./index-BjK2osQV.js";import{C as J}from"./Card-DROeE3UG.js";import{B as b}from"./Button-JCYNVMjR.js";import{t as y}from"./toast-DTXa3ATd.js";const O=["Incorrect Address / Unreachable","Recipient Requested Reschedule","Damaged Packaging - Repacking","Weather Conditions","Vehicle Breakdown","Held for Inspection / Customs","High Volume Backlog","Other"],X=()=>{const{t:Z}=G(),[R,V]=n.useState([]),[_,A]=n.useState(!1),[N,f]=n.useState(!1),[i,$]=n.useState(null),[m,C]=n.useState(null),[S,Q]=n.useState(""),P=n.useRef(null),[L,I]=n.useState(null),[B,F]=n.useState(O[0]),[M,q]=n.useState(""),[T,D]=n.useState(""),[g,d]=n.useState(null),E=n.useRef(null),[W,v]=n.useState(!1),j=async()=>{A(!0);try{const[t,s]=await Promise.all([x.getParcelBookings(),x.getCurrentUser()]);V(t.filter(o=>o.status!=="CANCELLED"&&o.status!=="COMPLETED")),$(s)}catch(t){console.error(t)}finally{A(!1)}};n.useEffect(()=>{j()},[]),n.useEffect(()=>{m!=null&&m.isOpen&&setTimeout(()=>{var t;return(t=P.current)==null?void 0:t.focus()},100)},[m]);const K=R.flatMap(t=>(t.items||[]).filter(s=>!s.targetBranchId||i!=null&&i.managedBranchId&&s.targetBranchId!==i.managedBranchId?!1:s.status==="PICKED_UP"||s.status==="IN_TRANSIT").map(s=>({bookingId:t.id,bookingRef:t.senderName,serviceType:t.serviceTypeName,item:s}))),z=async t=>{var o;const s=t.trim();if(s){f(!0),d(null);try{let a=K.find(c=>c.item.barcode===s),l=a==null?void 0:a.bookingId,r=a==null?void 0:a.item;if(!a)try{const c=await x.findBookingByBarcode(s);if(c){const u=(c.items||[]).find(w=>w.barcode===s||w.trackingCode===s||w.id===s);u&&(l=c.id,r=u)}}catch(c){console.error("Backend search failed",c)}if(!r||!l){d({type:"not_found",message:`No incoming parcel found with barcode: ${s}`}),D(""),setTimeout(()=>d(null),4e3),(o=E.current)==null||o.focus();return}if(r.status==="AT_WAREHOUSE"){d({type:"error",message:"Parcel is already AT WAREHOUSE."}),setTimeout(()=>d(null),4e3);return}if(["DELIVERED","RETURNED","CANCELLED"].includes(r.status)){d({type:"error",message:`Parcel is ${r.status}. Cannot receive.`}),setTimeout(()=>d(null),4e3);return}const p=(i==null?void 0:i.name)||"Warehouse Staff";await x.receiveItemAtWarehouse(l,r.id,p),d({type:"success",message:`âœ“ Received: ${r.receiverName} (${s})`}),D(""),await j(),setTimeout(()=>{var c;d(null),(c=E.current)==null||c.focus()},2500)}catch{d({type:"error",message:"Failed to confirm receipt. Please try again."}),setTimeout(()=>d(null),4e3)}finally{f(!1)}}},h=n.useRef(null),k=n.useRef(!1);n.useEffect(()=>{if(!W)return;let t=!0;return(async()=>{try{const{Html5Qrcode:o}=await Y(async()=>{const{Html5Qrcode:u}=await import("./index-BxcSyS5K.js");return{Html5Qrcode:u}},__vite__mapDeps([0,1,2]));if(await new Promise(u=>setTimeout(u,150)),!t)return;if(!document.getElementById("reader")){console.error("Scanner element not found");return}const l=new o("reader");h.current=l;const r={fps:10,qrbox:{width:250,height:250},aspectRatio:1},p=u=>{z(u),k.current=!1,l.stop().then(()=>{v(!1)}).catch(()=>{})},c=()=>{};try{await l.start({facingMode:"environment"},r,p,c),k.current=!0}catch(u){console.warn("Back camera failed:",u);try{await l.start({facingMode:"user"},r,p,c),k.current=!0}catch(w){console.error("All cameras failed:",w),y.error("Camera access denied or not available"),v(!1)}}}catch(o){console.error("Scanner init failed:",o),y.error("Failed to start camera"),t&&v(!1)}})(),()=>{t=!1,h.current&&k.current?(k.current=!1,h.current.stop().then(()=>{h.current&&(h.current.clear(),h.current=null)}).catch(()=>{h.current=null})):h.current=null}},[W]);const H=async()=>{if(!m)return;const{bookingId:t,item:s}=m;if(S===s.barcode){C(null);return}f(!0);try{const o=R.find(a=>a.id===t);if(o){const a=(o.items||[]).map(l=>l.id===s.id?{...l,barcode:S}:l);await x.saveParcelBooking({...o,items:a}),await j(),y.success("Barcode updated.")}C(null)}catch{y.error("Failed to update barcode.")}finally{f(!1)}},U=async()=>{if(!L)return;const{bookingId:t,item:s}=L,o=B==="Other"&&M?M:B;f(!0);try{const a=R.find(l=>l.id===t);if(a){const l=(a.items||[]).map(r=>r.id===s.id?{...r,delayReason:o,modifications:[...r.modifications||[],{timestamp:Date.now(),userId:(i==null?void 0:i.uid)||"warehouse",userName:(i==null?void 0:i.name)||"Warehouse Staff",field:"Delay Reason",oldValue:r.delayReason||"",newValue:o}]}:r);if(await x.saveParcelBooking({...a,items:l}),a.senderId){const r=await x.getUserUidByCustomerId(a.senderId);if(r){const p={id:`notif-delay-${Date.now()}`,targetAudience:r,title:"Shipment Delayed",message:`Your parcel ${s.trackingCode||""} is delayed. Reason: ${o}.`,type:"WARNING",read:!1,createdAt:Date.now(),metadata:{type:"BOOKING",bookingId:a.id}};await x.sendNotification(p)}}await j(),y.success("Delay reported and notification sent."),I(null)}}catch(a){console.error(a),y.error("Failed to save delay reason.")}finally{f(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Warehouse Operations"}),(i==null?void 0:i.managedBranchId)&&e.jsxs("span",{className:"text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded border border-indigo-200",children:["Managing Branch ID: ",i.managedBranchId]})]}),e.jsxs(b,{variant:"outline",onClick:j,isLoading:_,className:"text-xs",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"Refresh"]})]}),e.jsxs(J,{className:"border-2 border-dashed border-blue-300 bg-gradient-to-r from-blue-50 to-indigo-50",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-shrink-0 w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center",children:e.jsx("svg",{className:"w-6 h-6 text-blue-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-bold text-gray-800 mb-1",children:"Quick Scan to Confirm Receipt"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{ref:E,type:"text",className:"w-full pl-4 pr-12 py-3 text-lg font-mono tracking-wider border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white placeholder-gray-400",placeholder:"Scan barcode here...",value:T,onChange:t=>D(t.target.value),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),z(T))},disabled:N,autoFocus:!0}),N&&e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:e.jsxs("svg",{className:"animate-spin h-5 w-5 text-blue-600",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})})]}),e.jsx(b,{onClick:()=>v(!0),className:"bg-blue-600 hover:bg-blue-700 h-auto px-6",title:"Scan with Camera",children:e.jsxs("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 13a3 3 0 11-6 0 3 3 0 016 0z"})]})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Use barcode scanner, type manually, or use camera. Press Enter to confirm if typing."})]})]}),g&&e.jsxs("div",{className:`mt-3 p-3 rounded-lg flex items-center gap-2 ${g.type==="success"?"bg-green-100 text-green-800":g.type==="error"?"bg-red-100 text-red-800":"bg-orange-100 text-orange-800"}`,children:[g.type==="success"?e.jsx("svg",{className:"w-5 h-5 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}):g.type==="error"?e.jsx("svg",{className:"w-5 h-5 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}):e.jsx("svg",{className:"w-5 h-5 flex-shrink-0",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"font-medium",children:g.message})]})]}),m&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-all scale-100",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Scan Barcode"}),e.jsx("button",{onClick:()=>C(null),className:"text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-4 rounded-xl flex flex-col items-center justify-center border-2 border-dashed border-indigo-200",children:[e.jsx("svg",{className:"w-12 h-12 text-indigo-400 mb-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"1.5",d:"M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"})}),e.jsx("p",{className:"text-sm text-indigo-800 font-medium text-center",children:"Ready to Scan"}),e.jsx("p",{className:"text-xs text-indigo-600 text-center",children:"Use your scanner or type manually."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Barcode / Label ID"}),e.jsx("input",{ref:P,type:"text",className:"block w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg font-mono tracking-wider",placeholder:"Scan here...",value:S,onChange:t=>Q(t.target.value),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),H())}})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 text-xs text-gray-600",children:[e.jsx("strong",{children:"Item:"})," ",m.item.receiverName,e.jsx("br",{}),e.jsx("strong",{children:"Ref:"})," ",m.item.trackingCode||"N/A"]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx(b,{variant:"outline",onClick:()=>C(null),children:"Cancel"}),e.jsx(b,{onClick:H,isLoading:N,className:"bg-indigo-600 hover:bg-indigo-700",children:"Save Barcode"})]})]})}),L&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-all scale-100",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Report Parcel Delay"}),e.jsx("button",{onClick:()=>I(null),className:"text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"This will notify the customer that their parcel is delayed."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason"}),e.jsx("select",{className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-orange-500 focus:border-orange-500",value:B,onChange:t=>F(t.target.value),children:O.map(t=>e.jsx("option",{value:t,children:t},t))})]}),B==="Other"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Specific Reason"}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-orange-500 focus:border-orange-500",rows:2,placeholder:"Enter details...",value:M,onChange:t=>q(t.target.value)})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx(b,{variant:"outline",onClick:()=>I(null),children:"Cancel"}),e.jsx(b,{onClick:U,isLoading:N,className:"bg-orange-600 hover:bg-orange-700 text-white border-none",children:"Report & Notify"})]})]})}),W&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden relative",children:[e.jsxs("div",{className:"p-4 bg-gray-100 flex justify-between items-center border-b border-gray-200",children:[e.jsx("h3",{className:"font-bold text-gray-800",children:"Scan Barcode / QR"}),e.jsx("button",{onClick:()=>v(!1),className:"text-gray-500 hover:text-gray-700",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"p-4",children:e.jsx("div",{id:"reader",className:"w-full"})}),e.jsx("div",{className:"p-4 bg-gray-50 text-center text-xs text-gray-500",children:"Point camera at the parcel barcode"})]})})]})};function re(){return e.jsx(X,{})}export{re as default};
