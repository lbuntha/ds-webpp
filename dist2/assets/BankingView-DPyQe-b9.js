const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/glBookingService-DfpBjfXH.js","assets/index-BjK2osQV.js","assets/index-CY9_X8xj.css"])))=>i.map(i=>d[i]);
import{r,A as ne,i as ie,j as e,f as c,_ as le,h as ce,b as de}from"./index-BjK2osQV.js";import{C as X}from"./Card-DROeE3UG.js";import{B as A}from"./Button-JCYNVMjR.js";import{I as Q}from"./Input-B96Hj4QL.js";import{g as me}from"./errorUtils-CUS756ws.js";import{A as xe}from"./AccountForm-C9r7hRgr.js";import{S as ue}from"./SettlementReportModal-CGNRTnay.js";import{t as te}from"./toast-DTXa3ATd.js";import{A as he}from"./Avatar-BzcIcvYu.js";import{W as ge}from"./WalletDashboard-Bzjm7O1a.js";import{M as re}from"./Modal-B63ndL_a.js";import"./ImageUpload-CVnIZI_m.js";const pe=({accounts:g,branches:w,currencies:R=[],onSave:k,onCancel:p})=>{var E,h;const N=R.length>0?R:[{id:"curr-usd",code:"USD",name:"US Dollar",symbol:"$",exchangeRate:1,isBase:!0},{id:"curr-khr",code:"KHR",name:"Khmer Riel",symbol:"៛",exchangeRate:4100,isBase:!1}],[n,f]=r.useState(""),[l,d]=r.useState(""),[b,m]=r.useState(0),[v,C]=r.useState("USD"),[S,$]=r.useState(1),[F,I]=r.useState(new Date().toISOString().split("T")[0]),[U,O]=r.useState(""),[y,_]=r.useState(""),[P,M]=r.useState(((E=w[0])==null?void 0:E.id)||""),[J,H]=r.useState(!1),[V,B]=r.useState(null),q=g.filter(s=>s.type===ne.ASSET&&(s.subType===ie.CURRENT_ASSET||s.name.toLowerCase().includes("bank")||s.name.toLowerCase().includes("cash"))&&!s.isHeader);r.useEffect(()=>{if(n&&l){const s=g.find(T=>T.id===n),j=g.find(T=>T.id===l);s!=null&&s.currency&&(j!=null&&j.currency)&&s.currency===j.currency&&C(s.currency)}},[n,l]);const L=r.useMemo(()=>{const s=N.find(j=>j.code===v);return s?s.exchangeRate:1},[v,N]);r.useEffect(()=>{$(L)},[v,L]);const W=async s=>{var i,o;if(s.preventDefault(),B(null),!n||!l||b<=0){B("Please fill in all required fields.");return}if(n===l){B("Source and Destination accounts cannot be the same.");return}const j=S||1;if(j<=0){B("Exchange rate must be valid.");return}H(!0);const T=(i=g.find(u=>u.id===n))==null?void 0:i.name,G=(o=g.find(u=>u.id===l))==null?void 0:o.name,a=y||`Transfer from ${T} to ${G}`,x=b/j,t={id:`je-trans-${Date.now()}`,date:F,description:a,reference:U||`TRF-${Date.now().toString().slice(-6)}`,branchId:P,currency:v,exchangeRate:j,originalTotal:b,createdAt:Date.now(),lines:[{accountId:l,debit:x,credit:0,originalCurrency:v,originalExchangeRate:j,originalDebit:b,originalCredit:0},{accountId:n,debit:0,credit:x,originalCurrency:v,originalExchangeRate:j,originalDebit:0,originalCredit:b}]};try{await k(t)}catch(u){console.error(u),B(me(u))}finally{H(!1)}},z=(h=N.find(s=>s.code===v))==null?void 0:h.isBase;return e.jsx(X,{title:"Transfer Funds",children:e.jsxs("form",{onSubmit:W,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-red-50 p-4 rounded-xl border border-red-100",children:[e.jsx("label",{className:"block text-sm font-bold text-red-800 mb-2",children:"From (Source Account)"}),e.jsxs("select",{className:"block w-full px-3 py-2 border border-red-200 rounded-lg shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm bg-white",value:n,onChange:s=>f(s.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Select Account"}),q.map(s=>e.jsxs("option",{value:s.id,children:[s.code," - ",s.name," (",s.currency||"USD",")"]},s.id))]}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Account will be Credited"})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-xl border border-green-100",children:[e.jsx("label",{className:"block text-sm font-bold text-green-800 mb-2",children:"To (Destination Account)"}),e.jsxs("select",{className:"block w-full px-3 py-2 border border-green-200 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-white",value:l,onChange:s=>d(s.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Select Account"}),q.map(s=>e.jsxs("option",{value:s.id,children:[s.code," - ",s.name," (",s.currency||"USD",")"]},s.id))]}),e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Account will be Debited"})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-xl border border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Transaction Currency"}),e.jsx("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm",value:v,onChange:s=>C(s.target.value),children:N.map(s=>e.jsxs("option",{value:s.code,children:[s.code," - ",s.name]},s.id))})]}),e.jsx(Q,{label:"Amount",type:"number",step:"0.01",min:"0.01",value:b,onChange:s=>m(parseFloat(s.target.value)),required:!0,className:"font-bold text-gray-900"}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Exchange Rate (to USD)"}),e.jsx(Q,{type:"number",step:"any",value:S,onChange:s=>$(parseFloat(s.target.value)),disabled:z,required:!0}),!z&&e.jsxs("div",{className:"mt-1 flex justify-between items-center",children:[e.jsxs("span",{className:"text-[10px] text-gray-500",children:["System: ",L]}),S!==L&&e.jsx("button",{type:"button",onClick:()=>$(L),className:"text-[10px] text-indigo-600 hover:text-indigo-800 underline",children:"Reset"})]})]}),!z&&e.jsxs("p",{className:"text-xs text-gray-500 col-span-3",children:["Approx Base Value: $",(b/S).toLocaleString(void 0,{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(Q,{label:"Date",type:"date",value:F,onChange:s=>I(s.target.value),required:!0}),e.jsx(Q,{label:"Reference #",value:U,onChange:s=>O(s.target.value),placeholder:"Optional"}),e.jsx("div",{className:"md:col-span-3",children:e.jsx(Q,{label:"Description",value:y,onChange:s=>_(s.target.value),placeholder:"e.g. Monthly operating cash transfer"})}),e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Branch"}),e.jsx("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",value:P,onChange:s=>M(s.target.value),children:w.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]})]}),V&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:V}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t border-gray-100",children:[e.jsx(A,{type:"button",variant:"outline",onClick:p,children:"Cancel"}),e.jsx(A,{type:"submit",isLoading:J,children:"Submit for Approval"})]})]})})},fe=()=>{const[g,w]=r.useState([]),[R,k]=r.useState(!1),[p,N]=r.useState(null),[n,f]=r.useState(null),[l,d]=r.useState(null),[b,m]=r.useState(""),[v,C]=r.useState(void 0),[S,$]=r.useState([]),[F,I]=r.useState([]),[U,O]=r.useState([]),[y,_]=r.useState({}),[P,M]=r.useState([]),[J,H]=r.useState([]),[V,B]=r.useState([]),[q,L]=r.useState([]),[W,z]=r.useState([]),E=async()=>{k(!0);try{const[t,i,o,u,K,ae,Z,D,se,ee]=await Promise.all([c.getPendingWalletTransactions(),c.getAccounts(),c.getParcelBookings(),c.getParcelServices(),c.getSettings(),c.logisticsService.getDriverCommissionRules(),c.getEmployees(),c.getCurrencies(),c.getTaxRates(),c.getBranches()]);w(t),$(i),I(o),O(u),_(K),L(ae),z(Z),M(D),H(se),B(ee)}catch(t){console.error(t)}finally{k(!1)}};r.useEffect(()=>{E()},[]);const h=r.useMemo(()=>{const t={usd:{settlement:0,withdrawal:0,deposit:0,total:0},khr:{settlement:0,withdrawal:0,deposit:0,total:0}};return g.forEach(i=>{var K;const o=i.currency==="KHR"?"khr":"usd",u=((K=i.type)==null?void 0:K.toLowerCase())||"settlement";u==="settlement"?t[o].settlement+=i.amount:u==="withdrawal"?t[o].withdrawal+=i.amount:u==="deposit"&&(t[o].deposit+=i.amount),t[o].total+=i.amount}),t},[g]),s=t=>{f(t)},j=t=>{n&&(C(t),d({type:"APPROVE",txn:n}),f(null))},T=t=>{d({type:"REJECT",txn:t}),m("")},G=async()=>{if(!l||l.type!=="APPROVE")return;const{txn:t}=l;N(t.id);try{const i=await c.getCurrentUser(),o=V.length>0?V[0].id:"b1",u=await c.getDocument("users",t.userId),K=(u==null?void 0:u.role)==="customer",Z=(t.currency||"USD").toUpperCase()==="USD";let D=t.bankAccountId;if(!D||D==="system"||D==="system-payout"){const Y=y.transactionRules?y.transactionRules[4]:null;K?D=Z?y.defaultCustomerSettlementBankIdUSD||y.defaultCustomerSettlementBankId:y.defaultCustomerSettlementBankIdKHR||y.defaultCustomerSettlementBankId:Y?D=Y:D=Z?y.defaultDriverSettlementBankIdUSD||y.defaultDriverSettlementBankId:y.defaultDriverSettlementBankIdKHR||y.defaultDriverSettlementBankId}if(!D)throw new Error("Settlement Bank Account is not configured in Settings.");const{GLBookingService:se}=await le(async()=>{const{GLBookingService:Y}=await import("./glBookingService-DfpBjfXH.js");return{GLBookingService:Y}},__vite__mapDeps([0,1,2])),ee=await se.createGLEntry({transactionType:t.type,userId:t.userId,userName:t.userName,userRole:K?"customer":"driver",amount:t.amount,currency:t.currency,relatedItems:t.relatedItems,bankAccountId:D,description:t.description,branchId:o},{accounts:S,settings:y,employees:W,commissionRules:q,bookings:F,currencies:P});if(await c.addTransaction(ee),await c.approveWalletTransaction(t.id,i.uid,ee.id,v),t.type==="SETTLEMENT"&&t.relatedItems&&t.relatedItems.length>0){const Y=(t.description||"").toLowerCase().includes("settlement")&&!(t.description||"").toLowerCase().includes("payout");(t.description||"").toLowerCase().includes("taxi")?(await c.markTaxiFeesAsReimbursed(t.relatedItems),await c.markTaxiFeeTransactionsAsSettled(t.relatedItems,t.userId)):await c.settleParcelItems(t.relatedItems,Y?"driver":"customer",t.currency,t.id)}const oe={id:`notif-wallet-${Date.now()}`,targetAudience:t.userId,title:"Wallet Request Approved",message:`Your ${(t.type||"").toLowerCase()} request for ${t.amount} ${t.currency} has been approved.`,type:"SUCCESS",read:!1,createdAt:Date.now()};await c.sendNotification(oe),d(null),C(void 0),await E(),te.success("Transaction Approved & Posted to GL")}catch(i){console.error(i),te.error("Approval Failed: "+i.message)}finally{N(null)}},a=async()=>{if(!l||l.type!=="REJECT")return;const{txn:t}=l;if(!b.trim()){te.warning("Please provide a reason for rejection.");return}N(t.id);try{const i=await c.getCurrentUser(),o=`${b} (Rejected by ${(i==null?void 0:i.name)||"Admin"})`;await c.rejectWalletTransaction(t.id,o);const u={id:`notif-wallet-rej-${Date.now()}`,targetAudience:t.userId,title:"Wallet Request Rejected",message:`Your ${(t.type||"").toLowerCase()} request was rejected. Reason: ${b}`,type:"ERROR",read:!1,createdAt:Date.now()};await c.sendNotification(u),d(null),await E()}catch(i){te.error("Rejection Failed: "+i.message)}finally{N(null)}},x=t=>{const i=S.find(o=>o.id===t);return i?`${i.name} (${i.code})`:"Unknown Bank"};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Pending Wallet Requests"}),e.jsx(A,{variant:"outline",onClick:E,isLoading:R,className:"text-xs",children:"Refresh"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-xs uppercase text-green-600 font-medium mb-1",children:"Total USD Pending"}),e.jsxs("div",{className:"text-2xl font-bold text-green-800",children:["$",h.usd.total.toLocaleString(void 0,{minimumFractionDigits:2})]}),e.jsxs("div",{className:"mt-2 text-xs text-green-600 space-x-4",children:[h.usd.settlement>0&&e.jsxs("span",{children:["Settlements: $",h.usd.settlement.toFixed(2)]}),h.usd.withdrawal>0&&e.jsxs("span",{children:["Withdrawals: $",h.usd.withdrawal.toFixed(2)]}),h.usd.deposit>0&&e.jsxs("span",{children:["Deposits: $",h.usd.deposit.toFixed(2)]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-xs uppercase text-blue-600 font-medium mb-1",children:"Total KHR Pending"}),e.jsxs("div",{className:"text-2xl font-bold text-blue-800",children:[h.khr.total.toLocaleString()," ៛"]}),e.jsxs("div",{className:"mt-2 text-xs text-blue-600 space-x-4",children:[h.khr.settlement>0&&e.jsxs("span",{children:["Settlements: ",h.khr.settlement.toLocaleString()," ៛"]}),h.khr.withdrawal>0&&e.jsxs("span",{children:["Withdrawals: ",h.khr.withdrawal.toLocaleString()," ៛"]}),h.khr.deposit>0&&e.jsxs("span",{children:["Deposits: ",h.khr.deposit.toLocaleString()," ៛"]})]})]})]}),e.jsx(X,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"User"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Type"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Amount"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Requested Bank"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Action"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[g.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:t.date}),e.jsx("td",{className:"px-6 py-4 text-sm font-medium text-gray-900",children:t.userName}),e.jsx("td",{className:"px-6 py-4 text-sm",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-bold ${t.type==="DEPOSIT"?"bg-green-100 text-green-800":t.type==="WITHDRAWAL"?"bg-red-100 text-red-800":"bg-purple-100 text-purple-800"}`,children:t.type})}),e.jsxs("td",{className:"px-6 py-4 text-sm text-right font-bold text-gray-900",children:[t.amount.toLocaleString()," ",t.currency]}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600 font-mono text-xs",children:t.bankAccountId?x(t.bankAccountId):"-"}),e.jsxs("td",{className:"px-6 py-4 text-right text-sm font-medium space-x-2",children:[e.jsx("button",{onClick:()=>T(t),className:"text-red-600 hover:text-red-900",children:"Reject"}),e.jsx("button",{onClick:()=>s(t),className:"bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700",children:"Approve"})]})]},t.id)),g.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center py-8 text-gray-500",children:"No pending requests."})})]})]})})}),n&&e.jsx(ue,{transaction:n,onClose:()=>f(null),isApproving:!0,onConfirm:j,bookings:F,commissionRules:q,employees:W,accounts:S,settings:y,currencies:P,taxRates:J}),l&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-md p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:l.type==="APPROVE"?"Confirm Approval":"Reject Request"}),l.type==="REJECT"?e.jsx(Q,{value:b,onChange:t=>m(t.target.value),placeholder:"Reason for rejection"}):e.jsxs("div",{className:"text-sm text-gray-600 mb-4 space-y-2",children:[e.jsxs("p",{children:["Approve ",l.txn.type," of ",l.txn.amount," ",l.txn.currency,"?"]}),e.jsxs("p",{className:"text-xs bg-yellow-50 p-2 rounded text-yellow-800 border border-yellow-100",children:[e.jsx("strong",{children:"Accounting Action:"}),l.txn.type==="SETTLEMENT"?" Creates Journal Entry for Cash Receipt, Revenue Recognition, Tax, and Customer Liability Adjustment.":" Creates Journal Entry for Cash Movement."]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(A,{variant:"outline",onClick:()=>d(null),children:"Cancel"}),e.jsx(A,{onClick:l.type==="APPROVE"?G:a,isLoading:!!p,className:l.type==="APPROVE"?"bg-green-600":"bg-red-600",children:"Confirm"})]})]})})]})},je=()=>{const[g,w]=r.useState([]),[R,k]=r.useState(!1),[p,N]=r.useState(""),[n,f]=r.useState("ALL"),[l,d]=r.useState(null);r.useEffect(()=>{(async()=>{k(!0);try{const C=(await c.getUsers()).filter(S=>S.role==="customer"||S.role==="driver");w(C)}catch(v){console.error(v)}finally{k(!1)}})()},[]);const b=r.useMemo(()=>g.filter(m=>{const v=n==="ALL"||m.role===n,C=(m.name||"").toLowerCase().includes(p.toLowerCase())||(m.email||"").toLowerCase().includes(p.toLowerCase())||m.phone&&m.phone.includes(p);return v&&C}),[g,n,p]);return e.jsx("div",{className:"space-y-6",children:l?e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>d(null),className:"text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Back to Directory"]})}),e.jsx(ge,{user:l})]}):e.jsxs(X,{title:"User Wallet Directory",children:[e.jsxs("div",{className:"mb-6 flex flex-col md:flex-row justify-between items-center gap-4",children:[e.jsxs("div",{className:"flex space-x-2 bg-gray-100 p-1 rounded-lg",children:[e.jsx("button",{onClick:()=>f("ALL"),className:`px-4 py-2 rounded-md text-sm font-medium transition-all ${n==="ALL"?"bg-white shadow text-gray-900":"text-gray-500 hover:text-gray-900"}`,children:"All"}),e.jsx("button",{onClick:()=>f("customer"),className:`px-4 py-2 rounded-md text-sm font-medium transition-all ${n==="customer"?"bg-white shadow text-teal-700":"text-gray-500 hover:text-gray-900"}`,children:"Customers"}),e.jsx("button",{onClick:()=>f("driver"),className:`px-4 py-2 rounded-md text-sm font-medium transition-all ${n==="driver"?"bg-white shadow text-orange-700":"text-gray-500 hover:text-gray-900"}`,children:"Drivers"})]}),e.jsxs("div",{className:"relative w-full md:w-64",children:[e.jsx("input",{type:"text",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-sm",placeholder:"Search users...",value:p,onChange:m=>N(m.target.value)}),e.jsx("svg",{className:"w-5 h-5 text-gray-400 absolute left-3 top-2.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"User"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Role"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Action"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[b.map(m=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{name:m.name,size:"sm",className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:m.name}),e.jsx("div",{className:"text-xs text-gray-500",children:m.email})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full capitalize ${m.role==="customer"?"bg-teal-100 text-teal-800":m.role==="driver"?"bg-orange-100 text-orange-800":"bg-gray-100"}`,children:m.role})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:m.phone||"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsx("button",{onClick:()=>d(m),className:"text-indigo-600 hover:text-indigo-900 bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100 hover:border-indigo-300 transition-all",children:"View Wallet"})})]},m.uid)),b.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-6 py-10 text-center text-gray-500",children:R?"Loading users...":"No users found matching your filters."})})]})]})})]})})},be=({accounts:g,transactions:w,branches:R,currencies:k=[],currentUser:p,onTransactionAction:N,onAddAccount:n,pendingWalletRequests:f=[]})=>{const[l,d]=r.useState("LIST"),[b,m]=r.useState(0),[v,C]=r.useState(0),[S,$]=r.useState({}),[F,I]=r.useState(!1),[U,O]=r.useState(""),[y,_]=r.useState(null),[P,M]=r.useState(!1),[J,H]=r.useState(null),V=a=>{_(a),O(""),I(!0)},B=async()=>{y&&U.trim()&&(await N({...y,rejectionReason:U},"REJECT"),I(!1),_(null),O(""),W())},q=a=>{a.createdBy===(p==null?void 0:p.uid)?(H(a),M(!0)):L(a)},L=async a=>{await N(a,"APPROVE"),P&&(M(!1),H(null)),W()},W=r.useCallback(async()=>{s(!0),await new Promise(a=>setTimeout(a,500)),E(new Date),s(!1)},[]),[z,E]=r.useState(new Date),[h,s]=r.useState(!1),j=r.useMemo(()=>{const a={};return w.forEach(x=>{x.status==="POSTED"&&(x.lines||[]).forEach(t=>{const i=t.accountId;a[i]||(a[i]=0);const o=Number(t.debit)||0,u=Number(t.credit)||0;a[i]+=o-u})}),g.filter(x=>{const t=x.type===ne.ASSET,i=x.name.toLowerCase().includes("bank")||x.name.toLowerCase().includes("cash")||x.name.toLowerCase().includes("settlement")||!!x.bankAccountNumber;return t&&i}).map(x=>({...x,nativeBalance:a[x.id]||0}))},[g,w]),T=r.useMemo(()=>{var x;const a=((x=k==null?void 0:k.find(t=>t.code==="KHR"))==null?void 0:x.exchangeRate)||4e3;return j.reduce((t,i)=>{const o=i.nativeBalance||0;return i.currency==="KHR"?t+o/a:t+o},0)},[j,k]),G=r.useMemo(()=>w.filter(a=>a.status==="PENDING_APPROVAL"),[w]);return r.useEffect(()=>{m(f.length),C(w.filter(a=>a.status==="PENDING_APPROVAL").length)},[w,f]),l==="APPROVALS"?e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>d("LIST"),className:"text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Back to Banking"]})}),e.jsx(X,{title:"Pending Approvals",children:G.length===0?e.jsx("div",{className:"text-center py-12 text-gray-500 bg-gray-50 rounded-lg",children:"No pending approvals found."}):e.jsx("div",{className:"space-y-4",children:G.map(a=>(a.createdBy,p==null||p.uid,e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-bold px-2 py-0.5 rounded bg-yellow-100 text-yellow-800",children:"PENDING APPROVAL"}),e.jsx("span",{className:"text-xs text-gray-500",children:a.reference})]}),e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:a.description}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:["Created by ",e.jsx("span",{className:"font-semibold",children:a.createdByName||"Unknown"})," on ",new Date(a.createdAt).toLocaleDateString()]}),e.jsxs("div",{className:"mt-2 text-sm text-gray-700",children:["Amount: ",e.jsx("span",{className:"font-bold",children:new Intl.NumberFormat("en-US",{style:"currency",currency:a.currency}).format(a.originalTotal||0)})]})]}),e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{variant:"outline",onClick:()=>V(a),children:"Reject"}),e.jsx(A,{onClick:()=>q(a),children:"Approve"})]})})]})},a.id)))})}),e.jsx(re,{isOpen:F,onClose:()=>I(!1),title:"Reject Transaction",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Please provide a reason for rejecting this transaction. This will be visible to the creator."}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all",rows:4,placeholder:"Enter rejection reason...",value:U,onChange:a=>O(a.target.value)}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx(A,{variant:"outline",onClick:()=>I(!1),children:"Cancel"}),e.jsx(A,{className:"bg-red-600 hover:bg-red-700 text-white",onClick:B,disabled:!U.trim(),children:"Confirm Reject"})]})]})}),e.jsx(re,{isOpen:P,onClose:()=>M(!1),title:"Self-Approval Warning",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-amber-50 border-l-4 border-amber-400 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-amber-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:"text-sm text-amber-700",children:"You are about to approve your own transaction."})})]})}),e.jsx("p",{className:"text-sm text-gray-600",children:"This is generally discouraged except for corrections or specific administrative overrides. Are you sure you want to proceed?"}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx(A,{variant:"outline",onClick:()=>M(!1),children:"Cancel"}),e.jsx(A,{className:"bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>J&&L(J),children:"Proceed & Approve"})]})]})})]}):l==="REQUESTS"?e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>d("LIST"),className:"text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Back to Banking"]})}),e.jsx(fe,{})]}):l==="WALLETS"?e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>d("LIST"),className:"text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Back to Banking"]})}),e.jsx(je,{})]}):l==="TRANSFER"?e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>d("LIST"),className:"text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Back to Banking"]})}),e.jsx(pe,{accounts:g,branches:R,currencies:k,onSave:async a=>{await N(a,"SUBMIT"),d("LIST")},onCancel:()=>d("LIST")})]}):l==="ADD_BANK"?e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>d("LIST"),className:"text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Back to Banking"]})}),e.jsx(xe,{accounts:g,onSubmit:async a=>{await n(a),d("LIST")},onCancel:()=>d("LIST")})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(X,{className:"bg-gradient-to-br from-indigo-600 to-purple-700 text-white border-none",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-indigo-100 text-sm font-medium",children:"Total Cash Position (USD Eq.)"}),e.jsx("div",{className:"text-3xl font-bold mt-1",children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(T)})]}),e.jsx("button",{onClick:W,disabled:h,className:"bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors disabled:opacity-50",title:"Refresh data",children:e.jsx("svg",{className:`w-5 h-5 text-white ${h?"animate-spin":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-2",children:[e.jsxs("div",{className:"text-xs text-indigo-200 bg-white/10 inline-block px-2 py-1 rounded",children:["Updated: ",z.toLocaleTimeString()]}),h&&e.jsx("span",{className:"text-xs text-indigo-200 animate-pulse",children:"Refreshing..."})]})]}),e.jsxs("div",{className:"md:col-span-2 flex items-center justify-end space-x-4",children:[e.jsxs("button",{onClick:()=>d("APPROVALS"),className:"flex flex-col items-center justify-center p-4 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-amber-300 transition-all w-28 h-28 shadow-sm group relative",children:[v>0&&e.jsx("span",{className:"absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse",children:v}),e.jsx("div",{className:"bg-amber-50 p-2 rounded-full mb-2 group-hover:bg-amber-100",children:e.jsx("svg",{className:"w-6 h-6 text-amber-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("span",{className:"text-xs font-medium text-gray-700 group-hover:text-amber-700 text-center",children:"Approvals"})]}),e.jsxs("button",{onClick:()=>d("REQUESTS"),className:"flex flex-col items-center justify-center p-4 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-blue-300 transition-all w-28 h-28 shadow-sm group relative",children:[b>0&&e.jsx("span",{className:"absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse",children:b}),e.jsx("div",{className:"bg-blue-50 p-2 rounded-full mb-2 group-hover:bg-blue-100",children:e.jsx("svg",{className:"w-6 h-6 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})})}),e.jsx("span",{className:"text-xs font-medium text-gray-700 group-hover:text-blue-700 text-center",children:"Requests"})]}),e.jsxs("button",{onClick:()=>d("WALLETS"),className:"flex flex-col items-center justify-center p-4 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-purple-300 transition-all w-28 h-28 shadow-sm group",children:[e.jsx("div",{className:"bg-purple-50 p-2 rounded-full mb-2 group-hover:bg-purple-100",children:e.jsx("svg",{className:"w-6 h-6 text-purple-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})})}),e.jsx("span",{className:"text-xs font-medium text-gray-700 group-hover:text-purple-700 text-center",children:"User Wallets"})]}),e.jsxs("button",{onClick:()=>d("TRANSFER"),className:"flex flex-col items-center justify-center p-4 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-indigo-300 transition-all w-28 h-28 shadow-sm group",children:[e.jsx("div",{className:"bg-indigo-50 p-2 rounded-full mb-2 group-hover:bg-indigo-100",children:e.jsx("svg",{className:"w-6 h-6 text-indigo-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"})})}),e.jsx("span",{className:"text-xs font-medium text-gray-700 group-hover:text-indigo-700",children:"Transfer"})]}),e.jsxs("button",{onClick:()=>d("ADD_BANK"),className:"flex flex-col items-center justify-center p-4 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-green-300 transition-all w-28 h-28 shadow-sm group",children:[e.jsx("div",{className:"bg-green-50 p-2 rounded-full mb-2 group-hover:bg-green-100",children:e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})}),e.jsx("span",{className:"text-xs font-medium text-gray-700 group-hover:text-green-700 text-center",children:"Add Nostro"})]})]})]}),e.jsxs(X,{title:"Company Bank, Cash & Settlement Accounts",children:[["USD","KHR"].map(a=>{const x=j.filter(o=>a==="USD"?!o.currency||o.currency==="USD":o.currency==="KHR");if(x.length===0)return null;const t=x.reduce((o,u)=>o+(u.nativeBalance||0),0),i=S[a];return e.jsxs("div",{className:"mb-4 last:mb-0",children:[e.jsxs("button",{onClick:()=>$(o=>({...o,[a]:!o[a]})),className:`w-full flex items-center justify-between p-3 rounded-lg transition-colors ${a==="USD"?"bg-green-50 hover:bg-green-100":"bg-blue-50 hover:bg-blue-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("svg",{className:`w-4 h-4 transition-transform ${i?"":"rotate-90"} ${a==="USD"?"text-green-600":"text-blue-600"}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5l7 7-7 7"})}),e.jsx("h3",{className:`text-sm font-bold uppercase tracking-wide ${a==="USD"?"text-green-700":"text-blue-700"}`,children:a==="USD"?"$ USD Accounts":"៛ KHR Accounts"}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full ${a==="USD"?"bg-green-200 text-green-800":"bg-blue-200 text-blue-800"}`,children:x.length})]}),e.jsxs("span",{className:`text-base font-bold ${t<0?"text-red-600":a==="USD"?"text-green-700":"text-blue-700"}`,children:[a==="USD"?"$":"៛"," ",t.toLocaleString(void 0,{minimumFractionDigits:a==="USD"?2:0})]})]}),!i&&e.jsx("div",{className:"mt-2 overflow-hidden rounded-lg border border-gray-200",children:e.jsx("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:e.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:x.sort((o,u)=>Math.abs(u.nativeBalance||0)-Math.abs(o.nativeBalance||0)).map(o=>e.jsxs("tr",{className:`hover:bg-gray-50 ${Math.abs(o.nativeBalance||0)<.01?"opacity-50":""}`,children:[e.jsx("td",{className:"px-4 py-3 w-16",children:e.jsx("div",{className:`h-9 w-9 rounded-full flex items-center justify-center ${o.name.toLowerCase().includes("cash")?"bg-emerald-100 text-emerald-600":"bg-indigo-100 text-indigo-600"}`,children:o.name.toLowerCase().includes("cash")?e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"})}):e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})})})}),e.jsxs("td",{className:"px-3 py-3",children:[e.jsx("div",{className:"font-medium text-gray-900",children:o.name}),e.jsx("div",{className:"text-xs text-gray-500 font-mono",children:o.code})]}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("span",{className:`text-base font-bold ${(o.nativeBalance||0)<0?"text-red-600":a==="USD"?"text-green-700":"text-blue-700"}`,children:[a==="USD"?"$":"៛"," ",(o.nativeBalance||0).toLocaleString(void 0,{minimumFractionDigits:a==="USD"?2:0})]})})]},o.id))})})})]},a)}),j.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500 bg-gray-50 rounded-xl border border-dashed border-gray-300",children:"No Nostro / Company Bank accounts found. Add one to get started."})]})]})};function Te(){const{accounts:g,transactions:w,branches:R,currencies:k,refreshData:p,pendingWalletRequests:N}=ce(),{user:n}=de();return e.jsx(be,{accounts:g,transactions:w,branches:R,currencies:k,currentUser:n,onTransactionAction:async(f,l)=>{l==="SUBMIT"?await c.submitForApproval(f,(n==null?void 0:n.uid)||"",(n==null?void 0:n.name)||"Unknown"):l==="APPROVE"?await c.approveJournalEntry(f.id,(n==null?void 0:n.uid)||"",(n==null?void 0:n.name)||"Unknown"):l==="REJECT"&&await c.rejectJournalEntry(f.id,f.rejectionReason||"",(n==null?void 0:n.uid)||"",(n==null?void 0:n.name)||"Unknown"),await p()},onAddAccount:async f=>{await c.addAccount(f),await p()},pendingWalletRequests:N||[]})}export{Te as default};
