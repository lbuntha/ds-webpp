import{u as G,b as J,r as u,q as F,m as z,n as K,w as V,o as q,j as e,p as X}from"./index-BjK2osQV.js";import{C as Z}from"./Card-DROeE3UG.js";import{B}from"./Button-JCYNVMjR.js";import{t as I}from"./toast-DTXa3ATd.js";const ee=[3,5,10,20],se=({src:x,onClose:l})=>x?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 p-4",onClick:l,children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh] w-full h-full flex items-center justify-center",children:[e.jsx("img",{src:x,alt:"Parcel Full View",className:"max-w-full max-h-full object-contain rounded-lg shadow-2xl"}),e.jsx("button",{className:"absolute top-4 right-4 bg-white/20 hover:bg-white/40 text-white rounded-full p-2 backdrop-blur-sm transition-colors",onClick:l,children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}):null,te=(x,l)=>{const f=[];for(let b=0;b<x.length;b+=l)f.push(x.slice(b,b+l));return f},le=()=>{const{t:x}=G(),{user:l}=J(),[f,b]=u.useState(20),[E,M]=u.useState(!1),[L,T]=u.useState(!1),[S,A]=u.useState([]),[O,_]=u.useState(null),[j,m]=u.useState(""),[v,s]=u.useState({}),[U,R]=u.useState({}),[k,N]=u.useState({});u.useEffect(()=>{D()},[f]);const D=async()=>{T(!0);try{const a=["PENDING","CONFIRMED","Picked Up","PICKED_UP","AT_WAREHOUSE","IN_TRANSIT","OUT_FOR_DELIVERY","UPDATED"],p=F(z(K,"parcel_bookings"),V("status","in",a)),C=await q(p),r=Date.now()-f*60*60*1e3;let i={};const o=[];if(C.docs.forEach(n=>{const t=n.data();t.createdAt>r||t.items&&t.items.forEach(h=>{if(["DELIVERED","CANCELLED","RETURN_TO_SENDER"].includes(h.status||""))return;const y=t.senderId||t.senderName;i[y]||(i[y]={senderId:t.senderId||"",senderName:t.senderName,senderPhone:t.senderPhone,items:[]}),i[y].items.push({booking:t,item:h,chatCount:0,messages:[]}),o.push(h.id)})}),o.length>0){const n=te(o,30);await Promise.all(n.map(async t=>{const h=F(z(K,"chat_messages"),V("itemId","in",t)),y=await q(h),g={};y.empty||y.docs.forEach(c=>{const d=c.data();g[d.itemId]||(g[d.itemId]={count:0,messages:[]}),g[d.itemId].messages.push(d),g[d.itemId].count++}),Object.keys(g).forEach(c=>{const d=g[c];d.messages.sort((W,P)=>P.timestamp-W.timestamp),d.lastMsg=d.messages[0]}),N(c=>({...c,...g}))}))}A(Object.values(i))}catch(a){console.error("Error fetching delayed parcels",a),I.error(`Failed to load delayed parcels: ${a.message}`)}finally{T(!1)}},$=u.useMemo(()=>{let a=S.map(r=>{const i=r.items.map(n=>{var h;const t=k[n.item.id];return{...n,chatCount:(t==null?void 0:t.count)||0,lastMessage:t==null?void 0:t.lastMsg,lastMessageTime:(h=t==null?void 0:t.lastMsg)==null?void 0:h.timestamp,messages:(t==null?void 0:t.messages)||[]}}),o=E?i.filter(n=>n.chatCount>0):i;return{...r,items:o}}).filter(r=>r.items.length>0);if(j.trim()){const r=j.toLowerCase();a=a.map(i=>{if((i.senderName||"").toLowerCase().includes(r)||(i.senderPhone||"").toLowerCase().includes(r))return i;const n=i.items.filter(t=>(t.item.receiverName||"").toLowerCase().includes(r)||(t.item.receiverPhone||"").toLowerCase().includes(r)||(t.item.barcode||"").toLowerCase().includes(r));return{...i,items:n}}).filter(i=>i.items.length>0)}a.sort((r,i)=>r.senderName.localeCompare(i.senderName));const p={};a.forEach(r=>{r.items.forEach(i=>{const o=i.item.status||"UNKNOWN";p[o]||(p[o]=[]);let n=p[o].find(t=>t.senderId===r.senderId&&t.senderName===r.senderName);n||(n={...r,items:[]},p[o].push(n)),n.items.push(i)})});const C=Object.entries(p).map(([r,i])=>({status:r,senders:i.sort((o,n)=>o.senderName.localeCompare(n.senderName))})),w=["PENDING","PICKED_UP","AT_WAREHOUSE","IN_TRANSIT","OUT_FOR_DELIVERY","UPDATED","UNKNOWN"];return C.sort((r,i)=>{const o=w.indexOf(r.status),n=w.indexOf(i.status);return o!==-1&&n!==-1?o-n:o!==-1?-1:n!==-1?1:r.status.localeCompare(i.status)}),C},[S,k,E,j]),Y=async(a,p,C)=>{const w=v[a];if(!(!w||!w.trim())){R(r=>({...r,[a]:!0}));try{const r={id:`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,itemId:a,senderId:(l==null?void 0:l.uid)||"warehouse-staff",senderName:(l==null?void 0:l.name)||"Warehouse Staff",text:w.trim(),timestamp:Date.now(),readBy:[(l==null?void 0:l.uid)||"warehouse-staff"]};await X.sendChatMessage(r),N(i=>{var t,h;const o=((t=i[a])==null?void 0:t.messages)||[],n=[r,...o];return{...i,[a]:{count:(((h=i[a])==null?void 0:h.count)||0)+1,lastMsg:r,messages:n}}}),s(i=>({...i,[a]:""})),I.success("Remark sent")}catch(r){console.error(r),I.error("Failed to send remark")}finally{R(r=>({...r,[a]:!1}))}}},Q=(a,p)=>{if(!a.items||a.items.length===0){I.error("No items to export");return}const C=["Date","Barcode","Receiver Name","Receiver Phone","Status","Latest Remark/Reason"],w=a.items.map(c=>{var P,H;const d=(P=k[c.item.id])==null?void 0:P.lastMsg,W=d?`${d.senderName}: ${d.text}`:"";return[new Date(c.booking.createdAt).toLocaleDateString()+" "+new Date(c.booking.createdAt).toLocaleTimeString(),c.item.barcode||((H=c.item.id)==null?void 0:H.slice(-8).toUpperCase())||"",c.item.receiverName,c.item.receiverPhone||"",(c.item.status||"UNKNOWN").replace(/_/g," "),W]}),i="\uFEFF"+[C.join(","),...w.map(c=>c.map(d=>`"${String(d||"").replace(/"/g,'""')}"`).join(","))].join(`
`),o=new Blob([i],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(o),t=(a.senderName||"Sender").replace(/[^a-z0-9]/gi,"_").toLowerCase(),h=p.replace(/[^a-z0-9]/gi,"_").toLowerCase(),y=new Date().toISOString().split("T")[0],g=document.createElement("a");g.href=n,g.download=`delayed_${h}_${t}_${y}.csv`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(n),I.success(`Exported ${a.senderName} list`)};return e.jsxs(Z,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col md:flex-row justify-between items-center gap-4 border-b border-gray-100 pb-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Delayed Chats & Remarks"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Parcels created more than ",f," hours ago. Grouped by Status."]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 items-center justify-between bg-gray-50 p-3 rounded-lg",children:[e.jsx("div",{className:"flex items-center gap-3 w-full md:w-auto",children:e.jsxs("div",{className:"relative w-full md:w-64",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{type:"text",placeholder:"Search Sender/Receiver/Phone...",className:"pl-10 block w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300 rounded-md py-2",value:j,onChange:a=>m(a.target.value)})]})}),e.jsxs("div",{className:"flex items-center gap-3 w-full md:w-auto justify-end",children:[e.jsx("div",{className:"flex items-center space-x-1 bg-white border border-gray-200 p-1 rounded-md",children:ee.map(a=>e.jsxs("button",{onClick:()=>b(a),className:`px-3 py-1 text-sm rounded transition-colors ${f===a?"bg-indigo-50 text-indigo-700 font-bold":"text-gray-500 hover:text-gray-700"}`,children:[a,"h"]},a))}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm text-gray-600 cursor-pointer select-none",children:[e.jsx("input",{type:"checkbox",checked:E,onChange:a=>M(a.target.checked),className:"rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.jsx("span",{children:"With Chats"})]}),e.jsx(B,{variant:"outline",onClick:D,disabled:L,size:"sm",children:L?"Refreshing...":"Refresh"})]})]}),L?e.jsx("div",{className:"text-center py-12 text-gray-400",children:"Loading delayed parcels..."}):$.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:["No delayed parcels found > ",f," hours ",E?"with chats":""," ",j?`matching "${j}"`:"","."]}):e.jsx("div",{className:"space-y-8",children:$.map((a,p)=>e.jsx(ae,{statusGroup:a,handleExportExcel:Q,handleSendChat:Y,chatInputs:v,setChatInputs:s,sendingChat:U,setExpandedImage:_,chatCache:k},p))})]}),O&&e.jsx(se,{src:O,onClose:()=>_(null)})]})},ae=({statusGroup:x,handleExportExcel:l,handleSendChat:f,chatInputs:b,setChatInputs:E,sendingChat:M,setExpandedImage:L,chatCache:T})=>{const[S,A]=u.useState(!0),[O,_]=u.useState({}),j=m=>{_(v=>({...v,[m]:!v[m]}))};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 border-b-2 border-indigo-100 pb-2 cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors select-none",onClick:()=>A(!S),children:[e.jsx("div",{className:`transform transition-transform duration-200 ${S?"-rotate-90":"rotate-0"}`,children:e.jsx("svg",{className:"w-5 h-5 text-gray-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}),e.jsx("h3",{className:`text-lg font-black uppercase tracking-wide px-3 py-1 rounded ${x.status==="AT_WAREHOUSE"?"bg-purple-100 text-purple-800":x.status==="PENDING"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:x.status.replace(/_/g," ")}),e.jsxs("span",{className:"text-gray-400 text-sm font-medium",children:["(",x.senders.reduce((m,v)=>m+v.items.length,0)," Items)"]})]}),!S&&e.jsx("div",{className:"grid grid-cols-1 gap-6 pl-2 md:pl-4 transition-all duration-300",children:x.senders.map((m,v)=>e.jsxs("div",{className:"border border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm",children:[e.jsxs("div",{className:"bg-gray-50 px-4 py-3 flex justify-between items-center border-b border-gray-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm",children:m.senderName.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-800 text-sm md:text-base",children:m.senderName}),e.jsxs("p",{className:"text-xs text-gray-500",children:[m.senderPhone," â€¢ ",m.items.length," Item",m.items.length!==1?"s":""]})]})]}),e.jsxs(B,{size:"sm",variant:"outline",className:"flex items-center gap-1 text-green-700 border-green-200 hover:bg-green-50",onClick:s=>{s.stopPropagation(),l(m,x.status)},children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Export Excel"]})]}),e.jsx("div",{className:"divide-y divide-gray-100",children:m.items.map((s,U)=>{var R,k;return e.jsxs("div",{className:"p-4 hover:bg-gray-50 transition-colors flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"w-16 h-16 flex-shrink-0 bg-gray-200 rounded-lg overflow-hidden cursor-pointer border border-gray-200 hover:border-indigo-300 transition-all",onClick:()=>s.item.image&&L(s.item.image),children:s.item.image?e.jsx("img",{src:s.item.image,alt:"Parcel",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap mb-1",children:[e.jsx("span",{className:"font-mono text-xs bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 border border-gray-200",children:s.item.barcode||"NO_BARCODE"}),e.jsx("span",{className:"text-sm font-bold text-gray-900",children:s.item.receiverName})]}),e.jsxs("div",{className:"text-xs text-gray-500 space-y-0.5",children:[e.jsxs("div",{children:["To: ",s.item.receiverPhone]}),e.jsxs("div",{children:["Loc: ",s.item.destinationAddress]}),e.jsxs("div",{className:"text-gray-400",children:["Created: ",new Date(s.booking.createdAt).toLocaleString()]})]})]})]}),s.lastMessageTime&&e.jsxs("span",{className:"text-xs text-gray-400",children:["Last chat: ",new Date(s.lastMessageTime).toLocaleString()]}),s.messages&&s.messages.length>0?e.jsx("div",{className:"mt-3",children:O[s.item.id]?e.jsxs("div",{className:"bg-gray-50 rounded-lg border border-gray-200 p-2 space-y-2 max-h-60 overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center pb-2 border-b border-gray-200",children:[e.jsxs("span",{className:"text-xs font-bold text-gray-500",children:["History (",s.messages.length,")"]}),e.jsx("button",{onClick:()=>j(s.item.id),className:"text-xs text-indigo-600 hover:text-indigo-800",children:"Hide"})]}),s.messages.map((N,D)=>e.jsxs("div",{className:"bg-white p-2 rounded shadow-sm text-sm",children:[e.jsxs("div",{className:"flex justify-between text-xs text-gray-400 mb-1",children:[e.jsx("span",{className:"font-bold text-gray-600",children:N.senderName}),e.jsx("span",{children:new Date(N.timestamp).toLocaleString()})]}),e.jsx("p",{className:"text-gray-700",children:N.text})]},N.id||D))]}):e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-3 text-sm mt-2 relative group",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"font-bold text-indigo-600 text-xs",children:(R=s.lastMessage)==null?void 0:R.senderName}),e.jsxs("button",{onClick:()=>j(s.item.id),className:"text-xs text-indigo-600 hover:text-indigo-800 underline opacity-0 group-hover:opacity-100 transition-opacity",children:["View History (",s.messages.length,")"]})]}),e.jsx("p",{className:"text-gray-700",children:(k=s.lastMessage)==null?void 0:k.text})]})}):e.jsx("div",{className:"text-xs text-gray-400 italic pl-1 mt-2",children:"No chat history"})]}),e.jsxs("div",{className:"md:w-64 flex-shrink-0 flex flex-col justify-between",children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 mb-1",children:"Warehouse/Driver Remark"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"Reason for delay...",className:"flex-1 text-sm border-gray-300 rounded px-2 py-1 focus:ring-indigo-500 focus:border-indigo-500",value:b[s.item.id]||"",onChange:N=>E(D=>({...D,[s.item.id]:N.target.value})),onKeyDown:N=>{N.key==="Enter"&&f(s.item.id,s.booking.id,s.booking.senderId||"")}}),e.jsx(B,{size:"sm",onClick:()=>f(s.item.id,s.booking.id,s.booking.senderId||""),disabled:!b[s.item.id]||M[s.item.id],className:"w-16",children:M[s.item.id]?"...":"Send"})]})]})]},U)})})]},v))})]})};export{le as D};
