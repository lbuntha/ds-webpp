import{u as ye,j as e,r as l,f as h,A as ct,i as xt}from"./index-BjK2osQV.js";import{createBilingualNotification as fe,formatCodUpdatedByDriverMessage as ut,formatDeliveredMessage as mt,formatReturnedMessage as gt}from"./notificationService-W2xlDV8M.js";import{B as G}from"./Button-JCYNVMjR.js";import{I as ve}from"./ImageUpload-CVnIZI_m.js";import{C as ht}from"./ChatModal-Bzjxc4YC.js";import{S as pt}from"./SettlementReportModal-CGNRTnay.js";import{t as p}from"./toast-DTXa3ATd.js";import{C as be}from"./Card-DROeE3UG.js";import{D as ft}from"./DriverPickupProcessor-1KKXpE5k.js";const Ve=({job:s,type:f,onAction:C,onUnlock:A,onMapClick:u,onChatClick:w,currentDriverId:D})=>{var L;const{t:P}=ye(),E=(s.items||[]).filter(b=>D&&b.driverId&&b.driverId!==D&&b.collectorId!==D?!1:f==="PICKUP"?b.status==="PENDING"||b.status==="AT_WAREHOUSE":!0);if(E.length===0)return null;const $=E[0].status,_=!!s.lockedByDriverId,F=s.lockedByDriverId===D,m=_&&!F,q=b=>b?new Date(b).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",Y=b=>{const g=P(`status_${b}`);return g===`status_${b}`?b:g},M=f==="AVAILABLE";return e.jsx(be,{className:`shadow-sm ${m?"border-l-4 border-l-gray-400 opacity-60":M?"border-l-4 border-l-green-500":"border-l-4 border-l-red-500 shadow-md"}`,children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 overflow-hidden border border-gray-200 relative",children:[(L=E==null?void 0:E[0])!=null&&L.image?e.jsx("img",{src:E[0].image,alt:"Parcel",className:"w-full h-full object-cover"}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),m&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center",children:e.jsx("svg",{className:"w-6 h-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 truncate",children:s.senderName}),e.jsxs("p",{className:"text-[10px] text-gray-500",children:[s.bookingDate," â€¢ ",q(s.createdAt)]}),!M&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.senderPhone}),m&&e.jsxs("p",{className:"text-[10px] text-orange-600 font-medium mt-1",children:["ðŸ”’ Taken by ",s.lockedByDriverName]})]}),M?e.jsx("div",{className:"flex flex-col gap-1",children:m?e.jsx("span",{className:"text-xs px-3 py-1.5 bg-gray-200 text-gray-500 rounded font-bold",children:"Taken"}):e.jsx(G,{onClick:()=>C(s),className:"text-xs px-3 bg-green-600 hover:bg-green-700",children:P("accept_job")})}):e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx("span",{className:`text-[10px] px-2 py-1 rounded font-bold uppercase ${$==="PENDING"?"bg-blue-100 text-blue-800":"bg-red-100 text-red-800"}`,children:f==="PICKUP"&&$==="PENDING"?"ACCEPTED":Y($)}),e.jsx(G,{onClick:()=>C(s),className:"text-xs h-7 py-0 bg-indigo-600 hover:bg-indigo-700",children:P("process_pickup")})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 line-clamp-2",children:s.pickupAddress}),M?e.jsx("div",{className:"mt-2 flex gap-2 items-center",children:e.jsxs("span",{className:"text-[10px] bg-gray-100 px-2 py-1 rounded font-bold text-gray-600",children:[E.length," items"]})}):e.jsxs("div",{className:"mt-3 flex gap-2",children:[s.driverId&&w&&e.jsxs("button",{onClick:()=>w(s),className:"text-xs bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-full flex items-center font-bold border border-indigo-100",children:[e.jsx("svg",{className:"w-3 h-3 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),"Chat"]}),u&&e.jsxs("button",{className:"text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-full flex items-center font-bold border border-gray-200",onClick:()=>u(s.pickupAddress),children:[e.jsxs("svg",{className:"w-3 h-3 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 11a3 3 0 11-6 0 3 3 0 016 0z"})]}),"Map"]}),A&&F&&e.jsxs("button",{onClick:()=>A(s),className:"text-xs bg-orange-50 text-orange-600 px-3 py-1.5 rounded-full flex items-center font-bold border border-orange-200 hover:bg-orange-100",children:[e.jsx("svg",{className:"w-3 h-3 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"})}),"Release Job"]})]})]})]})})},bt=({job:s,onZoomImage:f,onAction:C,onUpdateCod:A,onChatClick:u,hasBranches:w,currentDriverId:D})=>{const{t:P}=ye(),[E,$]=l.useState(null),[_,F]=l.useState(0),[m,q]=l.useState("USD"),[Y,M]=l.useState(!1),L=l.useMemo(()=>(s.items||[]).filter(a=>{const N=a.status==="PICKED_UP"||a.status==="AT_WAREHOUSE"||a.status==="OUT_FOR_DELIVERY"||a.status==="IN_TRANSIT"&&!a.targetBranchId,K=!D||a.driverId===D||a.delivererId===D;return N&&K}),[s.items,D]),b=a=>new Date(a).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),g=a=>{const N=P(`status_${a}`);return N===`status_${a}`?a:N},H=a=>{$(a.id),F(Number(a.productPrice)||0),q(a.codCurrency||(Number(a.productPrice)>=1e3?"KHR":"USD"))},U=async a=>{M(!0),await A(s.id,a,_,m),M(!1),$(null)};L.filter(a=>a.codCurrency!=="KHR").reduce((a,N)=>a+(Number(N.productPrice)||0),0),L.filter(a=>a.codCurrency==="KHR").reduce((a,N)=>a+(Number(N.productPrice)||0),0);const O=s.stockProducts&&s.stockProducts.length>0;if(L.length===0)return null;if(O&&L.length===1){const a=L[0];return e.jsxs(be,{className:"border border-gray-200 shadow-sm relative overflow-hidden",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1 bg-purple-500"}),e.jsx("div",{className:"pl-3 pr-3 pt-3 pb-2 border-b border-gray-100",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-bold",children:["ðŸ“¦ Stock (",s.stockProducts.length,")"]}),e.jsx("span",{className:"text-[10px] text-gray-400",children:s.bookingDate})]}),e.jsx("h4",{className:"font-bold text-gray-900 mt-1",children:a.receiverName}),e.jsx("p",{className:"text-xs text-gray-600",children:a.receiverPhone}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:a.destinationAddress})]}),e.jsx("button",{onClick:()=>u(s.id,a),className:"text-xs text-indigo-600 flex items-center font-medium",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})})]})}),e.jsx("div",{className:"px-3 py-2 max-h-[150px] overflow-y-auto bg-gray-50",children:s.stockProducts.map((N,K)=>e.jsxs("div",{className:"flex items-center gap-2 py-1.5 border-b border-gray-100 last:border-0",children:[N.image&&e.jsx("img",{src:N.image,className:"w-10 h-10 rounded object-cover cursor-pointer",onClick:()=>f(N.image),alt:""}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-medium text-gray-800 truncate",children:N.name||N.sku||`Product ${K+1}`}),e.jsxs("p",{className:"text-[10px] text-gray-500",children:["Qty: ",N.quantity||1]})]}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:"text-xs font-bold text-red-600",children:N.codCurrency==="KHR"?`${(N.unitPrice||0).toLocaleString()}áŸ›`:`$${(N.unitPrice||0).toFixed(2)}`})})]},N.stockItemId||K))}),e.jsxs("div",{className:"px-3 py-2 bg-red-50 border-t border-red-100",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Total COD to Collect:"}),e.jsx("span",{className:"font-bold text-red-700",children:a.codCurrency==="KHR"?`${(a.productPrice||0).toLocaleString()}áŸ›`:`$${(a.productPrice||0).toFixed(2)}`})]}),e.jsxs("div",{className:"flex justify-between items-center text-[10px] text-gray-500 mt-1",children:[e.jsx("span",{children:"Delivery Fee:"}),e.jsxs("span",{children:["$",(s.totalDeliveryFee||0).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex gap-2 p-3",children:[e.jsx("button",{className:"flex-1 bg-green-600 text-white py-2.5 rounded-lg text-sm font-bold shadow-sm hover:bg-green-700",onClick:()=>C(s.id,a.id,"DELIVER"),children:"âœ“ Delivered"}),e.jsx("button",{className:"px-4 bg-white border border-gray-200 text-gray-700 py-2.5 rounded-lg text-xs font-bold hover:bg-gray-50",onClick:()=>C(s.id,a.id,"RETURN"),children:"Return"}),w&&e.jsx("button",{className:"px-4 bg-indigo-50 text-indigo-700 py-2.5 rounded-lg text-xs font-bold border border-indigo-100 hover:bg-indigo-100",onClick:()=>C(s.id,a.id,"TRANSFER"),children:"Hub"})]})]})}return e.jsx("div",{className:"space-y-3",children:L.map(a=>{const N=a.codCurrency!=="KHR"&&a.productPrice>0&&s.exchangeRateForCOD,K=N?a.productPrice*(s.exchangeRateForCOD||4100):0;return e.jsxs(be,{className:"border border-gray-200 shadow-sm relative overflow-hidden",children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-1 bg-blue-500"}),e.jsxs("div",{className:"pl-3 flex gap-4",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 cursor-pointer",onClick:()=>f(a.image),children:e.jsx("img",{src:a.image,className:"w-full h-full object-cover",alt:"Parcel"})}),e.jsxs("div",{className:"flex-1 min-w-0 py-1",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-900 truncate",children:a.receiverName}),e.jsxs("p",{className:"text-[10px] text-gray-500",children:[s.bookingDate," â€¢ ",b(s.createdAt)]})]}),e.jsx("span",{className:`text-[10px] px-2 py-0.5 rounded font-bold uppercase ${a.status==="IN_TRANSIT"?"bg-orange-100 text-orange-800":a.status==="OUT_FOR_DELIVERY"?"bg-purple-100 text-purple-800":"bg-blue-100 text-blue-800"}`,children:g(a.status||"PICKED_UP")})]}),e.jsx("p",{className:"text-xs text-gray-600 mt-1 truncate",children:a.destinationAddress}),e.jsxs("div",{className:"flex items-center gap-4 mt-2",children:[E===a.id?e.jsxs("div",{className:"flex items-center gap-1 bg-white border border-red-200 rounded p-1 shadow-sm animate-fade-in-up",children:[e.jsx("input",{type:"number",className:"w-16 text-sm font-bold text-red-600 border-none focus:ring-0 p-0 text-right bg-transparent",value:_,onChange:W=>{const ee=parseFloat(W.target.value);F(ee),isNaN(ee)||q(ee>=1e3?"KHR":"USD")},autoFocus:!0}),e.jsxs("select",{className:"text-xs border-none focus:ring-0 bg-transparent text-gray-500 font-bold p-0 pr-4",value:m,onChange:W=>q(W.target.value),children:[e.jsx("option",{value:"USD",children:"$"}),e.jsx("option",{value:"KHR",children:"áŸ›"})]}),e.jsx("button",{onClick:()=>U(a.id),className:"text-green-600 hover:text-green-800 bg-green-50 rounded p-1",disabled:Y,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})})}),e.jsx("button",{onClick:()=>$(null),className:"text-gray-400 hover:text-gray-600 p-1",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}):e.jsxs("div",{className:"flex items-center gap-2 group",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-xs font-bold text-red-600",children:["COD: ",a.productPrice?a.codCurrency==="KHR"?`${a.productPrice.toLocaleString()}áŸ›`:`$${a.productPrice}`:"$0.00"]}),N&&e.jsxs("div",{className:"text-[10px] text-gray-500 bg-gray-100 px-1 rounded",children:["or ",K.toLocaleString(),"áŸ› (Rate: ",s.exchangeRateForCOD,")"]}),(()=>{const W=a.deliveryFee??s.totalDeliveryFee/(L.length||1),ee=a.codCurrency||"USD";return W<=0?null:e.jsxs("div",{className:"text-[10px] font-medium text-indigo-600 mt-0.5",children:["Fee: ",ee==="KHR"?`${Math.round(W).toLocaleString()}áŸ›`:`$${W.toFixed(2)}`]})})()]}),e.jsx("button",{onClick:()=>H(a),className:"text-gray-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity",title:"Update Amount",children:e.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})})})]}),e.jsxs("button",{onClick:()=>u(s.id,a),className:"text-xs text-indigo-600 flex items-center font-medium ml-auto",children:[e.jsx("svg",{className:"w-3 h-3 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),"Chat"]})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-3 pl-3",children:[e.jsx("button",{className:"flex-1 bg-green-600 text-white py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-green-700",onClick:()=>C(s.id,a.id,"DELIVER"),children:P("status_DELIVERED")}),e.jsx("button",{className:"flex-1 bg-white border border-gray-200 text-gray-700 py-2 rounded-lg text-xs font-bold hover:bg-gray-50",onClick:()=>C(s.id,a.id,"RETURN"),children:P("status_RETURN_TO_SENDER")}),w&&e.jsx("button",{className:"px-3 bg-indigo-50 text-indigo-700 py-2 rounded-lg text-xs font-bold border border-indigo-100",onClick:()=>C(s.id,a.id,"TRANSFER"),children:"Hub"})]})]},a.id)})})},yt=({action:s,isOpen:f,onConfirm:C,onCancel:A,initialCodAmount:u=0,initialCodCurrency:w="USD"})=>{const[D,P]=l.useState(""),[E,$]=l.useState(u),[_,F]=l.useState(w),[m,q]=l.useState(!1),[Y,M]=l.useState(0),[L,b]=l.useState("USD");if(l.useEffect(()=>{f&&(P(""),$(u),F(w),q(!1),M(0),b("USD"))},[f,u,w]),!f)return null;let g="Start Delivery?",H="Are you sure you want to start delivering this parcel?";s==="DELIVER"?(g=m?"Confirm Taxi Handoff?":"Confirm Delivery?",H=m?"Hand off this parcel to a taxi driver. Enter the taxi fee you're paying.":"Mark this parcel as successfully delivered? Please confirm the COD amount and capture proof."):s==="RETURN"&&(g="Mark as Failed/Returned?",H="Are you sure you want to mark this delivery as failed/returned?");const U=()=>{if(s==="DELIVER"&&!D){p.warning(m?"Photo of taxi handoff is required.":"Proof of Delivery photo is required.");return}if(s==="DELIVER"&&m&&Y<=0){p.warning("Please enter the taxi fee amount.");return}C(D,s==="DELIVER"&&!m?{amount:E,currency:_}:void 0,s==="DELIVER"&&m?{isTaxiDelivery:!0,taxiFee:Y,taxiFeeCurrency:L}:void 0)};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-sm p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-2",children:g}),e.jsx("p",{className:"text-gray-600 mb-4 text-sm",children:H}),s==="DELIVER"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`mb-4 p-3 rounded-lg border ${u>0?"border-red-200 bg-red-50":"border-gray-200 bg-gray-50"}`,children:[e.jsxs("label",{className:`flex items-center gap-3 ${u>0?"cursor-not-allowed opacity-60":"cursor-pointer"}`,children:[e.jsx("input",{type:"checkbox",checked:m,onChange:O=>{if(u>0){p.warning("COD must be $0 before enabling taxi delivery. Update the COD amount first.");return}q(O.target.checked)},disabled:u>0,className:"w-5 h-5 text-orange-600 rounded focus:ring-orange-500 disabled:opacity-50"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-900",children:"ðŸš• Deliver via Taxi"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Hand off to taxi driver (no COD collection)"})]})]}),u>0&&e.jsxs("div",{className:"mt-2 text-xs text-red-600 font-medium bg-red-100 px-2 py-1 rounded",children:["âš ï¸ COD is ",w==="KHR"?`${u.toLocaleString()} áŸ›`:`$${u}`,". Update to $0 to enable taxi delivery."]})]}),m&&e.jsxs("div",{className:"mb-4 bg-orange-50 p-3 rounded-lg border border-orange-200",children:[e.jsx("label",{className:"block text-xs font-bold text-orange-700 mb-2",children:"Taxi Fee (You Pay)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",step:"0.01",className:"w-full border border-orange-300 rounded-lg px-3 py-2 text-lg font-bold text-orange-700 focus:ring-orange-500 focus:border-orange-500",value:Y||"",placeholder:"0.00",onChange:O=>{const a=parseFloat(O.target.value)||0;M(a),a>=1e3?b("KHR"):a>0&&b("USD")}}),e.jsxs("select",{className:"bg-white border border-orange-300 rounded-lg px-3 py-2 text-sm font-medium focus:ring-orange-500 focus:border-orange-500",value:L,onChange:O=>b(O.target.value),children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"KHR",children:"KHR"})]})]}),e.jsx("p",{className:"text-xs text-orange-600 mt-2 italic",children:"You pay the taxi now. Company will reimburse you."})]}),!m&&e.jsxs("div",{className:"mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-xs font-bold text-gray-600 mb-2",children:"Confirm Collected Amount"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",step:"0.01",className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-lg font-bold text-green-700 focus:ring-green-500 focus:border-green-500",value:E,onChange:O=>{const a=parseFloat(O.target.value);$(a),isNaN(a)||F(a>=1e3?"KHR":"USD")}}),e.jsxs("select",{className:"bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium focus:ring-green-500 focus:border-green-500",value:_,onChange:O=>F(O.target.value),children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"KHR",children:"KHR"})]})]})]})]}),s==="DELIVER"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:m?"Photo of Taxi Handoff (Required)":"Proof of Delivery (Required)"}),e.jsx(ve,{value:D,onChange:P})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(G,{variant:"outline",onClick:A,className:"w-full justify-center",children:"Cancel"}),e.jsx(G,{onClick:U,className:`w-full justify-center ${m?"bg-orange-600 hover:bg-orange-700":"bg-indigo-600 hover:bg-indigo-700"}`,children:m?"ðŸš• Confirm Handoff":"Confirm"})]})]})})},vt=({isOpen:s,branches:f,onConfirm:C,onCancel:A})=>{var D;const[u,w]=l.useState(((D=f[0])==null?void 0:D.id)||"");return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-sm p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-4",children:"Transfer to Branch"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Destination Hub"}),e.jsx("select",{className:"w-full border border-gray-300 rounded-lg px-3 py-2",value:u,onChange:P=>w(P.target.value),children:f.map(P=>e.jsx("option",{value:P.id,children:P.name},P.id))})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(G,{variant:"outline",onClick:A,className:"w-full justify-center",children:"Cancel"}),e.jsx(G,{onClick:()=>C(u),className:"w-full justify-center bg-indigo-600 hover:bg-indigo-700",children:"Confirm Transfer"})]})]})}):null},Nt=({isOpen:s,itemCount:f,initialCodAmount:C,initialCodCurrency:A,onConfirm:u,onCancel:w})=>{const[D,P]=l.useState(""),[E,$]=l.useState(C),[_,F]=l.useState(A),[m,q]=l.useState(!1),[Y,M]=l.useState(0),[L,b]=l.useState("USD");if(!s)return null;const g=()=>{if(!D){p.warning(m?"Photo of taxi handoff is required.":"Proof of Delivery photo is required.");return}if(m&&Y<=0){p.warning("Please enter the taxi fee amount.");return}u(D,m?void 0:{amount:E,currency:_},m?{isTaxiDelivery:!0,taxiFee:Y,taxiFeeCurrency:L}:void 0)};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 max-h-[90vh] overflow-y-auto",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 mb-2",children:m?"ðŸš• Confirm Taxi Handoff":"Confirm Stock Delivery"}),e.jsxs("p",{className:"text-gray-600 mb-4 text-sm",children:["Mark all ",f," items as delivered."]}),e.jsxs("div",{className:`mb-4 p-3 rounded-lg border ${C>0?"border-red-200 bg-red-50":"border-gray-200 bg-gray-50"}`,children:[e.jsxs("label",{className:`flex items-center gap-3 ${C>0?"cursor-not-allowed opacity-60":"cursor-pointer"}`,children:[e.jsx("input",{type:"checkbox",checked:m,onChange:H=>{if(E>0){p.warning("COD must be $0 before enabling taxi delivery.");return}q(H.target.checked)},disabled:E>0,className:"w-5 h-5 text-orange-600 rounded focus:ring-orange-500 disabled:opacity-50"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-900",children:"ðŸš• Deliver via Taxi"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Hand off to taxi driver (no COD collection)"})]})]}),E>0&&e.jsxs("div",{className:"mt-2 text-xs text-red-600 font-medium bg-red-100 px-2 py-1 rounded",children:["âš ï¸ Total COD is ",_==="KHR"?`${E.toLocaleString()} áŸ›`:`$${E}`,". Update to $0 to enable taxi."]})]}),m&&e.jsxs("div",{className:"mb-4 bg-orange-50 p-3 rounded-lg border border-orange-200",children:[e.jsx("label",{className:"block text-xs font-bold text-orange-700 mb-2",children:"Taxi Fee (You Pay)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",step:"0.01",className:"w-full border border-orange-300 rounded-lg px-3 py-2 text-lg font-bold text-orange-700",value:Y||"",placeholder:"0.00",onChange:H=>{const U=parseFloat(H.target.value)||0;M(U),U>=1e3?b("KHR"):U>0&&b("USD")}}),e.jsxs("select",{className:"bg-white border border-orange-300 rounded-lg px-3 py-2 text-sm font-medium",value:L,onChange:H=>b(H.target.value),children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"KHR",children:"KHR"})]})]}),e.jsx("p",{className:"text-xs text-orange-600 mt-2 italic",children:"You pay the taxi now. Company will reimburse you."})]}),!m&&e.jsxs("div",{className:"mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200",children:[e.jsx("label",{className:"block text-xs font-bold text-gray-600 mb-2",children:"Total COD Collected"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",step:"0.01",className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-lg font-bold text-green-700",value:E,onChange:H=>{const U=parseFloat(H.target.value);$(U),isNaN(U)||F(U>=1e3?"KHR":"USD")}}),e.jsxs("select",{className:"bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium",value:_,onChange:H=>F(H.target.value),children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"KHR",children:"KHR"})]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:m?"Photo of Taxi Handoff (Required)":"Proof of Delivery (Required)"}),e.jsx(ve,{value:D,onChange:P})]}),e.jsxs("div",{className:"flex space-x-3 mt-4",children:[e.jsx(G,{variant:"outline",onClick:w,className:"w-full justify-center",children:"Cancel"}),e.jsx(G,{onClick:g,className:`w-full justify-center ${m?"bg-orange-600 hover:bg-orange-700":"bg-green-600 hover:bg-green-700"}`,children:m?"ðŸš• Confirm Handoff":`Deliver All (${f})`})]})]})})},Tt=({user:s})=>{var Ke,Ae,$e,_e,Me,Oe;const{t:f}=ye(),[C,A]=l.useState("MY_PICKUPS"),[u,w]=l.useState([]),[D,P]=l.useState([]),[E,$]=l.useState([]),[_,F]=l.useState(!0),[m,q]=l.useState(!1),[Y,M]=l.useState(!1),[L,b]=l.useState(null),[g,H]=l.useState(null),[U,O]=l.useState(null),[a,N]=l.useState(null),[K,W]=l.useState(null),[ee,Ne]=l.useState(null),[re,je]=l.useState(null),[ke,Se]=l.useState(null),[qe,ie]=l.useState(!1),[oe,Ce]=l.useState(""),[de,we]=l.useState(""),[ce,De]=l.useState(""),[xe,Re]=l.useState(""),[ne,Ie]=l.useState(""),[Ye,Ee]=l.useState(""),[ue,We]=l.useState([]),[ae,ze]=l.useState({}),[Te,Ue]=l.useState([]),[Pe,Je]=l.useState([]),[Ge,Qe]=l.useState([]),[Ze,Xe]=l.useState([]),[et,Le]=l.useState(!1),He=async()=>{F(!0);try{const[t,r,n,i,d,j,T,c,x]=await Promise.all([h.getDriverJobs(s.uid),h.getBranches(),h.getEmployees(),h.getAccounts(),h.getWalletTransactions(s.uid),h.getSettings(),h.getCurrencies(),h.getParcelServices(),h.logisticsService.getDriverCommissionRules()]);ze(j),$(c),Je(T),Qe(x),Xe(n);const S=n.find(V=>V.linkedUserId===s.uid&&V.isDriver);if(S)if(q(!0),S.status==="INACTIVE")M(!0);else{w(t),P(r),Ue(d.filter(v=>v.type==="SETTLEMENT").sort((v,o)=>o.id.localeCompare(v.id)));const V=i.filter(v=>v.type===ct.ASSET&&(v.subType===xt.CURRENT_ASSET||(v.name||"").toLowerCase().includes("bank")||(v.name||"").toLowerCase().includes("cash"))&&!v.isHeader);We(V)}else q(!1)}catch(t){console.error(t)}finally{F(!1)}},te=async()=>{try{const[t,r]=await Promise.all([h.getDriverJobs(s.uid),h.getWalletTransactions(s.uid)]);w(t),Ue(r.filter(n=>n.type==="SETTLEMENT").sort((n,i)=>i.id.localeCompare(n.id)))}catch(t){console.error("Error refreshing jobs:",t)}};l.useEffect(()=>{He()},[s]);const me=u.filter(t=>!t.driverId&&t.status==="PENDING"),ge=u.filter(t=>{var i;return!(t.driverId===s.uid||((i=t.involvedDriverIds)==null?void 0:i.includes(s.uid)))||t.status==="CANCELLED"?!1:(t.items||[]).some(d=>(d.status==="PENDING"||d.status==="AT_WAREHOUSE")&&(!d.driverId||d.driverId===s.uid||d.collectorId===s.uid))}),he=u.map(t=>({...t,activeItems:(t.items||[]).filter(r=>(r.driverId===s.uid||r.delivererId===s.uid)&&(r.status==="PICKED_UP"||r.status==="AT_WAREHOUSE"||r.status==="OUT_FOR_DELIVERY"||r.status==="IN_TRANSIT"&&!r.targetBranchId))})).filter(t=>t.activeItems.length>0),tt=he.reduce((t,r)=>r.activeItems.some(i=>i.stockItemId)?t+1:t+r.activeItems.length,0),pe=u.flatMap(t=>(t.items||[]).map(r=>({...r,bookingId:t.id,senderName:t.senderName}))).filter(t=>t.driverId===s.uid&&t.status==="IN_TRANSIT"&&t.targetBranchId),se=u.flatMap(t=>(t.items||[]).map(r=>({...r,bookingId:t.id,sender:t.senderName}))).filter(t=>t.driverId===s.uid&&t.status==="DELIVERED"&&(!t.driverSettlementStatus||t.driverSettlementStatus==="UNSETTLED")),R=l.useMemo(()=>{let t=0,r=0,n=0,i=0;return se.forEach(d=>{const j=Number(d.productPrice)||0;j>0&&(d.codCurrency==="KHR"?r+=j:t+=j),d.isTaxiDelivery&&d.taxiFee&&d.taxiFee>0&&!d.taxiFeeReimbursed&&(d.taxiFeeCurrency==="KHR"?i+=d.taxiFee:n+=d.taxiFee)}),{cod:{usd:t,khr:r},taxi:{usd:n,khr:i},net:{usd:t-n,khr:r-i}}},[se]),z=R.net,Q=ue.find(t=>t.id===(ae.defaultDriverSettlementBankIdUSD||ae.defaultDriverSettlementBankId)),Z=ue.find(t=>t.id===(ae.defaultDriverSettlementBankIdKHR||ae.defaultDriverSettlementBankId)),y=l.useMemo(()=>{const t=Pe.find(k=>k.code==="KHR"),r=t?t.exchangeRate:4e3,n=z.usd,i=z.khr,d=n+i/r,j=Number(oe)||0,T=Number(de)||0,c=Number(ce)||0,x=Number(xe)||0,S=j+c+(T+x)/r,V=S-d,v=Math.abs(V)<.05,o=d<-.01;return{totalDebtBase:d,totalProvidedBase:S,difference:V,isBalanced:v,isCreditBalance:o,bankUSD:j,bankKHR:T,cashUSD:c,cashKHR:x,exchangeRate:r}},[z,oe,de,ce,xe,Pe]),Be=async(t,r,n,i,d,j,T)=>{const c=u.find(o=>o.id===t);if(!c)return;const x=(c.items||[]).map(o=>{if(o.id===r){if(n==="TRANSIT")return{...o,status:"IN_TRANSIT"};if(n==="DELIVER"){const k={...o,status:"DELIVERED",driverSettlementStatus:"UNSETTLED",proofOfDelivery:d,delivererId:s.uid,delivererName:s.name,targetBranchId:null};return T!=null&&T.isTaxiDelivery&&(k.isTaxiDelivery=!0,k.taxiFee=T.taxiFee,k.taxiFeeCurrency=T.taxiFeeCurrency),j&&(k.productPrice=j.amount,k.codCurrency=j.currency),k}if(n==="TRANSFER")return{...o,status:"IN_TRANSIT",targetBranchId:i,driverId:s.uid,driverName:s.name};if(n==="OUT_FOR_DELIVERY")return{...o,status:"OUT_FOR_DELIVERY"};if(n==="RETURN")return{...o,status:"RETURN_TO_SENDER"}}return o}),V=x.every(o=>o.status==="DELIVERED"||o.status==="RETURN_TO_SENDER")?"COMPLETED":c.status;let v={...c,items:x,status:V};if(n==="DELIVER"&&j){const o=x.find(k=>k.id===r);if(o){const k=j.currency,J=k==="KHR"?o.deliveryFeeKHR||o.deliveryFee||0:o.deliveryFeeUSD||o.deliveryFee||0;v.items=v.items.map(B=>B.id===r?{...B,deliveryFee:J,codCurrency:k}:B),v.totalDeliveryFee=v.items.reduce((B,X)=>B+(X.deliveryFee||0),0),v.currency=k}}w(o=>o.map(k=>k.id===t?v:k)),n==="DELIVER"?p.success("Marked as delivered!"):n==="RETURN"?p.success("Marked as returned!"):n==="TRANSIT"?p.success("Status updated!"):n==="OUT_FOR_DELIVERY"&&p.success("Out for delivery!"),(async()=>{var o,k;try{if(await h.saveParcelBooking(v),n==="DELIVER"&&c.senderId){const J=await h.getUserUidByCustomerId(c.senderId);if(J){const B=((o=c.items.find(le=>le.id===r))==null?void 0:o.receiverName)||"",X=fe("PARCEL_DELIVERED",J,mt(B),{type:"BOOKING",bookingId:c.id});X.type="SUCCESS",await h.sendNotification(X)}}if(n==="RETURN"&&c.senderId){const J=await h.getUserUidByCustomerId(c.senderId);if(J){const B=((k=c.items.find(le=>le.id===r))==null?void 0:k.receiverName)||"",X=fe("PARCEL_RETURNED",J,gt(B),{type:"BOOKING",bookingId:c.id});X.type="WARNING",await h.sendNotification(X)}}}catch(J){console.error("Background sync error:",J),te()}})()},st=async(t,r,n,i)=>{const d=u.find(x=>x.id===t);if(!d)return;const j=(d.items||[]).map(x=>{if(x.id!==r)return x;const S=i==="KHR"?x.deliveryFeeKHR||x.deliveryFee||0:x.deliveryFeeUSD||x.deliveryFee||0;return{...x,productPrice:n,codCurrency:i,deliveryFee:S}}),T=j.reduce((x,S)=>x+(S.deliveryFee||0),0),c={...d,items:j,totalDeliveryFee:T};w(x=>x.map(S=>S.id===t?c:S)),p.success("COD updated!"),(async()=>{try{if(await h.saveParcelBooking(c),d.senderId){const x=await h.getUserUidByCustomerId(d.senderId);if(x){const S=j.find(o=>o.id===r),V=i==="KHR"?`${n.toLocaleString()}áŸ›`:`$${n.toFixed(2)}`,v=fe("COD_UPDATED_BY_DRIVER",x,ut((S==null?void 0:S.receiverName)||"",V),{type:"BOOKING",bookingId:d.id});await h.sendNotification(v)}}}catch(x){console.error("Background sync error:",x),te()}})()},rt=async(t,r,n,i,d,j)=>{const T=u.find(o=>o.id===t);if(!T)return;const c=r.length,x=d?d.amount/c:0,S=(T.items||[]).map(o=>{if(r.includes(o.id)){if(n==="DELIVER")return{...o,status:"DELIVERED",driverSettlementStatus:"UNSETTLED",delivererId:s.uid,delivererName:s.name,targetBranchId:null,proofOfDelivery:i,...d?{productPrice:x,codCurrency:d.currency}:{},...j&&o.id===r[0]?{isTaxiDelivery:!0,taxiFee:j.taxiFee,taxiFeeCurrency:j.taxiFeeCurrency}:{}};if(n==="RETURN")return{...o,status:"RETURN_TO_SENDER"}}return o}),V=S.every(o=>o.status==="DELIVERED"||o.status==="RETURN_TO_SENDER"),v={...T,items:S,status:V?"COMPLETED":T.status};w(o=>o.map(k=>k.id===t?v:k)),p.success(n==="DELIVER"?`${r.length} items delivered!`:`${r.length} items returned!`),(async()=>{try{await h.saveParcelBooking(v)}catch(o){console.error("Background sync error:",o),te()}})()},at=async()=>{if(se.length===0)return;const{bankUSD:t,bankKHR:r,cashUSD:n,cashKHR:i}=y,d=t+n,j=r+i,T=R.cod.usd,c=R.cod.khr;if(d>0&&T<=.01)return p.error("Strict Currency Rule: You cannot settle in USD because you only owe KHR. Please pay in KHR.");if(j>0&&c<=100)return p.error("Strict Currency Rule: You cannot settle in KHR because you only owe USD. Please pay in USD.");if(t>0&&!Q)return p.error("System Error: No default USD settlement bank configured.");if(r>0&&!Z)return p.error("System Error: No default KHR settlement bank configured.");const x=ae.defaultDriverCashAccountIdUSD,S=ae.defaultDriverCashAccountIdKHR;if(n>0&&!x)return p.error("System Error: No default USD cash account configured.");if(i>0&&!S)return p.error("System Error: No default KHR cash account configured.");if((t>0||r>0)&&!ne){p.warning("Please upload proof of transfer for bank portions.");return}Le(!0);try{const v=se.filter(I=>(I.codCurrency||"USD").toUpperCase()==="USD").map(I=>({bookingId:I.bookingId,itemId:I.id})),o=se.filter(I=>(I.codCurrency||"USD").toUpperCase()==="KHR").map(I=>({bookingId:I.bookingId,itemId:I.id})),k=t>0?"BANK":n>0?"CASH":null,J=r>0?"BANK":i>0?"CASH":null,B=[];t>0&&B.push(h.requestSettlement(s.uid,s.name,t,"USD",Q.id,ne||"","Settlement (Bank USD)",k==="BANK"?v:[])),r>0&&B.push(h.requestSettlement(s.uid,s.name,r,"KHR",Z.id,ne||"","Settlement (Bank KHR)",J==="BANK"?o:[])),n>0&&B.push(h.requestSettlement(s.uid,s.name,n,"USD",x,"","Settlement (Cash USD)",k==="CASH"?v:[])),i>0&&B.push(h.requestSettlement(s.uid,s.name,i,"KHR",S,"","Settlement (Cash KHR)",J==="CASH"?o:[]));const X=se.filter(I=>I.isTaxiDelivery&&(I.taxiFeeCurrency||"USD")!=="KHR"),le=se.filter(I=>I.isTaxiDelivery&&I.taxiFeeCurrency==="KHR");if(R.taxi.usd>0&&B.push(h.requestSettlement(s.uid,s.name,R.taxi.usd,"USD",(Q==null?void 0:Q.id)||"system","","Taxi Fee Reimbursement (USD)",X.map(I=>({bookingId:I.bookingId,itemId:I.id})))),R.taxi.khr>0&&B.push(h.requestSettlement(s.uid,s.name,R.taxi.khr,"KHR",(Z==null?void 0:Z.id)||"system","","Taxi Fee Reimbursement (KHR)",le.map(I=>({bookingId:I.bookingId,itemId:I.id})))),B.length>0){await Promise.all(B);const I=(t>0?1:0)+(r>0?1:0)+(n>0?1:0)+(i>0?1:0),dt=(R.taxi.usd>0?1:0)+(R.taxi.khr>0?1:0);p.success(`Settlement requested! (${I} COD + ${dt} Taxi = ${B.length} transactions)`),ie(!1),Ie(""),Ce(""),we(""),De(""),Re(""),Ee(""),te()}else p.info("No amounts to settle."),ie(!1),te()}catch{p.error("Failed to submit settlement request.")}finally{Le(!1)}},nt=async()=>{if(K){if(K.lockedByDriverId&&K.lockedByDriverId!==s.uid){p.error(`This job is already taken by ${K.lockedByDriverName||"another driver"}.`),W(null),await te();return}try{const t={...K,driverId:s.uid,driverName:s.name,status:"CONFIRMED",statusId:"ps-pickup",lockedByDriverId:s.uid,lockedByDriverName:s.name,lockedAt:Date.now()};w(r=>r.map(n=>n.id===K.id?t:n)),W(null),A("MY_PICKUPS"),p.success("Job accepted!"),await h.saveParcelBooking(t)}catch(t){console.error(t),await te(),p.error("Failed to accept job. Please try again.")}}},lt=async t=>{if(t.lockedByDriverId!==s.uid){p.error("You can only release jobs you have accepted.");return}try{w(n=>n.filter(i=>i.id!==t.id)),p.success("Job released. Other drivers can now accept it.");const r={...t,driverId:void 0,driverName:void 0,status:"PENDING",statusId:"ps-pending",lockedByDriverId:void 0,lockedByDriverName:void 0,lockedAt:void 0};await h.saveParcelBooking(r)}catch(r){console.error(r),w(n=>[...n,t]),p.error("Failed to release job.")}},Fe=async(t,r)=>{let n;const i=u.find(d=>d.id===t);i!=null&&i.senderId&&(n=await h.getUserUidByCustomerId(i.senderId)),je({itemId:r.id,bookingId:t,itemName:r.receiverName,customerName:(i==null?void 0:i.senderName)||"Customer",customerUid:n})},it=t=>{const r=f(`status_${t}`);return r===`status_${t}`?t:r},ot=t=>{const r=it(t);switch(t){case"PENDING":return e.jsx("span",{className:"text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded text-xs font-bold",children:r});case"OUT_FOR_DELIVERY":return e.jsx("span",{className:"text-purple-600 bg-purple-100 px-2 py-0.5 rounded text-xs font-bold",children:r});case"APPROVED":return e.jsx("span",{className:"text-green-600 bg-green-100 px-2 py-0.5 rounded text-xs font-bold",children:r});case"REJECTED":return e.jsx("span",{className:"text-red-600 bg-red-100 px-2 py-0.5 rounded text-xs font-bold",children:r});default:return e.jsx("span",{className:"text-gray-600 bg-gray-100 px-2 py-0.5 rounded text-xs font-bold",children:r})}};return _?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[50vh] text-gray-500",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-gray-200 border-t-red-600 rounded-full animate-spin mb-4"}),e.jsx("p",{children:"Loading Dashboard..."})]}):m?Y?e.jsxs("div",{className:"text-center py-10 bg-red-50 text-red-800 rounded-xl m-4 border border-red-200",children:[e.jsx("h3",{className:"font-bold text-lg",children:"Account Deactivated"}),e.jsx("p",{className:"text-sm mt-2",children:"Please contact support."})]}):L?e.jsx(ft,{job:L,user:s,services:E,onSave:async t=>{b(t),w(r=>r.map(n=>n.id===t.id?t:n)),h.saveParcelBooking(t).catch(r=>{console.error("Background save error:",r)})},onFinish:async()=>{b(null),A("MY_PARCELS"),p.success("Pickup complete!")},onCancel:()=>{b(null)}}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center px-1",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-800",children:"Driver Dashboard"}),e.jsx(G,{variant:"outline",onClick:He,isLoading:_,className:"py-1 px-3 h-8 text-xs",children:f("refresh")})]}),e.jsx("div",{className:"flex space-x-1 bg-white p-1 rounded-xl shadow-sm border border-gray-100 overflow-x-auto",children:[{id:"MY_PICKUPS",label:`Pickups (${ge.length})`},{id:"MY_PARCELS",label:`Deliveries (${tt})`},{id:"WAREHOUSE",label:`Hub (${pe.length})`},{id:"AVAILABLE",label:`New (${me.length})`},{id:"SETTLEMENT",label:"Wallet"}].map(t=>e.jsx("button",{onClick:()=>A(t.id),className:`flex-1 px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap ${C===t.id?"bg-red-50 text-red-700":"text-gray-500"}`,children:t.label},t.id))}),C==="AVAILABLE"&&e.jsxs("div",{className:"space-y-4 animate-fade-in-up",children:[me.map(t=>e.jsx(Ve,{job:t,type:"AVAILABLE",onAction:W,currentDriverId:s.uid},t.id)),me.length===0&&e.jsx("p",{className:"text-center text-gray-400 py-10",children:"No new jobs available."})]}),C==="MY_PICKUPS"&&e.jsxs("div",{className:"space-y-4 animate-fade-in-up",children:[ge.map(t=>e.jsx(Ve,{job:t,type:"PICKUP",currentDriverId:s.uid,onAction:b,onUnlock:lt,onMapClick:r=>window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r)}`,"_blank"),onChatClick:r=>Fe(r.id,(r.items||[])[0])},t.id)),ge.length===0&&e.jsx("p",{className:"text-center text-gray-400 py-10",children:"No pending pickups."})]}),C==="MY_PARCELS"&&e.jsxs("div",{className:"space-y-4 animate-fade-in-up",children:[he.map(t=>e.jsx(bt,{job:t,currentDriverId:s.uid,onZoomImage:Ne,onUpdateCod:st,onChatClick:(r,n)=>Fe(r,n),hasBranches:D.length>0,onAction:(r,n,i)=>{i==="TRANSFER"?N({isOpen:!0,bookingId:r,itemId:n}):H({isOpen:!0,bookingId:r,itemId:n,action:i})}},t.id)),he.length===0&&e.jsx("p",{className:"text-center text-gray-400 py-10",children:"No active parcels to deliver."})]}),C==="WAREHOUSE"&&e.jsx("div",{className:"space-y-4 animate-fade-in-up",children:pe.length>0?pe.map((t,r)=>{var n;return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl p-3 shadow-sm opacity-80 flex items-center gap-3",children:[e.jsx("img",{src:t.image,className:"w-12 h-12 rounded-lg object-cover bg-gray-100",alt:"Parcel"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h4",{className:"font-bold text-sm text-gray-800",children:t.receiverName}),e.jsx("span",{className:"text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold uppercase animate-pulse",children:"Confirming..."})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["To: ",((n=D.find(i=>i.id===t.targetBranchId))==null?void 0:n.name)||"Hub"]})]})]},r)}):e.jsx("div",{className:"text-center py-10 text-gray-500",children:"No items waiting for hub confirmation."})}),C==="SETTLEMENT"&&e.jsxs("div",{className:"space-y-6 animate-fade-in-up",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"rounded-xl p-4 bg-gradient-to-br from-red-600 to-rose-700 text-white shadow-lg",children:[e.jsx("h3",{className:"text-xs font-medium text-white/80 uppercase tracking-wide mb-1",children:"ðŸ’° COD Collection"}),e.jsx("p",{className:"text-[10px] text-white/60 mb-3",children:"You owe this to the company"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-white/80",children:"USD:"}),e.jsxs("span",{className:"text-xl font-bold",children:["$",R.cod.usd.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-white/80",children:"KHR:"}),e.jsxs("span",{className:"text-xl font-bold",children:[R.cod.khr.toLocaleString()," áŸ›"]})]})]})]}),e.jsxs("div",{className:"rounded-xl p-4 bg-gradient-to-br from-emerald-600 to-teal-700 text-white shadow-lg",children:[e.jsx("h3",{className:"text-xs font-medium text-white/80 uppercase tracking-wide mb-1",children:"ðŸš• Taxi Reimbursement"}),e.jsx("p",{className:"text-[10px] text-white/60 mb-3",children:"Company owes you this"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-white/80",children:"USD:"}),e.jsxs("span",{className:"text-xl font-bold",children:["$",R.taxi.usd.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-white/80",children:"KHR:"}),e.jsxs("span",{className:"text-xl font-bold",children:[R.taxi.khr.toLocaleString()," áŸ›"]})]})]})]})]}),e.jsx("div",{className:`rounded-xl p-4 border-2 ${z.usd>=0&&z.khr>=0?"border-red-200 bg-red-50":"border-green-200 bg-green-50"}`,children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-gray-600 uppercase",children:"Net Settlement"}),e.jsx("p",{className:"text-[10px] text-gray-500",children:z.usd>=0&&z.khr>=0?"Amount you pay to company":"Amount company pays you"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("span",{className:`text-2xl font-bold ${z.usd>=0&&z.khr>=0?"text-red-700":"text-green-700"}`,children:["$",Math.abs(z.usd).toFixed(2)]}),Math.abs(z.khr)>0&&e.jsxs("span",{className:"text-sm text-gray-600 ml-2",children:["+ ",Math.abs(z.khr).toLocaleString()," áŸ›"]})]})]})}),e.jsx("button",{onClick:()=>ie(!0),className:"w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition-colors",children:f("request_settlement")}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-bold text-gray-800",children:f("settlement_history")}),Te.length>0?Te.map(t=>e.jsxs("div",{onClick:()=>Se(t),className:"bg-white border border-gray-200 rounded-xl p-3 shadow-sm cursor-pointer hover:border-indigo-300 transition-colors",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:t.date}),ot(t.status)]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.description||"Settlement"}),e.jsxs("span",{className:"text-sm font-bold text-gray-900",children:[t.amount.toLocaleString()," ",t.currency]})]}),e.jsx("p",{className:"text-[10px] text-indigo-500 mt-1",children:"Tap to view details"})]},t.id)):e.jsx("p",{className:"text-center text-gray-400 text-xs py-4",children:"No settlement history."})]})]}),ke&&e.jsx(pt,{transaction:ke,onClose:()=>Se(null),accounts:ue,employees:Ze,commissionRules:Ge,bookings:u}),e.jsx(yt,{isOpen:!!g,action:(g==null?void 0:g.action)||"DELIVER",initialCodAmount:(($e=(Ae=(Ke=u.find(t=>t.id===(g==null?void 0:g.bookingId)))==null?void 0:Ke.items)==null?void 0:Ae.find(t=>t.id===(g==null?void 0:g.itemId)))==null?void 0:$e.productPrice)||0,initialCodCurrency:((Oe=(Me=(_e=u.find(t=>t.id===(g==null?void 0:g.bookingId)))==null?void 0:_e.items)==null?void 0:Me.find(t=>t.id===(g==null?void 0:g.itemId)))==null?void 0:Oe.codCurrency)||"USD",onCancel:()=>H(null),onConfirm:(t,r,n)=>{g&&Be(g.bookingId,g.itemId,g.action,void 0,t,r,n),H(null)}}),(U==null?void 0:U.isOpen)&&(()=>{var T;const t=u.find(c=>c.id===U.bookingId),r=((T=t==null?void 0:t.items)==null?void 0:T.filter(c=>U.itemIds.includes(c.id)))||[],n=r.filter(c=>c.codCurrency!=="KHR").reduce((c,x)=>c+(Number(x.productPrice)||0),0),i=r.filter(c=>c.codCurrency==="KHR").reduce((c,x)=>c+(Number(x.productPrice)||0),0),d=i>n*4100?"KHR":"USD",j=d==="KHR"?i:n;return e.jsx(Nt,{isOpen:!0,itemCount:U.itemIds.length,initialCodAmount:j,initialCodCurrency:d,onCancel:()=>O(null),onConfirm:(c,x,S)=>{rt(U.bookingId,U.itemIds,U.action,c,x,S),O(null)}})})(),e.jsx(vt,{isOpen:!!a,branches:D,onCancel:()=>N(null),onConfirm:t=>{a&&Be(a.bookingId,a.itemId,"TRANSFER",t),N(null)}}),K&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-sm",children:[e.jsxs("h3",{className:"font-bold text-lg mb-2",children:[f("accept_job"),"?"]}),e.jsx("p",{className:"text-gray-600 mb-4 text-sm",children:K.pickupAddress}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(G,{variant:"outline",onClick:()=>W(null),className:"flex-1",children:f("cancel")}),e.jsx(G,{onClick:nt,className:"flex-1",children:f("confirm")})]})]})}),qe&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-md max-h-[95vh] overflow-y-auto",children:[e.jsx("h3",{className:"font-bold text-lg mb-4",children:f("request_settlement")}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 rounded-xl border-2 border-red-200 bg-red-50",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-red-800",children:"ðŸ’° COD Collection"}),e.jsx("p",{className:"text-[10px] text-red-600",children:"You owe this to company"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-[10px] text-gray-500",children:"Outstanding"}),e.jsxs("p",{className:"text-sm font-bold text-red-700",children:["$",R.cod.usd.toFixed(2)," / ",R.cod.khr.toLocaleString()," áŸ›"]})]})]}),e.jsx("p",{className:"text-[10px] font-bold text-red-500 uppercase mb-2",children:"ðŸ¦ Bank Transfer"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] text-red-500 mb-1",children:"USD"}),e.jsx("input",{type:"number",step:"0.01",className:"w-full border border-red-200 rounded-lg px-3 py-2 font-bold text-gray-900 focus:ring-2 focus:ring-red-400 outline-none bg-white",placeholder:"0.00",value:oe,onChange:t=>Ce(parseFloat(t.target.value)||0)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] text-red-500 mb-1",children:"KHR"}),e.jsx("input",{type:"number",className:"w-full border border-red-200 rounded-lg px-3 py-2 font-bold text-gray-900 focus:ring-2 focus:ring-red-400 outline-none bg-white",placeholder:"0",value:de,onChange:t=>we(parseFloat(t.target.value)||0)})]})]}),e.jsx("p",{className:"text-[10px] font-bold text-red-500 uppercase mb-2",children:"ðŸ’µ Cash Handover"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] text-red-500 mb-1",children:"USD"}),e.jsx("input",{type:"number",step:"0.01",className:"w-full border border-red-200 rounded-lg px-3 py-2 font-bold text-gray-900 focus:ring-2 focus:ring-red-400 outline-none bg-white",placeholder:"0.00",value:ce,onChange:t=>De(parseFloat(t.target.value)||0)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] text-red-500 mb-1",children:"KHR"}),e.jsx("input",{type:"number",className:"w-full border border-red-200 rounded-lg px-3 py-2 font-bold text-gray-900 focus:ring-2 focus:ring-red-400 outline-none bg-white",placeholder:"0",value:xe,onChange:t=>Re(parseFloat(t.target.value)||0)})]})]})]}),(R.taxi.usd>0||R.taxi.khr>0)&&e.jsxs("div",{className:"p-4 rounded-xl border-2 border-green-200 bg-green-50",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-green-800",children:"ðŸš• Taxi Reimbursement"}),e.jsx("p",{className:"text-[10px] text-green-600",children:"Company owes you this"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-[10px] text-gray-500",children:"To Receive"}),e.jsxs("p",{className:"text-sm font-bold text-green-700",children:[R.taxi.usd>0&&`$${R.taxi.usd.toFixed(2)}`,R.taxi.usd>0&&R.taxi.khr>0&&" / ",R.taxi.khr>0&&`${R.taxi.khr.toLocaleString()} áŸ›`]})]})]}),e.jsx("p",{className:"text-[10px] text-green-600 italic mb-2",children:"This amount will be automatically credited to your wallet or offset against COD."})]}),e.jsx("div",{className:"p-3 rounded-lg bg-gray-100 border border-gray-200",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-gray-600",children:"Net Settlement"}),e.jsxs("p",{className:"text-[10px] text-gray-500",children:["(COD - Taxi = ",y.difference>=0?"You pay":"You receive",")"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:`text-lg font-bold ${y.totalDebtBase>=0?"text-red-600":"text-green-600"}`,children:["$",Math.abs(y.totalDebtBase).toFixed(2)]}),e.jsxs("p",{className:"text-[10px] text-gray-500",children:["Rate: 1 USD = ",y.exchangeRate.toLocaleString()," KHR"]})]})]})}),e.jsxs("div",{className:`p-3 rounded-lg border flex justify-between items-center ${y.isBalanced?"bg-green-50 border-green-200":y.difference<0?"bg-orange-50 border-orange-200":"bg-blue-50 border-blue-200"}`,children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Total Value Provided (Est.)"}),e.jsxs("p",{className:"font-bold text-gray-900",children:["$",y.totalProvidedBase.toLocaleString(void 0,{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Difference"}),e.jsx("p",{className:`font-bold ${y.isBalanced?"text-green-600":y.difference<0?"text-orange-600":"text-blue-600"}`,children:y.isBalanced?"âœ“ Exact Match":y.difference<0?`Shortage: ${y.difference.toFixed(2)}`:`Overpayment: +${y.difference.toFixed(2)}`}),e.jsx("p",{className:"text-[9px] text-gray-400 mt-0.5",children:y.isBalanced?"":y.difference<0?"Remaining will be debt":"Excess will be credit"})]})]}),(y.bankUSD>0||y.bankKHR>0)&&e.jsxs("div",{className:"mt-2 space-y-2",children:[y.bankUSD>0&&Q&&e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-blue-50 border border-blue-100 rounded-lg",children:[Q.qrCode&&e.jsx("img",{src:Q.qrCode,className:"w-10 h-10 object-contain bg-white rounded",alt:"QR"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-xs text-blue-800 font-bold",children:["Transfer USD to: ",Q.name]}),e.jsx("p",{className:"text-[10px] text-gray-500 font-mono",children:Q.code})]})]}),y.bankKHR>0&&Z&&e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-orange-50 border border-orange-100 rounded-lg",children:[Z.qrCode&&e.jsx("img",{src:Z.qrCode,className:"w-10 h-10 object-contain bg-white rounded",alt:"QR"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-xs text-orange-800 font-bold",children:["Transfer KHR to: ",Z.name]}),e.jsx("p",{className:"text-[10px] text-gray-500 font-mono",children:Z.code})]})]})]}),(y.bankUSD>0||y.bankKHR>0)&&e.jsx(ve,{label:f("proof_of_transfer"),value:ne,onChange:Ie}),!y.isBalanced&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-bold text-gray-500 mb-1",children:"Reason (optional)"}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none",rows:2,placeholder:y.difference<0?"Why are you settling less than owed?":"Why are you settling more than owed?",value:Ye,onChange:t=>Ee(t.target.value)})]}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t border-gray-100 mt-2",children:[e.jsx("button",{onClick:()=>ie(!1),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50",children:f("cancel")}),e.jsx(G,{onClick:at,isLoading:et,disabled:!y.isCreditBalance&&y.totalProvidedBase<=0||(y.bankUSD>0||y.bankKHR>0)&&!ne,className:"flex-1 bg-indigo-600 hover:bg-indigo-700",children:f("submit_request")})]})]})]})}),re&&e.jsx(ht,{itemId:re.itemId,bookingId:re.bookingId,itemName:re.itemName,currentUser:s,recipientName:re.customerName,recipientId:re.customerUid,onClose:()=>je(null)}),ee&&e.jsx("div",{className:"fixed inset-0 z-[60] bg-black bg-opacity-90 flex items-center justify-center p-4",onClick:()=>Ne(null),children:e.jsx("img",{src:ee,alt:"Zoom",className:"max-w-full max-h-full rounded-lg"})})]}):e.jsxs("div",{className:"text-center py-10 bg-white rounded-xl shadow-sm border border-gray-200 m-4",children:[e.jsx("div",{className:"bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:"Access Restricted"}),e.jsxs("p",{className:"text-gray-500 mt-2 px-6 text-sm",children:["Your account is created, but it is not linked to an active ",e.jsx("strong",{children:"Driver Profile"})," in the system."]}),e.jsx("p",{className:"text-gray-400 mt-4 text-xs",children:"Please contact the administrator to add you to the Fleet."})]})};export{Tt as D};
