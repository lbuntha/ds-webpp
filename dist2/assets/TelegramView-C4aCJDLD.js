import{r as c,a6 as z,j as e,q as Z,m as J,n as q,w as te,a7 as ee,a8 as se,o as V,f as K,H as ae,a9 as re,U as ne}from"./index-BjK2osQV.js";import{C as A}from"./Card-DROeE3UG.js";import{B as G}from"./Button-JCYNVMjR.js";import{I as $}from"./Input-B96Hj4QL.js";import{t as j}from"./toast-DTXa3ATd.js";import{M as le}from"./Modal-B63ndL_a.js";const ce=()=>e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),ie=()=>{const[m,k]=c.useState([]),[y,D]=c.useState(!0),[S,C]=c.useState("ALL"),[g,R]=c.useState(7),[v,T]=c.useState(new Set),[x,f]=c.useState(null),[u,p]=c.useState({amount:"",currency:"USD",payer:"",driverCode:"",trxId:""}),[b,L]=c.useState(!1),P=async()=>{D(!0);try{const s=new Date;s.setDate(s.getDate()-g);const a=Z(J(q,"telegram_messages"),te("date",">=",s),ee("date","desc"),se(500)),n=(await V(a)).docs.map(t=>({...t.data(),updateId:t.id}));k(n)}catch(s){console.error("Failed to load telegram messages:",s)}finally{D(!1)}};c.useEffect(()=>{P()},[g]);const[N,M]=c.useState([]);c.useEffect(()=>{(async()=>{const a=await K.getTelegramGroups();M(a)})()},[]);const I=s=>{if(!s)return"Unknown";const a=N.find(n=>n.chatTitle===s||n.name===s);if(a)return a.chatTitle;const r=N.find(n=>n.chatTitle.startsWith(s+" ")||n.chatTitle.startsWith(s+"-"));return r?r.chatTitle:s},E=c.useMemo(()=>{const s=new Set;return m.forEach(a=>{var n;let r=a.configGroupName||a.chatTitle||"Unknown";(n=a.transactionData)!=null&&n.driverCode&&(r=a.transactionData.driverCode),s.add(I(r))}),Array.from(s).sort()},[m,N]),B=c.useMemo(()=>{const s=S==="ALL"?m:m.filter(r=>{var d;let n=r.configGroupName||r.chatTitle||"Unknown";return(d=r.transactionData)!=null&&d.driverCode&&(n=r.transactionData.driverCode),I(n)===S}),a={};return s.forEach(r=>{var l;let n=(l=r.transactionData)==null?void 0:l.driverCode;n||(n=r.configGroupName||r.chatTitle||"Unknown");const t=I(n),o=(r.date instanceof z?r.date.toDate():new Date(r.date)).toISOString().split("T")[0];a[t]||(a[t]={}),a[t][o]||(a[t][o]=[]),a[t][o].push(r)}),a},[m,S,N]),F=s=>{T(a=>{const r=new Set(a);return r.has(s)?r.delete(s):r.add(s),r})},i=s=>{var a;if(f(s),s.transactionData)p({amount:((a=s.transactionData.amount)==null?void 0:a.toString())||"",currency:s.transactionData.currency||"USD",payer:s.transactionData.payer||"",driverCode:s.transactionData.driverCode||"",trxId:s.transactionData.trxId||""});else{const r=s.text||"";let n="",t="USD",d="",o="",l="";const h=r.match(/\$\s*([0-9.]+)/);if(h)n=h[1],t="USD";else{const X=r.match(/[áŸ›R]\s*([0-9,]+)/i);X&&(n=X[1].replace(/,/g,""),t="KHR")}const W=r.match(/(DS\d{3})/i);W&&(o=W[1].toUpperCase());const _=r.match(/Trx\.?\s*ID:?\s*(\d+)/i);_&&(l=_[1]);const Q=r.match(/paid by\s+(.+?)\s*(\(|on)/i);Q&&(d=Q[1].trim()),p({amount:n,currency:t,payer:d,driverCode:o,trxId:l})}},w=async()=>{if(x){L(!0);try{const s={amount:parseFloat(u.amount),currency:u.currency,payer:u.payer,driverCode:u.driverCode.toUpperCase(),trxId:u.trxId,date:x.date,originalText:x.text,manual:!0},a=ae(q,"telegram_messages",x.updateId);await re(a,{processed:!0,manual:!0,transactionData:s}),k(r=>r.map(n=>n.updateId===x.updateId?{...n,processed:!0,manual:!0,transactionData:s}:n)),j.success("Message updated manually"),f(null)}catch(s){console.error("Failed to update message:",s),j.error("Failed to update message")}finally{L(!1)}}},O=s=>new Date(s).toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}),U=s=>(s instanceof z?s.toDate():new Date(s)).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),H=s=>{const a={};return s.forEach(r=>{if(r.transactionData){const n=r.transactionData.driverCode||"Unknown",t=r.transactionData.currency,d=r.transactionData.amount;a[n]||(a[n]={USD:0,KHR:0}),t==="USD"?a[n].USD+=d:t==="KHR"&&(a[n].KHR+=d)}}),a};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(A,{children:[e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"Group"}),e.jsxs("select",{className:"border border-gray-300 rounded-lg px-3 py-2 text-sm min-w-[200px]",value:S,onChange:s=>C(s.target.value),children:[e.jsx("option",{value:"ALL",children:"All Groups"}),E.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 mb-1",children:"Time Range"}),e.jsxs("select",{className:"border border-gray-300 rounded-lg px-3 py-2 text-sm",value:g,onChange:s=>R(Number(s.target.value)),children:[e.jsx("option",{value:1,children:"Last 24 hours"}),e.jsx("option",{value:7,children:"Last 7 days"}),e.jsx("option",{value:14,children:"Last 14 days"}),e.jsx("option",{value:30,children:"Last 30 days"})]})]}),e.jsx("div",{className:"ml-auto",children:e.jsx(G,{onClick:P,isLoading:y,variant:"secondary",className:"text-sm",children:"ðŸ”„ Refresh"})})]}),e.jsxs("div",{className:"mt-4 flex gap-4 text-sm",children:[e.jsxs("span",{className:"text-gray-500",children:["Total: ",e.jsx("span",{className:"font-bold text-gray-900",children:m.length})," messages"]}),e.jsxs("span",{className:"text-gray-500",children:["Groups: ",e.jsx("span",{className:"font-bold text-gray-900",children:E.length})]})]})]}),y?e.jsx("div",{className:"text-center py-12 text-gray-500",children:"Loading messages..."}):Object.keys(B).length===0?e.jsx(A,{children:e.jsx("div",{className:"text-center py-12 text-gray-500",children:"No messages found for the selected filters."})}):Object.entries(B).map(([s,a])=>e.jsxs(A,{title:`ðŸ“± ${s}`,children:[e.jsx("div",{className:"mb-3 flex items-center gap-2",children:e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full",children:[Object.values(a).reduce((r,n)=>r+n.length,0)," messages"]})}),e.jsx("div",{className:"space-y-3",children:Object.entries(a).sort((r,n)=>n[0].localeCompare(r[0])).map(([r,n])=>{const t=`${s}-${r}`,d=v.has(t),o=H(n);return e.jsxs("div",{className:"border border-gray-100 rounded-xl overflow-hidden",children:[e.jsxs("button",{onClick:()=>F(t),className:"w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-lg",children:d?"ðŸ“‚":"ðŸ“"}),e.jsx("span",{className:"font-medium text-gray-900",children:O(r)})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[!d&&Object.entries(o).length>0&&e.jsxs("div",{className:"flex gap-2 text-xs text-gray-500",children:[Object.entries(o).slice(0,2).map(([l,h])=>e.jsxs("span",{children:[l,": $",h.USD.toFixed(2)]},l)),Object.keys(o).length>2&&e.jsx("span",{children:"..."})]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[n.length," msg"]})]})]}),d&&e.jsxs("div",{className:"divide-y divide-gray-100",children:[Object.keys(o).length>0&&e.jsxs("div",{className:"p-3 bg-blue-50 border-b border-blue-100",children:[e.jsx("h4",{className:"text-xs font-bold text-blue-800 uppercase mb-2",children:"Daily Summary"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-4",children:Object.entries(o).map(([l,h])=>e.jsxs("div",{className:"bg-white p-2 rounded border border-blue-100 shadow-sm",children:[e.jsx("div",{className:"text-xs font-bold text-gray-700 mb-1",children:l}),e.jsxs("div",{className:"flex flex-col gap-0.5",children:[h.USD>0&&e.jsxs("div",{className:"text-xs text-green-700 font-mono",children:["USD ",h.USD.toFixed(2)]}),h.KHR>0&&e.jsxs("div",{className:"text-xs text-blue-700 font-mono",children:["KHR ",h.KHR.toLocaleString()]})]})]},l))})]}),n.sort((l,h)=>{const W=l.date instanceof z?l.date.toMillis():new Date(l.date).getTime();return(h.date instanceof z?h.date.toMillis():new Date(h.date).getTime())-W}).map(l=>e.jsx("div",{className:"p-4 hover:bg-gray-50 group",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-bold text-gray-500",children:U(l.date)}),e.jsx("span",{className:"text-xs text-gray-400",children:"from"}),e.jsx("span",{className:"text-xs font-medium text-blue-600",children:l.from}),l.processed&&e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded flex items-center gap-1 ${l.manual?"bg-purple-100 text-purple-700":"bg-green-100 text-green-700"}`,children:l.manual?"âœï¸ Manual":"âœ“ Parsed"})]}),e.jsx("p",{className:"text-sm text-gray-700 whitespace-pre-wrap break-words",children:l.text||"(No text content)"}),l.transactionData&&e.jsxs("div",{className:"mt-2 p-2 bg-green-50 rounded-lg border border-green-100",children:[e.jsx("p",{className:"text-xs font-bold text-green-700 mb-1",children:"Parsed Transaction:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-green-900",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Amount:"})," ",l.transactionData.currency," ",l.transactionData.amount]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Driver:"})," ",l.transactionData.driverCode]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Payer:"})," ",l.transactionData.payer]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"Trx ID:"})," ",l.transactionData.trxId]})]})]})]}),e.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(G,{variant:"secondary",onClick:()=>i(l),className:"h-8 w-8 p-0 flex items-center justify-center rounded-full",title:"Edit parsing",children:e.jsx(ce,{})})})]})},l.updateId))]})]},r)})})]},s)),e.jsx(le,{isOpen:!!x,onClose:()=>f(null),title:"Manual Transaction Parsing",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200 text-xs text-gray-600 mb-4 max-h-32 overflow-y-auto",children:x==null?void 0:x.text}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount"}),e.jsx($,{type:"number",placeholder:"0.00",value:u.amount,onChange:s=>p(a=>({...a,amount:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency"}),e.jsxs("select",{className:"w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500",value:u.currency,onChange:s=>p(a=>({...a,currency:s.target.value})),children:[e.jsx("option",{value:"USD",children:"USD ($)"}),e.jsx("option",{value:"KHR",children:"KHR (áŸ›)"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Driver Code (e.g. DS004)"}),e.jsx($,{placeholder:"DS...",value:u.driverCode,onChange:s=>p(a=>({...a,driverCode:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payer Name"}),e.jsx($,{placeholder:"Customer Name",value:u.payer,onChange:s=>p(a=>({...a,payer:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Transaction ID"}),e.jsx($,{placeholder:"123456...",value:u.trxId,onChange:s=>p(a=>({...a,trxId:s.target.value}))})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx(G,{variant:"secondary",onClick:()=>f(null),children:"Cancel"}),e.jsx(G,{onClick:w,isLoading:b,children:"Save & Mark Parsed"})]})]})})]})},oe=()=>e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),de=()=>e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),xe=()=>e.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})}),Y=()=>e.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})}),me=()=>{const[m,k]=c.useState([]),[y,D]=c.useState([]),[S,C]=c.useState(!0),[g,R]=c.useState(!1),[v,T]=c.useState(""),[x,f]=c.useState(new Set),[u,p]=c.useState(!1),[b,L]=c.useState(""),[P,N]=c.useState(0),[M,I]=c.useState([]),E=async()=>{C(!0);try{const d=(await V(J(q,"customers"))).docs.map(o=>({id:o.id,name:o.data().name||o.data().businessName||"Unknown",phone:o.data().phone,telegramChatId:o.data().telegramChatId})).filter(o=>o.telegramChatId&&o.telegramChatId.trim()!=="").sort((o,l)=>o.name.localeCompare(l.name));k(d),D(d),N(d.length)}catch{j.error("Failed to load users")}finally{C(!1)}};c.useEffect(()=>{if(!b.trim())D(m);else{const t=b.toLowerCase();D(m.filter(d=>d.name.toLowerCase().includes(t)||d.phone&&d.phone.includes(t)))}},[b,m]);const B=c.useCallback(async()=>{try{const t=Z(J(q,"telegram_broadcast_jobs"),ee("createdAt","desc"),se(5)),d=await V(t);I(d.docs.map(o=>({...o.data(),id:o.id})))}catch{}},[]);c.useEffect(()=>{E(),B()},[B]);const F=t=>{f(d=>{const o=new Set(d);return o.has(t)?o.delete(t):o.add(t),o})},i=()=>{f(u?new Set:new Set(y.map(t=>t.id))),p(!u)},[w,O]=c.useState(null),[U,H]=c.useState(null),s=t=>{if(t.target.files&&t.target.files[0]){const d=t.target.files[0];if(d.size>5*1024*1024){j.error("Image size must be less than 5MB");return}O(d);const o=new FileReader;o.onloadend=()=>{H(o.result)},o.readAsDataURL(d)}},a=()=>{O(null),H(null)},r=async()=>{if(!v.trim()&&!w){j.error("Please enter a message or select an image");return}if(x.size===0){j.error("Please select at least one recipient");return}R(!0);try{const t=m.filter(h=>x.has(h.id)).map(h=>({customerId:h.id,chatId:h.telegramChatId,name:h.name})),d={message:v.trim(),recipients:t};w&&U&&(d.image=U,d.filename=w.name);const l=await(await fetch(`${ne.app.apiUrl}/telegram/broadcast`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json();l.success?(j.success(`Message sent to ${l.sent} users${l.failed>0?` (${l.failed} failed)`:""}`),T(""),a(),f(new Set),p(!1)):j.error(l.error||"Failed to send messages")}catch(t){j.error(t.message||"Failed to send broadcast")}finally{R(!1)}},n=t=>{switch(t){case"COMPLETED":return"bg-green-100 text-green-700";case"PROCESSING":return"bg-blue-100 text-blue-700";case"FAILED":return"bg-red-100 text-red-700";default:return"bg-gray-100 text-gray-700"}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(A,{title:"Compose Message",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Message"}),e.jsx("textarea",{className:"w-full border border-gray-300 rounded-lg p-3 min-h-[120px] text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter your message here... (Markdown supported: *bold*, _italic_)",value:v,onChange:t=>T(t.target.value)}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Supports Markdown: *bold*, _italic_, `code`"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"Attachment (Optional)"}),U?e.jsxs("div",{className:"relative w-fit",children:[e.jsx("img",{src:U,alt:"Preview",className:"h-32 rounded-lg border border-gray-200"}),e.jsx("button",{onClick:a,className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-md",children:e.jsx(Y,{})})]}):e.jsx("div",{className:"flex items-center justify-center w-full",children:e.jsxs("label",{className:"flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center pt-5 pb-6",children:[e.jsx("svg",{className:"w-8 h-8 mb-4 text-gray-500","aria-hidden":"true",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 4v16m8-8H4"})}),e.jsxs("p",{className:"mb-2 text-sm text-gray-500",children:[e.jsx("span",{className:"font-semibold",children:"Click to upload"})," image"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"PNG, JPG or GIF (MAX. 5MB)"})]}),e.jsx("input",{type:"file",className:"hidden",accept:"image/*",onChange:s})]})})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-gray-100",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-bold text-blue-600",children:x.size})," of ",P," recipients selected"]}),e.jsxs(G,{onClick:r,isLoading:g,disabled:!v.trim()&&!w||x.size===0||g,className:"flex items-center gap-2",children:[e.jsx(oe,{}),"Send to ",x.size," User",x.size!==1?"s":""]})]})]})}),e.jsxs(A,{title:`Linked Users (${P})`,action:e.jsxs(G,{variant:"secondary",onClick:E,isLoading:S,className:"text-sm flex items-center gap-1",children:[e.jsx(de,{}),"Refresh"]}),children:[e.jsx("div",{className:"mb-4",children:e.jsx($,{placeholder:"Search by name or phone...",value:b,onChange:t=>L(t.target.value),className:"w-full"})}),S?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading users..."}):m.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-500 mb-2",children:"No users with linked Telegram accounts found."}),e.jsx("p",{className:"text-xs text-gray-400",children:"Users can link their accounts via the customer app."})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100",children:[e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:u&&x.size===y.length,onChange:i,className:"rounded text-blue-600 w-5 h-5"}),e.jsxs("span",{className:"font-medium text-gray-700",children:["Select All (",y.length," users)"]})]}),x.size>0&&e.jsx("button",{onClick:()=>{f(new Set),p(!1)},className:"text-xs text-red-600 hover:underline",children:"Clear Selection"})]}),e.jsx("div",{className:"max-h-[400px] overflow-y-auto space-y-2",children:y.map(t=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border transition-colors cursor-pointer ${x.has(t.id)?"bg-blue-50 border-blue-200":"bg-white border-gray-200 hover:bg-gray-50"}`,onClick:()=>F(t.id),children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"checkbox",checked:x.has(t.id),onChange:()=>F(t.id),className:"rounded text-blue-600 w-4 h-4",onClick:d=>d.stopPropagation()}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:t.name}),t.phone&&e.jsx("div",{className:"text-xs text-gray-500",children:t.phone})]})]}),e.jsxs("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full flex items-center gap-1",children:[e.jsx("span",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),"Linked"]})]},t.id))}),y.length===0&&b&&e.jsxs("p",{className:"text-center text-gray-500 py-4",children:['No users match "',b,'"']})]})]}),M.length>0&&e.jsx(A,{title:"Recent Broadcasts",children:e.jsx("div",{className:"space-y-2",children:M.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full font-medium ${n(t.status)}`,children:t.status}),e.jsxs("span",{className:"text-sm text-gray-600 truncate max-w-[200px]",children:[t.message.substring(0,50),t.message.length>50?"...":""]})]})}),e.jsxs("div",{className:"text-right text-xs text-gray-500",children:[e.jsxs("div",{children:[t.totalRecipients," recipients"]}),e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(xe,{})," ",t.sent]}),e.jsxs("span",{className:"flex items-center gap-0.5",children:[e.jsx(Y,{})," ",t.failed]})]})]})]},t.id))})})]})},he=()=>{const[m,k]=c.useState("GROUPS"),[y,D]=c.useState([]),[S,C]=c.useState(!1),[g,R]=c.useState(null),[v,T]=c.useState(""),[x,f]=c.useState(""),[u,p]=c.useState(!0),[b,L]=c.useState(!0),[P,N]=c.useState(null),M=async()=>{C(!0);try{const i=await K.getTelegramGroups();D(i)}catch(i){console.error(i)}finally{C(!1)}};c.useEffect(()=>{M()},[]);const I=()=>{R(null),T(""),f(""),p(!0),L(!0)},E=i=>{R(i.id),T(i.name),f(i.chatTitle),p(i.isActive),L(i.monitorPayWay),window.scrollTo({top:0,behavior:"smooth"})},B=async i=>{var w;if(i.preventDefault(),!v||!x){j.error("Name and Chat Title are required");return}C(!0);try{const O={id:g||`tg-${Date.now()}`,name:v,chatTitle:x,isActive:u,monitorPayWay:b,createdAt:g&&((w=y.find(U=>U.id===g))==null?void 0:w.createdAt)||Date.now(),updatedAt:Date.now()};await K.saveTelegramGroup(O),I(),await M(),j.success(g?"Group updated.":"Group added.")}catch{j.error("Failed to save group")}finally{C(!1)}},F=async i=>{try{await K.deleteTelegramGroup(i),await M(),j.success("Group deleted.")}catch{j.error("Failed to delete group.")}finally{N(null)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex space-x-1 bg-white p-1 rounded-xl shadow-sm border border-gray-100 max-w-fit",children:[e.jsxs("button",{onClick:()=>k("GROUPS"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${m==="GROUPS"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),"Groups"]}),e.jsxs("button",{onClick:()=>k("LOGS"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${m==="LOGS"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})}),"Message Log"]}),e.jsxs("button",{onClick:()=>k("BROADCAST"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${m==="BROADCAST"?"bg-blue-50 text-blue-700":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"})}),"Broadcast"]})]}),m==="GROUPS"&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsx(A,{title:g?"Edit Telegram Group":"Add Telegram Group",children:e.jsxs("form",{onSubmit:B,className:"space-y-4",children:[e.jsx($,{label:"Display Name",value:v,onChange:i=>T(i.target.value),placeholder:"e.g. PayWay Notifications",required:!0}),e.jsx($,{label:"Telegram Chat Title",value:x,onChange:i=>f(i.target.value),placeholder:"Exact group name in Telegram",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 -mt-2",children:"This must match the exact group name as it appears in Telegram."}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg border border-blue-100 space-y-3",children:[e.jsx("p",{className:"text-xs font-bold text-blue-800 uppercase",children:"Monitoring Options"}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:b,onChange:i=>L(i.target.checked),className:"rounded text-blue-600"}),e.jsx("span",{className:"text-sm",children:"Monitor for PayWay messages"})]})]}),e.jsxs("label",{className:"flex items-center space-x-2 pt-2",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:i=>p(i.target.checked),className:"rounded text-indigo-600"}),e.jsx("span",{className:"text-sm font-medium",children:"Group Active"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2",children:[g&&e.jsx(G,{type:"button",variant:"outline",onClick:I,children:"Cancel"}),e.jsx(G,{type:"submit",isLoading:S,children:g?"Update":"Add Group"})]})]})})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsx(A,{title:"Configured Telegram Groups",children:e.jsxs("div",{className:"space-y-3",children:[y.map(i=>e.jsxs("div",{className:`flex justify-between items-center p-4 border rounded-xl bg-white ${i.isActive?"border-gray-200":"border-gray-200 opacity-60"}`,children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-bold text-gray-900",children:i.name}),!i.isActive&&e.jsx("span",{className:"text-xs bg-gray-100 px-2 py-0.5 rounded",children:"Inactive"})]}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Chat: ",e.jsx("span",{className:"font-medium text-blue-600",children:i.chatTitle})]}),e.jsx("div",{className:"flex gap-4 mt-2 text-xs",children:i.monitorPayWay&&e.jsxs("span",{className:"text-green-600 font-bold flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full"}),"PayWay Monitoring"]})})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("button",{onClick:()=>E(i),className:"text-indigo-600 hover:text-indigo-900 text-sm font-medium px-2",children:"Edit"}),P===i.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>F(i.id),className:"text-white bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs font-bold",children:"Confirm"}),e.jsx("button",{onClick:()=>N(null),className:"text-gray-500 hover:text-gray-700 px-2 py-1 text-xs",children:"Cancel"})]}):e.jsx("button",{onClick:()=>N(i.id),className:"text-red-600 hover:text-red-900 text-sm font-medium px-2",children:"Delete"})]})]},i.id)),y.length===0&&e.jsx("p",{className:"text-center py-8 text-gray-500",children:"No telegram groups configured. Add a group to start monitoring."})]})})})]}),m==="LOGS"&&e.jsx(ie,{}),m==="BROADCAST"&&e.jsx(me,{})]})};function be(){return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Telegram Integration"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Manage Telegram groups and view message logs"})]})}),e.jsx(he,{})]})}export{be as default};
