import{u as z,r as d,j as e}from"./index-BjK2osQV.js";import{B as K}from"./Button-JCYNVMjR.js";import{L as V}from"./LocationPicker-BMHhAdnZ.js";import{P as T}from"./PlaceAutocomplete-IKHODmB-.js";import{t as p}from"./toast-DTXa3ATd.js";const ee=({job:u,user:c,services:W,onSave:k,onFinish:C,onCancel:b})=>{var A,R;const{t:J}=z(),[n,h]=d.useState(u.items.map(t=>({...t,productPrice:Number(t.productPrice)||0,weight:Number(t.weight)||0,codCurrency:t.codCurrency||(Number(t.productPrice)>=1e3?"KHR":"USD"),status:t.status||"PENDING"}))),[l,v]=d.useState(0),[F,I]=d.useState(0),[L,N]=d.useState(1),[D,f]=d.useState(!1),[U,y]=d.useState(!1),[S,j]=d.useState(!1),$=n.every(t=>{const s=(t.receiverName||"").trim().toLowerCase(),a=(t.destinationAddress||"").trim().toLowerCase(),r=!s||s==="details in photo"||s.includes("details in photo"),i=!a||a.includes("driver to extract")||a.includes("driver to fill")||a==="unknown";return!r&&!i}),M=async()=>{f(!0);try{const t=n.map(a=>({...a,status:"PICKED_UP",driverId:c.uid,driverName:c.name,collectorId:c.uid,collectorName:c.name,modifications:[...a.modifications||[],{timestamp:Date.now(),userId:c.uid,userName:c.name,field:"Status",oldValue:a.status||"PENDING",newValue:"PICKED_UP"}]})),s={...u,items:t,status:"IN_TRANSIT"};await k(s),await C()}catch(t){console.error(t),p.error("Failed to confirm pickup. Please try again.")}finally{f(!1)}};d.useEffect(()=>{const t=n.findIndex(s=>s.status==="PENDING");t!==-1&&v(t)},[]),d.useEffect(()=>{I(0),N(1)},[l]);const o=n[l],w=n.filter(t=>t.status==="PENDING").length,m=(t,s)=>{const a=[...n],r={...a[l]};if(t==="productPrice"||t==="weight"){const i=parseFloat(s);r[t]=isNaN(i)?0:i,t==="productPrice"&&(r.codCurrency=i>=1e3?"KHR":"USD")}else r[t]=s;a[l]=r,h(a)},_=()=>{if(!navigator.geolocation){p.warning("Geolocation is not supported by this browser.");return}j(!0),navigator.geolocation.getCurrentPosition(async t=>{const{latitude:s,longitude:a}=t.coords,r=[...n];r[l]={...r[l],destinationLocation:{lat:s,lng:a}},h(r);try{const g=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s}&lon=${a}`)).json();g&&g.display_name&&m("destinationAddress",g.display_name)}catch(i){console.error("Reverse geocoding failed",i)}finally{j(!1)}},t=>{console.error(t),p.error("Unable to retrieve location."),j(!1)},{enableHighAccuracy:!0})},G=(t,s,a)=>{const r=[...n];r[l]={...r[l],destinationAddress:a,destinationLocation:{lat:t,lng:s}},h(r),y(!1)},H=t=>{const s=[...n];s[l]={...s[l],destinationAddress:t.address,destinationLocation:t.location},h(s)},B=async()=>{if(!o.receiverName||o.receiverName.trim()===""||o.receiverName==="Details in Photo"){p.warning("Please enter the Receiver Name from the image.");return}f(!0);const t=[...n],s={...o,status:"PICKED_UP",driverId:c.uid,driverName:c.name,collectorId:c.uid,collectorName:c.name,modifications:[...o.modifications||[],{timestamp:Date.now(),userId:c.uid,userName:c.name,field:"Status",oldValue:o.status||"PENDING",newValue:"PICKED_UP"}]};t[l]=s,h(t);try{const a={...u,items:t,status:t.every(x=>x.status==="PICKED_UP")?"IN_TRANSIT":"CONFIRMED"},i=(Number(s==null?void 0:s.productPrice)||0)>=1e3?"KHR":"USD";s.codCurrency=i,i==="USD"?s.deliveryFee=s.deliveryFeeUSD||0:s.deliveryFee=s.deliveryFeeKHR||0,t[l]=s;const g=t.reduce((x,P)=>x+(P.deliveryFee||0),0);if(a.totalDeliveryFee=g,a.currency=i,a.items=t,await k(a),t.filter(x=>x.status==="PENDING").length>0){const x=t.findIndex(P=>P.status==="PENDING");x!==-1&&v(x)}else await C()}catch(a){console.error(a),p.error("Failed to save. Please try again.")}finally{f(!1)}};if(!o)return null;const E=w<=1&&o.status==="PENDING";if($&&w>0){const t=n.filter(r=>r.codCurrency!=="KHR").reduce((r,i)=>r+(Number(i.productPrice)||0),0),s=n.filter(r=>r.codCurrency==="KHR").reduce((r,i)=>r+(Number(i.productPrice)||0),0),a=n[0];return e.jsx("div",{className:"fixed inset-0 z-[100] bg-gray-100 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:"ðŸ“¦ Stock Pickup"}),e.jsxs("p",{className:"text-indigo-100 text-sm mt-1",children:["From: ",u.senderName]})]}),e.jsx("button",{onClick:b,className:"text-white/70 hover:text-white",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]})}),e.jsxs("div",{className:"p-4 border-b border-gray-100 bg-gray-50",children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-bold mb-1",children:"Deliver To"}),e.jsx("p",{className:"font-bold text-gray-900",children:a.receiverName}),e.jsx("p",{className:"text-sm text-gray-600",children:a.receiverPhone}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:a.destinationAddress})]}),e.jsxs("div",{className:"p-4 max-h-[40vh] overflow-y-auto",children:[e.jsxs("p",{className:"text-xs text-gray-500 uppercase font-bold mb-3",children:["Products (",n.length,")"]}),e.jsx("div",{className:"space-y-3",children:n.map((r,i)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-xl",children:[r.image&&e.jsx("img",{src:r.image,className:"w-12 h-12 rounded-lg object-cover border border-gray-200",alt:""}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 text-sm truncate",children:r.sku||r.receiverName||`Item ${i+1}`}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Qty: ",r.quantity||1]})]}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:"font-bold text-gray-900",children:r.codCurrency==="KHR"?`${(r.productPrice||0).toLocaleString()}áŸ›`:`$${(r.productPrice||0).toFixed(2)}`})})]},r.id))})]}),e.jsxs("div",{className:"p-4 bg-indigo-50 border-t border-indigo-100",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total COD"}),e.jsxs("span",{className:"font-bold text-lg text-indigo-900",children:[t>0&&`$${t.toFixed(2)}`,t>0&&s>0&&" + ",s>0&&`${s.toLocaleString()}áŸ›`,t===0&&s===0&&"$0.00"]})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-gray-500",children:[e.jsx("span",{children:"Delivery Fee"}),e.jsxs("span",{children:["$",(u.totalDeliveryFee||0).toFixed(2)]})]})]}),e.jsx("div",{className:"p-4",children:e.jsxs(K,{onClick:M,isLoading:D,className:"w-full py-4 text-lg font-bold bg-green-600 hover:bg-green-700 shadow-lg shadow-green-200",children:["âœ“ Confirm Pickup (",n.length," items)"]})})]})})}return e.jsxs("div",{className:"fixed inset-0 z-[100] bg-gray-100 flex flex-col h-full md:flex-row overflow-hidden",children:[e.jsxs("div",{className:"relative flex-1 bg-gray-900 flex items-center justify-center overflow-hidden h-[40vh] md:h-full group",children:[e.jsx("div",{className:"w-full h-full p-4 flex items-center justify-center",children:e.jsx("img",{src:o.image,alt:"Parcel",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`rotate(${F}deg) scale(${L})`,cursor:L>1?"grab":"default"}},`${o.id}-${l}`)}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/70 to-transparent flex justify-between items-start md:hidden z-20",children:[e.jsxs("div",{className:"text-white",children:[e.jsxs("h3",{className:"font-bold text-lg",children:["Parcel ",l+1," of ",n.length]}),e.jsxs("p",{className:"text-xs opacity-80",children:[w," remaining"]})]}),e.jsx("button",{onClick:b,className:"text-white bg-white/20 p-2 rounded-full backdrop-blur-sm",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"absolute bottom-6 left-1/2 transform -translate-x-1/2 flex items-center gap-4 bg-gray-800/90 backdrop-blur rounded-full px-4 py-2 shadow-xl border border-gray-700 z-20",children:[e.jsx("button",{onClick:()=>I(t=>t-90),className:"text-gray-300 hover:text-white",children:e.jsx("span",{className:"text-xl",children:"â†º"})}),e.jsx("div",{className:"h-5 w-px bg-gray-600"}),e.jsx("button",{onClick:()=>N(t=>Math.max(1,t-.5)),className:"text-gray-300 hover:text-white font-bold text-xl",children:"-"}),e.jsx("button",{onClick:()=>N(t=>Math.min(4,t+.5)),className:"text-gray-300 hover:text-white font-bold text-xl",children:"+"})]})]}),e.jsxs("div",{className:"w-full md:w-[450px] bg-white border-l border-gray-200 flex flex-col h-[60vh] md:h-full shadow-2xl relative z-10",children:[e.jsxs("div",{className:"hidden md:flex px-6 py-4 border-b border-gray-100 justify-between items-center bg-white",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Details Processing"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Sender: ",u.senderName]})]}),e.jsx("button",{onClick:b,className:"text-gray-400 hover:text-gray-600",children:"Close"})]}),e.jsx("div",{className:"bg-gray-50 border-b border-gray-200 p-3 overflow-x-auto whitespace-nowrap scrollbar-hide",children:e.jsx("div",{className:"flex gap-3",children:n.map((t,s)=>e.jsxs("div",{onClick:()=>v(s),className:`
                                relative flex-shrink-0 w-14 h-14 rounded-lg border-2 cursor-pointer overflow-hidden transition-all
                                ${s===l?"border-indigo-600 ring-2 ring-indigo-200 transform scale-105":"border-gray-200 opacity-70 hover:opacity-100"}
                            `,children:[e.jsx("img",{src:t.image,className:"w-full h-full object-cover",alt:""}),e.jsxs("div",{className:`absolute inset-0 flex items-center justify-center bg-black/20 ${t.status==="PICKED_UP"?"bg-green-500/80":""}`,children:[t.status==="PICKED_UP"&&e.jsx("svg",{className:"w-6 h-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"3",d:"M5 13l4 4L19 7"})}),s===l&&t.status!=="PICKED_UP"&&e.jsx("span",{className:"w-2 h-2 bg-white rounded-full animate-pulse"})]}),e.jsxs("div",{className:"absolute bottom-0 right-0 bg-black/60 text-white text-[9px] px-1 rounded-tl",children:["#",s+1]})]},t.id))})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6 bg-white",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:["Receiver Name ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{className:"w-full text-lg font-bold border-b-2 border-gray-200 focus:border-indigo-600 focus:outline-none py-2 transition-colors placeholder-gray-300 text-gray-900",placeholder:"Type Name from Label...",value:o.receiverName==="Details in Photo"?"":o.receiverName,onChange:t=>m("receiverName",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Phone Number"}),e.jsx("input",{className:"w-full text-base border-b-2 border-gray-200 focus:border-indigo-600 focus:outline-none py-2 transition-colors placeholder-gray-300",placeholder:"012 345 678",type:"tel",value:o.receiverPhone,onChange:t=>m("receiverPhone",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-500 uppercase mb-1",children:"Address / Location"}),e.jsx(T,{value:o.destinationAddress==="Driver to extract details"?"":o.destinationAddress,onChange:t=>m("destinationAddress",t),onSelect:H,placeholder:"House #, Street, Sangkat...",className:"w-full text-sm border-2 border-gray-100 rounded-xl p-3 focus:border-indigo-500 focus:ring-0 transition-colors placeholder-gray-300 bg-gray-50 focus:bg-white"}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs("button",{type:"button",onClick:_,disabled:S,className:"flex items-center text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-colors font-medium",children:[S?e.jsx("span",{className:"animate-spin mr-1",children:"âŒ›"}):e.jsxs("svg",{className:"w-3 h-3 mr-1.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 11a3 3 0 11-6 0 3 3 0 016 0z"})]}),"Use GPS"]}),e.jsxs("button",{type:"button",onClick:()=>y(!0),className:"flex items-center text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg transition-colors font-medium border border-indigo-100",children:[e.jsx("svg",{className:"w-3 h-3 mr-1.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7m0 0L9.553 4.553A1 1 0 009 7"})}),"Pick on Map"]}),o.destinationLocation&&e.jsxs("span",{className:"flex items-center text-xs text-green-600 ml-auto font-medium",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"Saved"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[e.jsxs("div",{className:"bg-indigo-50 p-4 rounded-xl border border-indigo-100",children:[e.jsx("label",{className:"block text-[10px] font-bold text-indigo-800 uppercase mb-1",children:"Cash to Collect"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"number",className:"w-full bg-transparent font-bold text-2xl text-indigo-900 border-none p-0 focus:ring-0 placeholder-indigo-300",placeholder:"0",value:o.productPrice||"",onChange:t=>m("productPrice",t.target.value)}),e.jsxs("select",{className:"bg-transparent border-none text-xs font-bold text-indigo-500 focus:ring-0 p-0 ml-1 cursor-pointer uppercase",value:o.codCurrency,onChange:t=>m("codCurrency",t.target.value),children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"KHR",children:"KHR"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-xl border border-gray-200",children:[e.jsx("label",{className:"block text-[10px] font-bold text-gray-500 uppercase mb-1",children:"Weight (Kg)"}),e.jsx("input",{type:"number",className:"w-full bg-transparent font-bold text-2xl text-gray-800 border-none p-0 focus:ring-0 placeholder-gray-300",placeholder:"0.0",value:o.weight||"",onChange:t=>m("weight",t.target.value)})]})]})]}),e.jsx("div",{className:"p-4 border-t border-gray-100 bg-white flex gap-3 safe-area-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]",children:e.jsx(K,{onClick:B,isLoading:D,className:`flex-1 text-base py-3 justify-center shadow-lg h-12 transition-colors ${E?"bg-green-600 hover:bg-green-700 shadow-green-200":"bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200"}`,children:E?"Save & Finish":"Save & Next"})})]}),U&&e.jsx(V,{initialLat:(A=o.destinationLocation)==null?void 0:A.lat,initialLng:(R=o.destinationLocation)==null?void 0:R.lng,onConfirm:G,onClose:()=>y(!1)})]})};export{ee as D};
