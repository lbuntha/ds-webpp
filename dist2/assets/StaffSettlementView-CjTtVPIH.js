import{r as n,A as k,j as e,h as Z,a as ee,f as te}from"./index-BjK2osQV.js";import{B as T}from"./Button-JCYNVMjR.js";import{I as q}from"./Input-B96Hj4QL.js";import{C as se}from"./Card-DROeE3UG.js";const ae=({accounts:m,branches:h,employees:f,currencies:b,onSave:y,onCancel:u})=>{var O,V;const i=b.length>0?b:[{id:"curr-usd",code:"USD",name:"US Dollar",symbol:"$",exchangeRate:1,isBase:!0}],[j,U]=n.useState(""),[F,$]=n.useState(new Date().toISOString().split("T")[0]),[R,H]=n.useState(((O=h[0])==null?void 0:O.id)||""),[r,P]=n.useState(()=>{const t=i.find(a=>a.isBase);return t?t.code:i[0].code}),[d,v]=n.useState(1),x=n.useMemo(()=>{const t=i.find(a=>a.code===r);return t?t.exchangeRate:1},[r,i]),[o,N]=n.useState([{accountId:"",description:"",amount:0}]),[l,I]=n.useState("OFFSET_ADVANCE"),[S,w]=n.useState(""),[W,L]=n.useState(!1),[B,C]=n.useState(null),X=m.filter(t=>t.type===k.EXPENSE&&!t.isHeader),E=m.filter(t=>t.type===k.ASSET&&!t.isHeader),_=m.filter(t=>t.type===k.ASSET&&(t.name.toLowerCase().includes("cash")||t.name.toLowerCase().includes("bank"))&&!t.isHeader);n.useEffect(()=>{var t;if(l==="OFFSET_ADVANCE"){const a=E.find(s=>s.code==="1050")||E.find(s=>s.name.includes("Advance"));w((a==null?void 0:a.id)||"")}else w(((t=_[0])==null?void 0:t.id)||"")},[l,m]),n.useEffect(()=>{v(x)},[r,x]);const A=(t,a,s)=>{const p=[...o];p[t]={...p[t],[a]:s},N(p)},z=()=>{N([...o,{accountId:"",description:"",amount:0}])},G=t=>{o.length>1&&N(o.filter((a,s)=>s!==t))},g=o.reduce((t,a)=>t+(a.amount||0),0),M=(V=i.find(t=>t.code===r))==null?void 0:V.isBase,J=async t=>{t.preventDefault(),C(null);const a=d&&!isNaN(d)&&d!==0?d:1;if(!j||!S||g<=0||o.some(s=>!s.accountId)){C("Please fill in all fields and ensure at least one expense line is added.");return}L(!0);try{const s=f.find(c=>c.id===j),p=`je-settle-${Date.now()}`,D=o.map(c=>({accountId:c.accountId,debit:c.amount/a,credit:0,originalCurrency:r,originalExchangeRate:a,originalDebit:c.amount,originalCredit:0,description:c.description})),K=D.reduce((c,Y)=>c+Y.debit,0);D.push({accountId:S,debit:0,credit:K,originalCurrency:r,originalExchangeRate:a,originalDebit:0,originalCredit:g,description:"Settlement Total"});const Q={id:p,date:F,description:`Settlement: ${s==null?void 0:s.name} (${l==="OFFSET_ADVANCE"?"Advance Clearance":"Reimbursement"})`,reference:`SETTLE-${Date.now().toString().slice(-6)}`,branchId:R,currency:r,exchangeRate:a,originalTotal:g,lines:D,createdAt:Date.now()};await y(Q)}catch(s){console.error(s),C("Failed to post settlement.")}finally{L(!1)}};return e.jsx(se,{title:"Driver / Employee Settlement Form",children:e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-xl border border-gray-200",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Employee (Driver)"}),e.jsxs("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm",value:j,onChange:t=>U(t.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Select Employee"}),f.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsx(q,{label:"Date",type:"date",value:F,onChange:t=>$(t.target.value),required:!0}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Receipt Currency"}),e.jsx("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm",value:r,onChange:t=>P(t.target.value),children:i.map(t=>e.jsxs("option",{value:t.code,children:[t.code," - ",t.name]},t.id))})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Exchange Rate (to USD)"}),e.jsx(q,{type:"number",step:"any",value:d,onChange:t=>v(parseFloat(t.target.value)),disabled:M,required:!0}),!M&&e.jsxs("div",{className:"mt-1 flex justify-between items-center",children:[e.jsxs("span",{className:"text-[10px] text-gray-500",children:["System Rate: ",x]}),d!==x&&e.jsx("button",{type:"button",onClick:()=>v(x),className:"text-[10px] text-indigo-600 hover:text-indigo-800 underline",children:"Reset"})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-end mb-2",children:[e.jsx("h4",{className:"text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Expense Details"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Enter amounts in ",r]})]}),e.jsx("div",{className:"space-y-2",children:o.map((t,a)=>e.jsxs("div",{className:"flex flex-col md:flex-row gap-2 items-start md:items-center bg-white p-2 border border-gray-100 rounded-lg shadow-sm",children:[e.jsx("div",{className:"flex-1 w-full",children:e.jsx("input",{className:"block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",placeholder:"Description (e.g. Fuel, Toll, Repair)",value:t.description,onChange:s=>A(a,"description",s.target.value),required:!0})}),e.jsx("div",{className:"w-full md:w-64",children:e.jsxs("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",value:t.accountId,onChange:s=>A(a,"accountId",s.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Select Expense Category"}),X.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),e.jsx("div",{className:"w-full md:w-40",children:e.jsx("input",{type:"number",step:"0.01",className:"block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm text-right",placeholder:"Amount",value:t.amount||"",onChange:s=>A(a,"amount",parseFloat(s.target.value)),required:!0})}),e.jsx("button",{type:"button",onClick:()=>G(a),className:"text-red-400 hover:text-red-600 p-2",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]},a))}),e.jsx("div",{className:"mt-3",children:e.jsx(T,{type:"button",variant:"secondary",onClick:z,className:"text-xs",children:"+ Add Expense Line"})})]}),e.jsx("div",{className:"border-t border-gray-200 pt-4 mt-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start gap-6",children:[e.jsxs("div",{className:"w-full md:w-2/3 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Settlement Method"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:`flex items-center p-3 border rounded-xl cursor-pointer transition-colors w-full ${l==="OFFSET_ADVANCE"?"bg-indigo-50 border-indigo-500 ring-1 ring-indigo-500":"bg-white border-gray-200 hover:bg-gray-50"}`,children:[e.jsx("input",{type:"radio",name:"settleType",className:"text-indigo-600 focus:ring-indigo-500",checked:l==="OFFSET_ADVANCE",onChange:()=>I("OFFSET_ADVANCE")}),e.jsxs("div",{className:"ml-3",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-900",children:"Offset Advance"}),e.jsx("span",{className:"block text-xs text-gray-500",children:"Deduct from driver's debt"})]})]}),e.jsxs("label",{className:`flex items-center p-3 border rounded-xl cursor-pointer transition-colors w-full ${l==="CASH_REIMBURSEMENT"?"bg-green-50 border-green-500 ring-1 ring-green-500":"bg-white border-gray-200 hover:bg-gray-50"}`,children:[e.jsx("input",{type:"radio",name:"settleType",className:"text-green-600 focus:ring-green-500",checked:l==="CASH_REIMBURSEMENT",onChange:()=>I("CASH_REIMBURSEMENT")}),e.jsxs("div",{className:"ml-3",children:[e.jsx("span",{className:"block text-sm font-medium text-gray-900",children:"Cash Reimbursement"}),e.jsx("span",{className:"block text-xs text-gray-500",children:"Pay driver immediately"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:l==="OFFSET_ADVANCE"?"Advance Account (Asset to Credit)":"Payment Account (Asset to Credit)"}),e.jsxs("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm",value:S,onChange:t=>w(t.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Select Account"}),(l==="OFFSET_ADVANCE"?E:_).map(t=>e.jsxs("option",{value:t.id,children:[t.code," - ",t.name]},t.id))]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Branch"}),e.jsx("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm",value:R,onChange:t=>H(t.target.value),required:!0,children:h.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"w-full md:w-1/3 bg-gray-50 p-4 rounded-xl flex flex-col gap-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["Total Expenses (",r,")"]}),e.jsx("span",{className:"text-xl font-bold text-gray-900",children:g.toLocaleString(void 0,{minimumFractionDigits:2})})]}),r!=="USD"&&e.jsxs("div",{className:"flex justify-between items-center border-t border-gray-200 pt-2",children:[e.jsx("span",{className:"text-sm text-indigo-600",children:"Equivalent (USD)"}),e.jsxs("span",{className:"text-lg font-bold text-indigo-700",children:["$",(g/(d||1)).toLocaleString(void 0,{minimumFractionDigits:2})]})]})]})]})}),B&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm",children:B}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(T,{type:"button",variant:"outline",onClick:u,children:"Cancel"}),e.jsx(T,{type:"submit",isLoading:W,children:"Post Settlement"})]})]})})};function oe(){const{employees:m,accounts:h,branches:f,currencies:b,refreshData:y}=Z(),u=ee();return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Staff/Driver Settlements"}),e.jsx("button",{onClick:()=>u("/app/staff"),className:"text-gray-500 hover:text-gray-700",children:"Back"})]}),e.jsx(ae,{employees:m,accounts:h,branches:f,currencies:b,onSave:async i=>{await te.addTransaction(i),await y(),u("/app/staff")},onCancel:()=>u("/app/staff")})]})}export{oe as default};
