import{r as a,j as e,f as c,p as Z,h as G}from"./index-BjK2osQV.js";import{C as J}from"./Card-DROeE3UG.js";import{B as u}from"./Button-JCYNVMjR.js";import{I as T}from"./Input-B96Hj4QL.js";import{t as b}from"./toast-DTXa3ATd.js";const Q=({branches:x=[]})=>{const[v,R]=a.useState([]),[S,B]=a.useState([]),[K,O]=a.useState([]),[A,o]=a.useState(!1),[d,E]=a.useState(null),[D,i]=a.useState(!1),[n,f]=a.useState(null),[m,h]=a.useState(""),[j,g]=a.useState(""),[V,y]=a.useState("TUKTUK"),[L,N]=a.useState(""),[U,w]=a.useState(""),[P,C]=a.useState(""),[M,I]=a.useState(""),k=async()=>{i(!0);try{const[s,t,r]=await Promise.all([c.getEmployees(),c.getUsers(),Z.getDriverCommissionRules()]);R(s.filter(l=>l.isDriver)),B(t.filter(l=>l.role==="driver")),O(r||[])}catch(s){console.error("Load data failed",s)}finally{i(!1)}};a.useEffect(()=>{k()},[]);const $=()=>{E(null),h(""),g(""),y("TUKTUK"),N(""),w(""),C(""),I(""),o(!0)},z=s=>{E(s.id),h(s.name),g(s.phone||""),y(s.vehicleType||"TUKTUK"),N(s.vehiclePlateNumber||""),w(s.branchId||""),C(s.linkedUserId||""),I(s.zone||""),o(!0)},F=s=>{const t=s.target.value;if(C(t),t){const r=S.find(l=>l.uid===t);r&&(m||h(r.name),!j&&r.phone&&g(r.phone))}},W=async s=>{if(s.preventDefault(),!m)return;i(!0);const t=v.find(p=>p.id===d),r=(t==null?void 0:t.status)||"ACTIVE",l={id:d||`emp-${Date.now()}`,name:m.trim(),phone:j.trim(),position:(t==null?void 0:t.position)||"Driver",department:(t==null?void 0:t.department)||"Logistics",isDriver:!0,status:r,vehicleType:V,vehiclePlateNumber:L.trim(),branchId:U||null,linkedUserId:P||null,zone:M.trim()||void 0,createdAt:(t==null?void 0:t.createdAt)||Date.now()};try{d?await c.updateEmployee(l):await c.addEmployee(l),o(!1),await k(),b.success(d?"Driver updated.":"Driver profile created.")}catch(p){console.error("Save driver error:",p),b.error(`Failed to save driver: ${p.message||"Unknown error"}`)}finally{i(!1)}},q=(s,t)=>{s.preventDefault(),s.stopPropagation();const r=t.status==="INACTIVE"?"ACTIVE":"INACTIVE";f({emp:t,newStatus:r})},H=async()=>{if(!n)return;const{emp:s,newStatus:t}=n;i(!0);try{const r={...s,status:t};await c.updateEmployee(r),await k(),b.success(`Driver ${t==="ACTIVE"?"activated":"deactivated"}.`),f(null)}catch(r){console.error(r),b.error("Failed to update status")}finally{i(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Fleet Management"}),!A&&e.jsx(u,{onClick:$,children:"+ Add Driver"})]}),A&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm p-4 overflow-y-auto",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-2xl transform transition-all scale-100 my-8",children:[e.jsxs("div",{className:"p-6 border-b border-gray-100 flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:d?"Edit Driver":"New Driver Profile"}),e.jsx("button",{onClick:()=>o(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("form",{onSubmit:W,className:"space-y-4",children:[e.jsxs("div",{className:"bg-indigo-50 p-4 rounded-xl border border-indigo-100",children:[e.jsx("label",{className:"block text-sm font-bold text-indigo-900 mb-1",children:"Link to System User (App Login)"}),e.jsxs("select",{className:"block w-full px-3 py-2 border border-indigo-300 rounded-lg shadow-sm focus:ring-indigo-500 sm:text-sm",value:P,onChange:F,children:[e.jsx("option",{value:"",children:"-- No App Login (Manual Record Only) --"}),S.map(s=>e.jsxs("option",{value:s.uid,children:[s.name," (",s.email,")"]},s.uid))]}),e.jsx("p",{className:"text-xs text-indigo-700 mt-1",children:"Linking enables this driver to log in to the Driver App and receive jobs."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(T,{label:"Driver Name",value:m,onChange:s=>h(s.target.value),required:!0}),e.jsx(T,{label:"Phone",value:j,onChange:s=>g(s.target.value),required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vehicle Type"}),e.jsxs("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-indigo-500",value:V,onChange:s=>y(s.target.value),children:[e.jsx("option",{value:"MOTO",children:"Motorbike"}),e.jsx("option",{value:"TUKTUK",children:"Tuktuk"}),e.jsx("option",{value:"CAR",children:"Car/Sedan"}),e.jsx("option",{value:"TRUCK",children:"Truck/Van"})]})]}),e.jsx(T,{label:"License Plate",value:L,onChange:s=>N(s.target.value),required:!0,placeholder:"e.g. 1A-1234"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Home Branch (Warehouse)"}),e.jsxs("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-indigo-500",value:U,onChange:s=>w(s.target.value),children:[e.jsx("option",{value:"",children:"-- None / Roaming --"}),x.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Zone / Commission Rule"}),e.jsxs("select",{className:"block w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-indigo-500",value:M,onChange:s=>I(s.target.value),children:[e.jsx("option",{value:"",children:"-- Select Rule --"}),Array.from(new Set(K.map(s=>s.zoneName).filter(Boolean))).map((s,t)=>e.jsx("option",{value:s,children:s},t))]}),e.jsx("p",{className:"text-[10px] text-gray-500 mt-1",children:"Select a Commission Rule defined in Settings."})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-6 border-t border-gray-100 mt-4",children:[e.jsx(u,{variant:"outline",type:"button",onClick:()=>o(!1),children:"Cancel"}),e.jsx(u,{type:"submit",isLoading:D,children:"Save Profile"})]})]})})]})}),e.jsx(J,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[v.map(s=>{var t;return e.jsxs("div",{className:`border rounded-xl p-4 flex flex-col gap-3 hover:shadow-md transition-shadow bg-white relative ${s.status==="INACTIVE"?"border-red-200 bg-red-50/50":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[s.linkedUserId&&e.jsx("div",{className:"absolute top-2 right-2",title:"App Connected",children:e.jsxs("span",{className:"flex h-2 w-2 relative",children:[e.jsx("span",{className:`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${s.status==="INACTIVE"?"bg-gray-400":"bg-green-400"}`}),e.jsx("span",{className:`relative inline-flex rounded-full h-2 w-2 ${s.status==="INACTIVE"?"bg-gray-500":"bg-green-500"}`})]})}),e.jsxs("div",{className:`h-12 w-12 rounded-full flex items-center justify-center flex-shrink-0 ${s.status==="INACTIVE"?"bg-gray-200 text-gray-500":"bg-indigo-100 text-indigo-600"}`,children:[s.vehicleType==="MOTO"&&e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M13 10V3L4 14h7v7l9-11h-7z"})}),s.vehicleType!=="MOTO"&&e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"})})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-bold text-gray-900",children:s.name}),e.jsx("span",{className:`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${s.status==="INACTIVE"?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:s.status||"ACTIVE"})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:[s.vehicleType," â€¢ ",s.vehiclePlateNumber]}),e.jsx("p",{className:"text-xs text-indigo-600 font-medium",children:s.phone}),e.jsxs("div",{className:"flex gap-1 mt-1 flex-wrap",children:[s.branchId&&e.jsx("span",{className:"text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-600 border border-gray-200",children:((t=x.find(r=>r.id===s.branchId))==null?void 0:t.code)||"Branch"}),s.zone&&e.jsxs("span",{className:"text-[10px] bg-blue-50 px-2 py-0.5 rounded text-blue-700 border border-blue-100",children:["Rule: ",s.zone]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2 border-t border-gray-100 mt-1",onClick:r=>r.stopPropagation(),children:[e.jsx("button",{type:"button",onClick:r=>q(r,s),className:`text-xs px-2 py-1 rounded border transition-colors ${s.status==="INACTIVE"?"bg-green-50 text-green-700 border-green-200 hover:bg-green-100":"bg-red-50 text-red-700 border-red-200 hover:bg-red-100"}`,children:s.status==="INACTIVE"?"Activate":"Deactivate"}),e.jsx("button",{type:"button",onClick:()=>z(s),className:"text-xs px-2 py-1 rounded border border-indigo-200 text-indigo-700 bg-indigo-50 hover:bg-indigo-100 transition-colors",children:"Edit Profile"})]})]},s.id)}),v.length===0&&e.jsx("p",{className:"text-gray-500 col-span-3 text-center py-8",children:"No drivers registered."})]})}),n&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-all scale-100",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-2",children:["Confirm ",n.newStatus==="INACTIVE"?"Deactivation":"Activation"]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-6",children:["Are you sure you want to ",n.newStatus==="INACTIVE"?"deactivate":"activate"," ",e.jsx("strong",{children:n.emp.name}),"?",n.newStatus==="INACTIVE"&&" They will not be able to receive new job assignments."]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(u,{variant:"outline",onClick:()=>f(null),children:"Cancel"}),e.jsx(u,{onClick:H,variant:n.newStatus==="INACTIVE"?"danger":"primary",isLoading:D,children:"Confirm"})]})]})})]})};function te(){const{branches:x}=G();return e.jsx(Q,{branches:x})}export{te as default};
