import{l as X,k as ge}from"./index-BUL6LB55.js";class ye{static round2(e){return Math.round((e+Number.EPSILON)*100)/100}static async previewGLEntry(e,F){const{accounts:E,settings:t,employees:K,commissionRules:$,bookings:Z,currencies:G}=F,r=[],d=[],p=[],M=e.currency.toUpperCase();let u=1;if(M!=="USD"){const n=G.find(s=>s.code===M);u=n?n.exchangeRate:4e3}const g=Number(e.amount),f=Number((g/u).toFixed(2)),l=n=>{if(n)return E.find(s=>s.id===n)};if(e.transactionType==="DEPOSIT"){const n=l(e.bankAccountId);n||d.push(`Bank Account ${e.bankAccountId} not found`);const s=e.userRole==="driver"?e.currency==="USD"?t.driverWalletAccountUSD:t.driverWalletAccountKHR:e.currency==="USD"?t.customerWalletAccountUSD:t.customerWalletAccountKHR,a=l(s)||l(e.userRole==="driver"?t.defaultDriverWalletAccountId:t.defaultCustomerWalletAccountId);a||d.push(`${e.userRole} Wallet Liability Account not found`),n&&a&&(r.push({accountId:n.id,debit:f,credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:g,originalCredit:0,description:`Deposit via ${n.name}`}),r.push({accountId:a.id,debit:0,credit:f,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:g,description:`Wallet Credit (${e.userName})`}))}else if(e.transactionType==="WITHDRAWAL"){const n=l(e.bankAccountId);n||d.push(`Bank Account ${e.bankAccountId} not found`);const s=e.userRole==="driver"?e.currency==="USD"?t.driverWalletAccountUSD:t.driverWalletAccountKHR:e.currency==="USD"?t.customerWalletAccountUSD:t.customerWalletAccountKHR,a=l(s)||l(e.userRole==="driver"?t.defaultDriverWalletAccountId:t.defaultCustomerWalletAccountId);a||d.push(`${e.userRole} Wallet Liability Account not found`),n&&a&&(r.push({accountId:a.id,debit:f,credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:g,originalCredit:0,description:`Wallet Debit (${e.userName})`}),r.push({accountId:n.id,debit:0,credit:f,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:g,description:`Withdrawal via ${n.name}`}))}else if(e.transactionType==="SETTLEMENT")if(e.userRole==="customer"){const n=l(e.bankAccountId),s=e.currency==="USD"?t.customerWalletAccountUSD:t.customerWalletAccountKHR,a=l(s)||l(t.defaultCustomerWalletAccountId);n||d.push("Settlement Bank Account not found"),a||d.push("Customer Wallet Account not found"),n&&a&&(r.push({accountId:a.id,debit:f,credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:g,originalCredit:0,description:`Payout to ${e.userName}`}),r.push({accountId:n.id,debit:0,credit:f,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:g,description:"Settlement Payout"}))}else{const n=[];e.relatedItems&&e.relatedItems.forEach(b=>{var W;const y=Z.find(A=>A.id===b.bookingId),S=(W=y==null?void 0:y.items)==null?void 0:W.find(A=>A.id===b.itemId);y&&S&&n.push({bookingId:b.bookingId,itemId:b.itemId,item:S,booking:y})});const s=(e.description||"").toLowerCase().includes("taxi"),a=n.filter(b=>s?(b.item.taxiFeeCurrency||"USD")!==e.currency:(b.item.codCurrency||"USD")!==e.currency);if(a.length>0&&!s&&d.push(`Strict Currency Matching Block: You are settling ${e.currency} but ${a.length} items are in ${a[0].item.codCurrency}. Please create separate requests.`),d.length===0){if(s){const i=l(e.bankAccountId),o=e.currency==="USD"?t.driverWalletAccountUSD:t.driverWalletAccountKHR,c=l(o)||l(t.defaultDriverWalletAccountId),C=e.currency==="USD"?t.customerWalletAccountUSD:t.customerWalletAccountKHR,h=l(C)||l(t.defaultCustomerWalletAccountId);i||d.push("Settlement Bank Account not found"),c||d.push("Driver Wallet/Payable Account not found"),h||d.push("Customer Wallet/Receivable Account not found"),i&&c&&h&&(r.push({accountId:h.id,debit:f,credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:g,originalCredit:0,description:"Taxi Fee Receivable from Customer"}),r.push({accountId:c.id,debit:0,credit:f,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:g,description:`Taxi Fee Payable to ${e.userName}`}),r.push({accountId:c.id,debit:f,credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:g,originalCredit:0,description:"Driver Taxi Fee Payable Cleared"}),r.push({accountId:i.id,debit:0,credit:f,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:g,description:`Taxi Fee Reimbursement to ${e.userName}`}));const D=r.reduce((R,v)=>R+v.debit,0),I=r.reduce((R,v)=>R+v.credit,0);return{lines:r,errors:d,warnings:p,isValid:d.length===0,totalDebit:D,totalCredit:I,difference:D-I}}const b=l(e.bankAccountId);b?r.push({accountId:b.id,debit:f,credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:g,originalCredit:0,description:`Settlement Received from ${e.userName}`}):d.push("Settlement Bank Account not found");let y=0,S=0,W=0;const A={},_=e.currency==="USD"?t.customerWalletAccountUSD:t.customerWalletAccountKHR,H=l(_)||l(t.defaultCustomerWalletAccountId),ee=e.currency==="USD"?t.defaultRevenueAccountUSD:t.defaultRevenueAccountKHR,T=l(ee)||l(t.defaultRevenueAccountId),te=e.currency==="USD"?t.driverCommissionExpenseAccountUSD:t.driverCommissionExpenseAccountKHR,N=l(te)||E.find(i=>i.type==="Expense"&&(i.code==="601001"||i.name.includes("Commission")));H||d.push("Customer Wallet Account not found"),T||d.push("Revenue Account not found"),N||p.push("Commission Expense Account not found (using Revenue offset if needed, but not ideal)");const q=G.find(i=>i.code==="KHR"),U=q?q.exchangeRate:4e3,z=(i,o)=>{const c=e.currency;return o===c?i:o==="USD"&&c==="KHR"?i*U:o==="KHR"&&c==="USD"?i/U:i};if(n.forEach(i=>{var Q;const{booking:o,item:c}=i,C=o.currency||"USD",h=c.codCurrency||C,D=h==="KHR";let I=0,R=h;if(c.deliveryFeeUSD!==void 0||c.deliveryFeeKHR!==void 0)D?(I=c.deliveryFeeKHR||0,R="KHR"):(I=c.deliveryFeeUSD||0,R="USD");else if(c.deliveryFee!==void 0&&c.deliveryFee>0)I=Number(c.deliveryFee)||0;else if((o.totalDeliveryFee||0)>0){const x=((Q=o.items)==null?void 0:Q.length)||1;I=(o.totalDeliveryFee||0)/x,R=C}const v=this.round2(z(I,R)),oe=Number(c.productPrice)||0,ue=this.round2(z(oe,h)),k=o.driverId,J=K.find(x=>x.linkedUserId===k);let L=X(J,o,"PICKUP",$,v,e.currency,U);const O=ge(J,"PICKUP",$);O==null||O.type;const w=c.driverId||c.delivererId,le=K.find(x=>x.linkedUserId===w);let B=X(le,o,"DELIVERY",$,v,e.currency,U);k&&L>0&&(A[k]=(A[k]||0)+L),w&&B>0&&(A[w]=(A[w]||0)+B);const de=this.round2(ue-v),se=v,ae=this.round2(L+B);y+=de,S+=se,W+=ae}),H&&y>0){const i=this.round2(y/u);r.push({accountId:H.id,debit:0,credit:i,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:y,description:"COD Payable (Net)"})}if(T&&S>0){const i=this.round2(S/u);r.push({accountId:T.id,debit:0,credit:i,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:S,description:"Service Revenue (Gross)"})}if(N&&W>0){const i=this.round2(W/u);r.push({accountId:N.id,debit:i,credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:W,originalCredit:0,description:"Commission Expense"})}Object.entries(A).forEach(([i,o])=>{const c=K.find(D=>D.linkedUserId===i),C=(c==null?void 0:c.walletAccountId)||t.defaultDriverWalletAccountId,h=l(C);if(h){const D=this.round2(o/u);r.push({accountId:h.id,debit:0,credit:D,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:o,description:"Commission Credit"})}else d.push(`Wallet Account for Driver ${i} not found`)});const ie=r.reduce((i,o)=>i+(o.debit||0),0),ne=r.reduce((i,o)=>i+(o.credit||0),0),ce=r.reduce((i,o)=>i+(o.originalDebit||0),0),re=r.reduce((i,o)=>i+(o.originalCredit||0),0),m=this.round2(ie-ne),P=this.round2(ce-re);if(Math.abs(m)>.01){const i=e.userRole==="driver"?e.currency==="USD"?t.driverWalletAccountUSD:t.driverWalletAccountKHR:t.defaultDriverWalletAccountId,o=l(i)||l(t.defaultDriverWalletAccountId);if(o)if(m>0){const c=n.length===0?"Wallet Credit":"Settlement Overpayment";r.push({accountId:o.id,debit:0,credit:m,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:0,originalCredit:P,description:c})}else{const c=l(e.bankAccountId);if(c)r.push({accountId:c.id,debit:Math.abs(m),credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:Math.abs(P),originalCredit:0,description:"Taxi Fee Clearing (Reimbursed Separately)"});else{const C=n.length===0?"Wallet Debit":"Settlement Shortage";r.push({accountId:o.id,debit:Math.abs(m),credit:0,originalCurrency:e.currency,originalExchangeRate:u,originalDebit:Math.abs(P),originalCredit:0,description:C})}}else d.push("Settlement Driver Wallet Account not found")}}}const V=r.reduce((n,s)=>n+(s.debit||0),0),j=r.reduce((n,s)=>n+(s.credit||0),0),Y=this.round2(V-j);return{isValid:d.length===0&&Math.abs(Y)<.01,totalDebit:V,totalCredit:j,difference:Y,lines:r,errors:d,warnings:p}}static async createGLEntry(e,F){const E=await this.previewGLEntry(e,F);if(!E.isValid)throw new Error(`GL Generation Failed: ${E.errors.join(", ")}`);return{id:`je-${Date.now()}`,date:new Date().toISOString().split("T")[0],description:e.description||`${e.transactionType} - ${e.userName}`,reference:`REF-${Date.now().toString().slice(-6)}`,branchId:e.branchId,currency:e.currency,exchangeRate:1,lines:E.lines,status:"POSTED",createdAt:Date.now()}}}export{ye as GLBookingService};
