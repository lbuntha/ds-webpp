import{u as I,j as e,r as x,f as F}from"./index-BUL6LB55.js";import{T as O}from"./TrackingTimeline--cIDV8xm.js";import{C as K}from"./ChatModal-BSO-ygqo.js";import{t as R}from"./toast-DfW6NkLH.js";import{B as H}from"./Button-CqEssTF4.js";const P=({user:n,stats:l,onNewBooking:g})=>{const{t:a}=I();return e.jsx("div",{className:"bg-white rounded-3xl p-6 shadow-sm border border-gray-100 relative overflow-hidden",children:e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900",children:[a("hello"),", ",n.name.split(" ")[0]]}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:a("track_shipment")})]}),e.jsxs("button",{onClick:g,className:"bg-red-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg shadow-red-100 hover:bg-red-700 transition-colors flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 4v16m8-8H4"})}),a("new_order")]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mt-8",children:[e.jsxs("div",{className:"bg-gray-50 rounded-xl p-3 text-center border border-gray-100",children:[e.jsx("div",{className:"text-xl font-bold text-gray-900",children:l.activeCount}),e.jsx("div",{className:"text-[10px] uppercase tracking-wide font-medium text-gray-400",children:a("active")})]}),e.jsxs("div",{className:"bg-gray-50 rounded-xl p-3 text-center border border-gray-100",children:[e.jsx("div",{className:"text-xl font-bold text-gray-900",children:l.totalCount}),e.jsx("div",{className:"text-[10px] uppercase tracking-wide font-medium text-gray-400",children:a("total")})]}),e.jsxs("div",{className:"bg-gray-50 rounded-xl p-3 text-center border border-gray-100",children:[e.jsxs("div",{className:"text-xl font-bold text-gray-900 flex flex-col justify-center items-center",children:[l.spentUSD>0&&e.jsxs("span",{children:["$",l.spentUSD.toLocaleString(void 0,{minimumFractionDigits:2})]}),l.spentKHR>0&&e.jsxs("span",{className:l.spentUSD>0?"text-sm text-gray-600":"",children:[l.spentKHR.toLocaleString()," ៛"]}),l.spentUSD===0&&l.spentKHR===0&&e.jsx("span",{children:"$0.00"})]}),e.jsx("div",{className:"text-[10px] uppercase tracking-wide font-medium text-gray-400",children:a("spent")})]})]})]})})},$=({booking:n,derivedStatus:l,onClick:g,onCancel:a,onChat:f})=>{var u;const{t:y}=I(),p=n.items||[],N=p.length,E=(u=p[0])==null?void 0:u.image,j=s=>{if(!s)return"";const d=Date.now(),o=Math.floor((d-s)/1e3);if(o<60)return`${o}s ago`;const b=Math.floor(o/60);if(b<60)return`${b}m ago`;const h=Math.floor(b/60);return h<24?`${h}h ago`:new Date(s).toLocaleDateString()},C=s=>{const d=(s||"").toUpperCase();switch(d){case"PENDING":return e.jsx("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-gray-100 text-gray-600 border border-gray-200",children:"Pending"});case"CONFIRMED":return e.jsx("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-blue-50 text-blue-600 border border-blue-100",children:"Accepted"});case"PICKED_UP":return e.jsx("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-blue-100 text-blue-700 border border-blue-200 animate-pulse",children:"Picked Up"});case"IN_TRANSIT":return e.jsxs("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-orange-100 text-orange-700 border border-orange-200 flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-orange-500 animate-ping"})," On The Way"]});case"AT_WAREHOUSE":return e.jsx("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-indigo-100 text-indigo-700 border border-indigo-200",children:"At Warehouse"});case"OUT_FOR_DELIVERY":return e.jsxs("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-purple-100 text-purple-700 border border-purple-200 flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-purple-500 animate-pulse"})," Out for Delivery"]});case"DELIVERED":return e.jsx("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-green-100 text-green-700 border border-green-200",children:"Delivered"});case"CANCELLED":return e.jsx("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-red-100 text-red-700 border border-red-200",children:"Cancelled"});case"RETURNED":return e.jsx("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-red-100 text-red-700 border border-red-200",children:"Returned"});default:return e.jsx("span",{className:"px-2 py-1 rounded-lg text-[10px] uppercase font-bold bg-gray-100 text-gray-800 border border-gray-200",children:d})}};return e.jsxs("div",{onClick:()=>g(n),className:"bg-white rounded-2xl p-5 shadow-sm border border-gray-100 hover:border-red-100 hover:shadow-md transition-all cursor-pointer group relative overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[E?e.jsx("div",{className:"h-12 w-12 bg-gray-100 rounded-xl overflow-hidden border border-gray-200 flex-shrink-0",children:e.jsx("img",{src:E,alt:"Parcel",className:"h-full w-full object-cover"})}):e.jsx("div",{className:"h-12 w-12 bg-indigo-50 rounded-xl flex items-center justify-center text-indigo-600 group-hover:bg-red-50 group-hover:text-red-600 transition-colors",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900 text-sm",children:n.serviceTypeName}),e.jsx("p",{className:"text-xs text-gray-400",children:n.createdAt?j(n.createdAt):n.bookingDate})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[C(l),n.driverId&&e.jsxs("button",{onClick:s=>{s.stopPropagation(),f(n,p[0])},className:"flex items-center gap-1.5 bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg border border-indigo-100 hover:bg-indigo-100 hover:border-indigo-200 transition-colors shadow-sm",children:[e.jsx("svg",{className:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),e.jsx("span",{className:"text-[10px] font-bold uppercase",children:"Chat"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[p.slice(0,2).map((s,d)=>e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx("div",{className:`w-2 h-2 rounded-full mr-3 flex-shrink-0 ${s.status==="DELIVERED"?"bg-green-500":s.status==="IN_TRANSIT"?"bg-orange-500":"bg-gray-300"}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"font-medium text-gray-700 truncate",children:s.receiverName}),s.status&&s.status!=="PENDING"&&e.jsx("span",{className:`text-[10px] uppercase ${s.status==="DELIVERED"?"text-green-600":s.status==="CANCELLED"?"text-red-600":"text-gray-500"}`,children:(s.status||"").replace("_"," ")})]}),e.jsx("span",{className:"text-gray-500 truncate block text-xs",children:s.destinationAddress})]})]},d)),N>2&&e.jsxs("p",{className:"text-xs text-gray-400 pl-5",children:["+ ",N-2," more items"]})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm border-t border-gray-50 pt-3 mt-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-gray-400 font-mono text-[10px] tracking-wider",children:["#",(n.id||"").slice(-6)]}),l==="PENDING"&&e.jsx("button",{onClick:s=>{s.stopPropagation(),a(n)},className:"text-xs text-red-500 hover:text-red-700 font-medium hover:underline z-20 relative px-2 py-0.5 rounded border border-transparent hover:border-red-100 hover:bg-red-50",children:y("cancel_booking")})]}),e.jsxs("div",{className:"flex items-center font-bold text-gray-900",children:[(()=>{let s=0,d=0;if(p.forEach(o=>{if(o.codCurrency==="KHR"){const h=Number(o.deliveryFeeKHR)||Number(o.deliveryFeeUSD||o.deliveryFee)*4100;d+=h}else{const h=Number(o.deliveryFeeUSD)||Number(o.deliveryFeeKHR||o.deliveryFee)/4100;s+=h}}),s>0&&d>0)return`$${s.toFixed(2)} + ${d.toLocaleString()} ៛`;if(d>0)return`${d.toLocaleString()} ៛`;if(s===0&&d===0){const o=n.totalDeliveryFee||0,b=new Set(p.map(v=>v.codCurrency||"USD"));return b.has("KHR")&&!b.has("USD")?`${o.toLocaleString()} ៛`:`$${o.toFixed(2)}`}return`$${s.toFixed(2)}`})(),e.jsx("svg",{className:"w-4 h-4 ml-1 text-gray-300 group-hover:text-red-500 transition-colors",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5l7 7-7 7"})})]})]})]})},V=({isOpen:n,bookingId:l,onConfirm:g,onCancel:a,isLoading:f})=>{const{t:y}=I();return n?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm p-4",onClick:f?void 0:a,children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform transition-all scale-100",onClick:p=>p.stopPropagation(),children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"bg-red-100 p-3 rounded-full",children:e.jsx("svg",{className:"w-8 h-8 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})})}),e.jsxs("h3",{className:"text-xl font-bold text-gray-900 text-center mb-2",children:[y("cancel_booking"),"?"]}),e.jsxs("p",{className:"text-center text-gray-600 mb-6 text-sm",children:[y("confirm_cancel")," ",e.jsxs("strong",{children:["#",(l||"").slice(-6)]}),"?",e.jsx("br",{}),e.jsx("span",{className:"text-xs text-red-500 mt-2 block",children:"Note: If the driver is already on the way, cancellation fees may apply."})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(H,{variant:"outline",onClick:a,className:"w-full justify-center",disabled:f,children:"No, Keep"}),e.jsxs(H,{onClick:g,className:"w-full justify-center bg-red-600 hover:bg-red-700 text-white flex items-center gap-2",disabled:f,children:[f&&e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),f?"Cancelling...":"Yes, Cancel"]})]})]})}):null},J=({user:n,onNewBooking:l})=>{const{t:g}=I(),[a,f]=x.useState([]),[y,p]=x.useState(!0),[N,E]=x.useState("ACTIVE"),[j,C]=x.useState(null),[u,s]=x.useState(null),[d,o]=x.useState(!1),[b,h]=x.useState(void 0),[v,S]=x.useState(null);x.useEffect(()=>{p(!0);const t=F.subscribeToCustomerBookings(n.uid,n.linkedCustomerId,n.name,r=>{r.sort((m,c)=>(c.createdAt||0)-(m.createdAt||0)),f(r),p(!1)});return()=>t()},[n]),x.useEffect(()=>{if(j){const t=a.find(r=>r.id===j.id);t&&C(t)}},[a,j]),x.useEffect(()=>{const t=r=>{const m=r,{bookingId:c,itemId:i}=m.detail;if(c){const D=a.find(w=>w.id===c);D&&(C(D),i&&h(i))}};return window.addEventListener("open-chat-view",t),()=>window.removeEventListener("open-chat-view",t)},[a]);const k=(t,r)=>{const m=t||[];return r==="CANCELLED"?"CANCELLED":r==="PENDING"?"PENDING":r==="CONFIRMED"?"CONFIRMED":m.some(c=>c.status==="OUT_FOR_DELIVERY")?"OUT_FOR_DELIVERY":m.some(c=>c.status==="IN_TRANSIT")?"IN_TRANSIT":m.some(c=>c.status==="PICKED_UP")?"PICKED_UP":m.some(c=>c.status==="AT_WAREHOUSE")?"AT_WAREHOUSE":m.length>0&&m.every(c=>c.status==="DELIVERED")?"DELIVERED":(r||"").replace("ps-","").toUpperCase()},U=async()=>{if(u){if(u.status!=="PENDING"){R.error("This booking cannot be cancelled as it is no longer pending."),s(null);return}o(!0);try{const t={...u,status:"CANCELLED",statusId:"ps-cancelled",items:(u.items||[]).map(r=>({...r,status:"CANCELLED"})),statusHistory:[...u.statusHistory||[],{statusId:"ps-cancelled",statusLabel:"Cancelled",timestamp:Date.now(),updatedBy:n.name,notes:"Cancelled by customer"}]};await F.saveParcelBooking(t),s(null),R.success("Booking cancelled successfully.")}catch(t){console.error(t),R.error("Failed to cancel booking.")}finally{o(!1)}}},M=(t,r)=>{S({itemId:r.id,bookingId:t.id,itemName:r.receiverName,driverName:t.driverName||"Driver",driverId:t.driverId})},L=x.useMemo(()=>a.filter(t=>{if(!t)return!1;const r=k(t.items,t.status);return r!=="DELIVERED"&&r!=="CANCELLED"&&r!=="COMPLETED"&&r!=="RETURNED"}),[a]),_=x.useMemo(()=>a.filter(t=>{if(!t)return!1;const r=k(t.items,t.status);return r==="DELIVERED"||r==="CANCELLED"||r==="COMPLETED"||r==="RETURNED"}),[a]),T=N==="ACTIVE"?L:_,B=x.useMemo(()=>{let t=0,r=0;return a.forEach(m=>{(m.items||[]).forEach(i=>{const D=i.codCurrency==="KHR",w=i.status==="DELIVERED";if(w)if(i.deliveryFeeUSD!==void 0||i.deliveryFeeKHR!==void 0)D?r+=i.deliveryFeeKHR||0:t+=i.deliveryFeeUSD||0;else{const A=i.deliveryFee||0;D?r+=A:t+=A}w&&i.isTaxiDelivery&&i.taxiFee&&i.taxiFee>0&&(i.taxiFeeCurrency==="KHR"?r+=i.taxiFee:t+=i.taxiFee)})}),{activeCount:L.length,totalCount:a.length,spentUSD:t,spentKHR:r}},[a,L]);return e.jsxs("div",{className:"space-y-6",children:[e.jsx(P,{user:n,onNewBooking:l,stats:B}),e.jsxs("div",{className:"flex space-x-6 border-b border-gray-200 px-2",children:[e.jsx("button",{className:`pb-3 text-sm font-medium transition-all ${N==="ACTIVE"?"text-red-600 border-b-2 border-red-600":"text-gray-400 hover:text-gray-600"}`,onClick:()=>E("ACTIVE"),children:g("active_orders")}),e.jsx("button",{className:`pb-3 text-sm font-medium transition-all ${N==="HISTORY"?"text-red-600 border-b-2 border-red-600":"text-gray-400 hover:text-gray-600"}`,onClick:()=>E("HISTORY"),children:g("history")})]}),e.jsx("div",{className:"space-y-4 pb-20",children:y?e.jsxs("div",{className:"text-center py-10 text-gray-400 flex flex-col items-center",children:[e.jsx("div",{className:"w-6 h-6 border-2 border-gray-200 border-t-red-600 rounded-full animate-spin mb-2"}),g("loading")]}):T.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300",children:e.jsx("svg",{className:"w-8 h-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"1.5",d:"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"})})}),e.jsxs("p",{className:"text-gray-900 font-medium",children:["No ",N.toLowerCase()," shipments"]}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Any new bookings will appear here."})]}):T.map(t=>e.jsx($,{booking:t,derivedStatus:k(t.items,t.status),onClick:C,onCancel:s,onChat:M},t.id))}),j&&e.jsx(O,{booking:j,currentUser:n,initialChatItemId:b,onClose:()=>{C(null),h(void 0)}}),e.jsx(V,{isOpen:!!u,bookingId:(u==null?void 0:u.id)||"",onConfirm:U,onCancel:()=>s(null),isLoading:d}),v&&e.jsx(K,{itemId:v.itemId,bookingId:v.bookingId,itemName:v.itemName,recipientName:v.driverName,recipientId:v.driverId,currentUser:n,onClose:()=>S(null)})]})};export{J as C};
