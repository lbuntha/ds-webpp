import{r as c,j as e,f as m}from"./index-BUL6LB55.js";import{C as S}from"./Card-k44aVk4n.js";import{B as V}from"./Button-CqEssTF4.js";import{I as M}from"./Input-fEXGFBn-.js";import{t as D}from"./toast-DfW6NkLH.js";const Q=()=>{const[v,k]=c.useState([]),[y,w]=c.useState([]),[f,U]=c.useState([]),[W,F]=c.useState([]),[u,R]=c.useState(null),[L,N]=c.useState(!1),[x,P]=c.useState(""),[h,T]=c.useState(""),[g,H]=c.useState(""),[p,K]=c.useState("ALL");c.useEffect(()=>{(async()=>{N(!0);try{const[r,s,a,o,n]=await Promise.all([m.getParcelBookings(),m.getCustomers(),m.getUsers(),m.walletService.getAllWalletTransactions(),m.getSettings()]);k(r),w(s),U(a),F(o),R(n)}catch(r){console.error(r),D.error("Failed to load data")}finally{N(!1)}})()},[]);const I=(t,r)=>{if(t){const s=y.find(a=>a.id===t);if(s!=null&&s.linkedUserId){const a=f.find(o=>o.uid===s.linkedUserId);if(a)return a.name}if(s!=null&&s.name)return s.name}return r||"Unknown"},A=(t,r)=>{if(t){const s=y.find(a=>a.id===t);if(s!=null&&s.linkedUserId){const a=f.find(o=>o.uid===s.linkedUserId);if(a!=null&&a.phone)return a.phone}if(s!=null&&s.phone)return s.phone}return r||""},b=c.useMemo(()=>{const t=[];return v.forEach(r=>{(r.items||[]).forEach(s=>{var a;if(s.customerSettlementStatus==="SETTLED"){const o=Number(s.productPrice)||0,n=s.codCurrency||"USD",j=Number(r.totalDeliveryFee)||0,$=((a=r.items)==null?void 0:a.length)||1;let i=j/$,O=n;const C=(u==null?void 0:u.commissionExchangeRate)||4100;n==="KHR"&&(r.currency==="USD"||!r.currency)?i=i*C:n==="USD"&&r.currency==="KHR"&&(i=i/C);const B=o-i;t.push({bookingId:r.id,itemId:s.id,trackingCode:s.trackingCode||s.id.slice(-6).toUpperCase(),customerName:I(r.senderId,r.senderName),customerPhone:A(r.senderId,r.senderPhone),receiverName:s.receiverName,receiverPhone:s.receiverPhone||"",deliveryDate:r.bookingDate,codAmount:o,codCurrency:n,fee:i,feeCurrency:O,netPayout:B})}})}),t.sort((r,s)=>s.deliveryDate.localeCompare(r.deliveryDate)),t},[v,y,f,u]),d=c.useMemo(()=>b.filter(t=>{const r=x.toLowerCase(),s=!x||t.trackingCode.toLowerCase().includes(r)||t.customerName.toLowerCase().includes(r)||t.receiverName.toLowerCase().includes(r)||t.customerPhone.includes(x),a=!h||t.deliveryDate>=h,o=!g||t.deliveryDate<=g,n=p==="ALL"||t.codCurrency===p;return s&&a&&o&&n}),[b,x,h,g,p]),l=c.useMemo(()=>{let t=0,r=0,s=0,a=0;return d.forEach(o=>{o.codCurrency==="USD"?t+=o.codAmount:r+=o.codAmount,o.feeCurrency==="USD"?s+=o.fee:a+=o.fee}),{totalCodUSD:t,totalCodKHR:r,totalFeeUSD:s,totalFeeKHR:a,netUSD:t-s,netKHR:r-a,count:d.length}},[d]),E=()=>{const t=["Date","Tracking Code","Customer","Customer Phone","Receiver","COD Amount","COD Currency","Fee","Fee Currency","Net Payout"],r=d.map(n=>[n.deliveryDate,n.trackingCode,n.customerName,n.customerPhone,n.receiverName,n.codAmount.toFixed(2),n.codCurrency,n.fee.toFixed(2),n.feeCurrency,n.netPayout.toFixed(2)]),s=[t.join(","),...r.map(n=>n.map(j=>`"${j}"`).join(","))].join(`
`),a=new Blob([s],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");o.href=URL.createObjectURL(a),o.download=`settled_parcels_${new Date().toISOString().split("T")[0]}.csv`,o.click(),D.success("Exported successfully!")};return L?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Settled Parcels Report"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"View all parcels that have been settled and paid out"})]}),e.jsxs(V,{onClick:E,variant:"secondary",className:"text-sm",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Export CSV"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-100 shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500 uppercase font-bold",children:"Total Items"}),e.jsx("div",{className:"text-2xl font-black text-gray-900 mt-1",children:l.count})]}),e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-100 shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500 uppercase font-bold",children:"Total COD"}),e.jsxs("div",{className:"text-lg font-bold text-green-600 mt-1",children:["$",l.totalCodUSD.toFixed(2)]}),l.totalCodKHR>0&&e.jsxs("div",{className:"text-sm text-blue-600",children:[l.totalCodKHR.toLocaleString()," ៛"]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-100 shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500 uppercase font-bold",children:"Total Fees"}),e.jsxs("div",{className:"text-lg font-bold text-amber-600 mt-1",children:["$",l.totalFeeUSD.toFixed(2)]}),l.totalFeeKHR>0&&e.jsxs("div",{className:"text-sm text-amber-500",children:[l.totalFeeKHR.toLocaleString()," ៛"]})]}),e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-gray-100 shadow-sm",children:[e.jsx("div",{className:"text-xs text-gray-500 uppercase font-bold",children:"Net Payouts"}),e.jsxs("div",{className:"text-lg font-bold text-indigo-600 mt-1",children:["$",l.netUSD.toFixed(2)]}),l.netKHR!==0&&e.jsxs("div",{className:"text-sm text-indigo-500",children:[l.netKHR.toLocaleString()," ៛"]})]})]}),e.jsx(S,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-xs font-bold text-gray-700 mb-1",children:"Search"}),e.jsx(M,{placeholder:"Tracking code, customer, receiver...",value:x,onChange:t=>P(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-700 mb-1",children:"From Date"}),e.jsx("input",{type:"date",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",value:h,onChange:t=>T(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-700 mb-1",children:"To Date"}),e.jsx("input",{type:"date",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",value:g,onChange:t=>H(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-bold text-gray-700 mb-1",children:"Currency"}),e.jsxs("select",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",value:p,onChange:t=>K(t.target.value),children:[e.jsx("option",{value:"ALL",children:"All Currencies"}),e.jsx("option",{value:"USD",children:"USD Only"}),e.jsx("option",{value:"KHR",children:"KHR Only"})]})]})]})}),e.jsx(S,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Tracking"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Customer"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Receiver"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"COD Amount"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Fee"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Net Payout"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:d.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-sm text-gray-500",children:"No settled parcels found."})}):d.map((t,r)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:t.deliveryDate}),e.jsx("td",{className:"px-4 py-3 text-sm font-mono text-indigo-600",children:t.trackingCode}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.customerName}),e.jsx("div",{className:"text-xs text-gray-500",children:t.customerPhone})]}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"text-sm text-gray-900",children:t.receiverName}),e.jsx("div",{className:"text-xs text-gray-500",children:t.receiverPhone})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-right font-medium",children:e.jsxs("span",{className:t.codCurrency==="USD"?"text-green-600":"text-blue-600",children:[t.codCurrency==="USD"?"$":"",t.codAmount.toLocaleString(),t.codCurrency==="KHR"?" ៛":""]})}),e.jsxs("td",{className:"px-4 py-3 text-sm text-right text-amber-600",children:[t.feeCurrency==="USD"?"$":"",t.fee.toFixed(2),t.feeCurrency==="KHR"?" ៛":""]}),e.jsxs("td",{className:"px-4 py-3 text-sm text-right font-bold text-gray-900",children:[t.codCurrency==="USD"?"$":"",t.netPayout.toLocaleString(),t.codCurrency==="KHR"?" ៛":""]})]},`${t.bookingId}-${t.itemId}`))})]})})})]})};export{Q as SettledParcelsReport};
