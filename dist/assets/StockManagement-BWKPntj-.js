import{b as ee,h as te,r as c,s as g,j as e}from"./index-BUL6LB55.js";import{t as m}from"./toast-DfW6NkLH.js";import{P as L}from"./package-BdetSlVF.js";import{P as B}from"./plus-rnI6Vdzr.js";import{S as se}from"./search-DTZoH1GY.js";import{C as ae,a as re}from"./chevron-up-DSgXiHgz.js";import{T as le}from"./triangle-alert-caMmt7Ek.js";import{P as ne,T as ce}from"./trash-2-CYr50t1o.js";import{X as R,C as U}from"./x-C56ZNX5h.js";import{C as ie}from"./camera-zNyZa9TX.js";import"./createLucideIcon-CEuAjdeA.js";const Ne=()=>{const{user:l}=ee(),{branches:p,customers:b}=te(),[y,F]=c.useState([]),[S,M]=c.useState([]),[o,k]=c.useState(""),[O,I]=c.useState(!0),[j,Q]=c.useState(""),[v,z]=c.useState("inventory"),[P,K]=c.useState(new Set),[_,f]=c.useState(!1),[$,N]=c.useState(!1),[i,x]=c.useState({customerId:"",customerName:"",items:[{productName:"",quantity:1}],notes:""}),[n,u]=c.useState(null),[A,D]=c.useState(!1);c.useEffect(()=>{w()},[o,p,b]);const w=async()=>{I(!0);try{if(!o&&p.length>0){const t=(l==null?void 0:l.managedBranchId)||p[0].id;k(t);return}if(o){const t=await g.getStocksByBranch(o);F(t);const s=await g.getStockTransactions(void 0,o,50);M(s)}}catch(t){console.error("Error loading stock data:",t)}finally{I(!1)}},E=c.useMemo(()=>{if(!j)return y;const t=j.toLowerCase();return y.filter(s=>s.customerName.toLowerCase().includes(t)||s.items.some(a=>{var r;return a.productName.toLowerCase().includes(t)||((r=a.sku)==null?void 0:r.toLowerCase().includes(t))}))},[y,j]),G=t=>{K(s=>{const a=new Set(s);return a.has(t)?a.delete(t):a.add(t),a})},V=async()=>{var s;if(!i.customerId||i.items.some(a=>!a.productName||a.quantity<1)){m.warning("Please fill in all required fields");return}const t=((s=p.find(a=>a.id===o))==null?void 0:s.name)||"";D(!0);try{const a=await Promise.all(i.items.filter(r=>r.productName&&r.quantity>0).map(async r=>{let d=r.image;return r.image&&r.image.startsWith("data:")&&(d=await g.uploadImage(r.image)),{productName:r.productName,quantity:r.quantity,sku:r.sku,unitPrice:r.unitPrice,unitPriceCurrency:r.unitPriceCurrency,description:r.description,image:d}}));await g.depositStock(i.customerId,i.customerName,o,t,a,(l==null?void 0:l.uid)||"",(l==null?void 0:l.name)||"",i.notes),f(!1),x({customerId:"",customerName:"",items:[{productName:"",quantity:1}],notes:""}),m.success("Stock received successfully!"),w()}catch(a){console.error("Error depositing stock:",a),m.error("Failed to deposit stock. Please try again.")}finally{D(!1)}},W=(t,s)=>{var d;const a=(d=s.target.files)==null?void 0:d[0];if(!a)return;const r=new FileReader;r.onload=C=>{var T;const Z=(T=C.target)==null?void 0:T.result;h(t,"image",Z)},r.readAsDataURL(a)},H=async()=>{if(!n||!n.reason.trim()){m.warning("Please provide a reason for the adjustment");return}const t=y.find(s=>s.id===n.stockId);if(t)try{const s=await g.adjustStock(t.customerId,t.branchId,n.itemId,n.adjustment,n.reason,(l==null?void 0:l.uid)||"",(l==null?void 0:l.name)||"");if(!s.success){m.error(s.error||"Adjustment failed");return}N(!1),u(null),m.success("Stock adjusted successfully!"),w()}catch(s){console.error("Error adjusting stock:",s),m.error("Failed to adjust stock. Please try again.")}},J=()=>{x(t=>({...t,items:[...t.items,{productName:"",quantity:1}]}))},X=t=>{x(s=>({...s,items:s.items.filter((a,r)=>r!==t)}))},h=(t,s,a)=>{x(r=>({...r,items:r.items.map((d,C)=>C===t?{...d,[s]:a}:d)}))},q=t=>new Date(t).toLocaleString(),Y=t=>{switch(t){case"DEPOSIT":return"bg-green-100 text-green-800";case"BOOKING_RESERVE":return"bg-blue-100 text-blue-800";case"BOOKING_DELIVERED":return"bg-purple-100 text-purple-800";case"BOOKING_CANCELLED":return"bg-orange-100 text-orange-800";case"ADJUSTMENT":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}};return O?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Stock Management"}),e.jsx("p",{className:"text-gray-500",children:"Manage customer product inventory"})]})]}),e.jsxs("button",{onClick:()=>f(!0),className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:[e.jsx(B,{className:"w-5 h-5"}),"Receive Stock"]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsx("div",{className:"flex gap-2",children:["inventory","history"].map(t=>e.jsx("button",{onClick:()=>z(t),className:`px-4 py-2 rounded-lg font-medium capitalize transition-colors ${v===t?"bg-red-600 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:t==="inventory"?"Inventory":"Transaction History"},t))}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("select",{value:o,onChange:t=>k(t.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:p.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))}),e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search customer or product...",value:j,onChange:t=>Q(t.target.value),className:"pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-64"})]})]})]}),v==="inventory"&&e.jsx("div",{className:"space-y-4",children:E.length===0?e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-lg",children:[e.jsx(L,{className:"w-12 h-12 mx-auto text-gray-400 mb-3"}),e.jsx("p",{className:"text-gray-500",children:"No stock found at this location"})]}):E.map(t=>e.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 overflow-hidden",children:[e.jsxs("button",{onClick:()=>G(t.id),className:"w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-blue-600 font-semibold",children:t.customerName[0]})}),e.jsxs("div",{className:"text-left",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:t.customerName}),e.jsxs("p",{className:"text-sm text-gray-500",children:[t.items.length," products â€¢ ",t.totalItemCount," total units"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["Updated ",q(t.lastUpdated)]}),P.has(t.id)?e.jsx(ae,{className:"w-5 h-5 text-gray-400"}):e.jsx(re,{className:"w-5 h-5 text-gray-400"})]})]}),P.has(t.id)&&e.jsx("div",{className:"border-t border-gray-200",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Product"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"SKU"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Quantity"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Reserved"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Available"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Unit Price"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:t.items.map(s=>{const a=s.quantity-s.reservedQuantity,r=a<=10;return e.jsxs("tr",{className:r?"bg-red-50":"",children:[e.jsxs("td",{className:"px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsx(le,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"font-medium text-gray-900",children:s.productName})]}),s.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.description})]}),e.jsx("td",{className:"px-4 py-3 text-gray-500",children:s.sku||"-"}),e.jsx("td",{className:"px-4 py-3 text-right font-medium",children:s.quantity}),e.jsx("td",{className:"px-4 py-3 text-right text-orange-600",children:s.reservedQuantity}),e.jsx("td",{className:`px-4 py-3 text-right font-semibold ${r?"text-red-600":"text-green-600"}`,children:a}),e.jsx("td",{className:"px-4 py-3 text-right",children:s.unitPrice?`${s.unitPrice} ${s.unitPriceCurrency||"USD"}`:"-"}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("button",{onClick:()=>{u({stockId:t.id,itemId:s.id,productName:s.productName,currentQty:s.quantity,adjustment:0,reason:""}),N(!0)},className:"p-1 text-gray-400 hover:text-blue-600 transition-colors",title:"Adjust Stock",children:e.jsx(ne,{className:"w-4 h-4"})})})]},s.id)})})]})})]},t.id))}),v==="history"&&e.jsx("div",{className:"bg-white rounded-lg shadow border border-gray-200 overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Customer"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Type"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Items"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"By"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Notes"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:S.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-4 py-8 text-center text-gray-500",children:"No transactions found"})}):S.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:q(t.createdAt)}),e.jsx("td",{className:"px-4 py-3 font-medium text-gray-900",children:t.customerName}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${Y(t.type)}`,children:t.type.replace(/_/g," ")})}),e.jsx("td",{className:"px-4 py-3",children:t.items.map((s,a)=>e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:s.productName}),e.jsxs("span",{className:s.quantityChange>=0?"text-green-600":"text-red-600",children:[" ","(",s.quantityChange>=0?"+":"",s.quantityChange,")"]})]},a))}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:t.createdByName}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:t.notes||"-"})]},t.id))})]})}),_&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Receive Stock Deposit"}),e.jsx("button",{onClick:()=>f(!1),className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(R,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer *"}),e.jsxs("select",{value:i.customerId,onChange:t=>{const s=b.find(a=>a.id===t.target.value);x(a=>({...a,customerId:t.target.value,customerName:(s==null?void 0:s.name)||""}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select customer..."}),b.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Items *"}),e.jsxs("button",{onClick:J,className:"text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1",children:[e.jsx(B,{className:"w-4 h-4"})," Add Item"]})]}),e.jsx("div",{className:"space-y-3",children:i.items.map((t,s)=>e.jsxs("div",{className:"flex gap-3 items-start",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",placeholder:"Product name *",value:t.productName,onChange:a=>h(s,"productName",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"w-24",children:e.jsx("input",{type:"number",placeholder:"Qty *",value:t.quantity,min:1,onChange:a=>h(s,"quantity",parseInt(a.target.value)||1),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"w-28",children:e.jsx("input",{type:"text",placeholder:"SKU",value:t.sku||"",onChange:a=>h(s,"sku",a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})}),e.jsx("div",{className:"w-24",children:e.jsx("input",{type:"number",placeholder:"Price",value:t.unitPrice||"",onChange:a=>h(s,"unitPrice",parseFloat(a.target.value)||void 0),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"cursor-pointer p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",children:[e.jsx(ie,{className:"w-4 h-4 text-gray-600"}),e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:a=>W(s,a)})]}),t.image&&e.jsx("img",{src:t.image,alt:"Preview",className:"w-8 h-8 rounded object-cover border border-gray-300"})]}),i.items.length>1&&e.jsx("button",{onClick:()=>X(s),className:"p-2 text-red-500 hover:bg-red-50 rounded",children:e.jsx(ce,{className:"w-4 h-4"})})]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:i.notes||"",onChange:t=>x(s=>({...s,notes:t.target.value})),placeholder:"Optional notes...",rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 p-4 border-t",children:[e.jsx("button",{onClick:()=>f(!1),className:"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:"Cancel"}),e.jsx("button",{onClick:V,disabled:A,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:A?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-4 h-4"}),"Receive Stock"]})})]})]})}),$&&n&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Adjust Stock"}),e.jsx("button",{onClick:()=>{N(!1),u(null)},className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(R,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsx("p",{className:"font-medium text-gray-900",children:n.productName}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Current quantity: ",n.currentQty]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Adjustment Amount *"}),e.jsx("input",{type:"number",value:n.adjustment,onChange:t=>u(s=>s?{...s,adjustment:parseInt(t.target.value)||0}:null),placeholder:"Enter + to add, - to subtract",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["New quantity: ",n.currentQty+n.adjustment]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason *"}),e.jsx("textarea",{value:n.reason,onChange:t=>u(s=>s?{...s,reason:t.target.value}:null),placeholder:"Explain the reason for adjustment...",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 p-4 border-t",children:[e.jsx("button",{onClick:()=>{N(!1),u(null)},className:"px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:"Cancel"}),e.jsxs("button",{onClick:H,disabled:!n.reason.trim(),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4"}),"Apply Adjustment"]})]})]})})]})};export{Ne as StockManagement,Ne as default};
