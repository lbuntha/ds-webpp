import{r as l,R as se,j as a,J,K as ne,L as ie,M as re,N as oe,O as le,P as ce,m as P,n as u,q as N,w as j,o as S,Q as U,H as v,S as de,U as pe,V as me}from"./index-BUL6LB55.js";const V="123456",M="migrationApp",he=()=>{const[L,X]=l.useState(null),[f,F]=l.useState([]),[i,R]=l.useState([]),[K,C]=l.useState([]),[m,T]=l.useState(!1),[B,I]=l.useState(0),[x,O]=l.useState(""),[y,$]=l.useState("");se.useEffect(()=>{if(f.length===0)return;let t=[...f];if(y){const s=y.toLowerCase();t=t.filter(e=>(e.user_name||"").toLowerCase().includes(s)||(e.full_name||e.name||"").toLowerCase().includes(s)||(e.phone||e.phoneNumber||"").includes(y))}x&&typeof x=="number"&&x>0&&(t=t.slice(0,x)),G(t)},[f,x,y]);const G=t=>{R(t),C(t.map(s=>({phone:s.user_name||s.phone||s.phoneNumber||"Unknown",name:s.full_name||s.name||"Unknown",status:"PENDING"}))),I(0)},H=t=>{t.target.files&&t.target.files[0]&&(X(t.target.files[0]),F([]),O(""),$(""),R([]),C([]),I(0))},Q=async()=>{if(!L)return;const t=await L.text();try{const s=JSON.parse(t);Array.isArray(s)?F(s):alert("Invalid JSON format. Expected an array of users.")}catch{alert("Error parsing JSON file.")}},Y=()=>{let t;const e=J().find(d=>d.name===M);return e?t=e:t=de(pe.firebase,M),me(t)},Z=async(t,s)=>{const e=t.user_name||t.phone||t.phoneNumber||"",d=t.full_name||t.name||"Unknown User",h=t._id;if(!e){c(s,"SKIPPED","Missing phone number");return}const E=ie(e),w=re(E);try{const b=Y();let n;try{const r=await oe(b,w,V);n=r.user.uid,await le(r.user,{displayName:d})}catch(r){if(r.code==="auth/email-already-in-use"){c(s,"EXISTS","User already exists in Auth. Attempting recovery...");try{n=(await ce(b,w,V)).user.uid,c(s,"EXISTS",`Recovered UID via Sign In: ${n}`)}catch(z){console.warn("Sign In Recovery Failed:",z);const A=P(u,"users");let p=N(A,j("phone","==",e)),o=await S(p);if(o.empty&&!e.startsWith("0")){const ae="0"+e;p=N(A,j("phone","==",ae)),o=await S(p)}let _=e;if(e.startsWith("0")?_="+855"+e.substring(1):e.startsWith("+")||(_="+855"+e),o.empty&&(p=N(A,j("phone","==",_)),o=await S(p)),o.empty&&(p=N(A,j("email","==",w)),o=await S(p)),!o.empty)n=o.docs[0].id,c(s,"EXISTS",`Found existing profile UID: ${n}. Updating...`);else{c(s,"FAILED","Auth exists but Firestore profile not found. Cannot update.");return}}}else throw r}if(!n)return;const D=t.joinedAt||t.createdAt||Date.now(),te=t.lastLogin||Date.now(),W={uid:n,name:d,email:w,phone:E,role:"customer",status:"APPROVED",authMethod:"phone",joinedAt:D,lastLogin:te,isOnline:!!t.isOnline,mongoId:h,address:t.address_line||"",hasPin:!0,created_date:new Date(D),updated_date:new Date};t.photo&&(W.photo=t.photo),await U(v(u,"users",n),W,{merge:!0});let g;const q=await S(N(P(u,"users"),j("uid","==",n)));q.empty||(g=q.docs[0].data().linkedCustomerId),g||(g=v(P(u,"customers")).id,await U(v(u,"users",n),{linkedCustomerId:g},{merge:!0}));const k={id:g,name:d,email:w,phone:E,status:"ACTIVE",linkedUserId:n,createdAt:D,mongoId:h,address:t.address_line||"",referralCode:t.referralCode||""};if(t.photo&&(k.photo=t.photo),t.lastLocation&&t.lastLocation.latitude&&t.lastLocation.longitude){const r={name:"Last Known Location",address:t.address_line||"Unknown Address",lat:t.lastLocation.latitude,lng:t.lastLocation.longitude,timestamp:t.lastLocation.timestamp||Date.now()};k.savedLocations=[r]}t.bank&&(k.bankAccounts=[{id:"default",bankName:t.bank.bank_name||"",accountName:t.bank.account_name||"",accountNumber:t.bank.account_number||"",qrCode:t.bank.qr_code||""}]),await U(v(u,"customers",g),k,{merge:!0}),c(s,"SUCCESS","Migrated successfully")}catch(b){console.error("Migration Error:",b),c(s,"FAILED",b.message)}},c=(t,s,e)=>{C(d=>{const h=[...d];return h[t]={...h[t],status:s,message:e},h})},ee=async()=>{if(i.length===0)return;T(!0);let t=0;for(let e=0;e<i.length;e++)await Z(i[e],e),t++,I(Math.round(t/i.length*100));T(!1),alert("Migration Complete!");const s=J().find(e=>e.name===M);s&&ne(s)};return a.jsxs("div",{className:"p-6 max-w-6xl mx-auto space-y-6",children:[a.jsx("h1",{className:"text-2xl font-bold",children:"Migration Dashboard (MongoDB to Firebase)"}),a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow space-y-4",children:[a.jsx("div",{className:"flex gap-4 items-end",children:a.jsxs("div",{className:"flex-1",children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Select users.json"}),a.jsx("input",{type:"file",accept:".json",onChange:H,className:"block w-full border rounded p-2"})]})}),f.length>0&&a.jsxs("div",{className:"flex gap-4 items-end bg-gray-50 p-4 rounded border",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Search (Name/Phone)"}),a.jsx("input",{type:"text",value:y,onChange:t=>$(t.target.value),disabled:m,placeholder:"Filter by name or phone...",className:"block w-full border rounded p-2"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Limit (Top N)"}),a.jsx("input",{type:"number",value:x,onChange:t=>O(t.target.value?parseInt(t.target.value):""),disabled:m,placeholder:"All",className:"block w-full border rounded p-2"})]}),a.jsxs("div",{className:"flex-none pb-2 text-sm text-gray-600 font-medium",children:["Showing ",i.length," of ",f.length," users"]})]}),a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx("button",{onClick:Q,disabled:!L||m,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50",children:"Reload Data"}),a.jsx("button",{onClick:ee,disabled:i.length===0||m,className:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50",children:m?"Migrating...":`Start Migration (${i.length})`})]}),m&&a.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:a.jsx("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:`${B}%`}})})]}),i.length>0&&a.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:a.jsx("div",{className:"max-h-[600px] overflow-auto",children:a.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[a.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"#"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Bank Info"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Address"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Ref Code"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Joined At"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Last Login"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Location"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Mongo ID"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Message"})]})}),a.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:K.map((t,s)=>{const e=i[s];return a.jsxs("tr",{className:t.status==="SUCCESS"?"bg-green-50":t.status==="FAILED"?"bg-red-50":t.status==="EXISTS"?"bg-yellow-50":"",children:[a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s+1}),a.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center gap-2",children:[(e==null?void 0:e.photo)&&a.jsx("img",{src:e.photo,alt:"",className:"w-8 h-8 rounded-full object-cover"}),t.name]}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.phone}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e!=null&&e.bank?a.jsxs("div",{className:"text-xs",children:[a.jsx("div",{className:"font-bold",children:e.bank.bank_name}),a.jsx("div",{children:e.bank.account_number}),a.jsx("div",{className:"text-gray-400",children:e.bank.account_name})]}):"-"}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-[150px]",title:e==null?void 0:e.address_line,children:(e==null?void 0:e.address_line)||"-"}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:(e==null?void 0:e.referralCode)||"-"}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e!=null&&e.joinedAt||e!=null&&e.createdAt?new Date((e==null?void 0:e.joinedAt)||(e==null?void 0:e.createdAt)).toLocaleDateString():"-"}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e!=null&&e.lastLogin?new Date(e.lastLogin).toLocaleDateString():"-"}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-xs",children:e!=null&&e.lastLocation?`${e.lastLocation.latitude.toFixed(4)}, ${e.lastLocation.longitude.toFixed(4)}`:"-"}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-400 font-mono text-xs",children:e==null?void 0:e._id}),a.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-bold",children:a.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                                    ${t.status==="SUCCESS"?"bg-green-100 text-green-800":t.status==="FAILED"?"bg-red-100 text-red-800":t.status==="EXISTS"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:t.status})}),a.jsx("td",{className:"px-6 py-4 text-sm text-gray-500",children:t.message})]},s)})})]})})})]})};export{he as default};
