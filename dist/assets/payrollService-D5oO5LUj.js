import{E as N,G as O,H as U,m as f,q as L,w as D,o as S,n as J,I as Q}from"./index-BUL6LB55.js";class V extends N{constructor(s,n){super(s,n)}async getPayrollSummary(s,n,r){var o;try{let a={standardWorkingDays:26,latenessDeductionAmount:1};try{const t=await O(U(this.db,"settings","payroll"));if(t.exists()){const i=t.data();a={standardWorkingDays:i.standardWorkingDays||26,latenessDeductionAmount:i.latenessDeductionAmount||1}}}catch(t){console.warn("Config fetch failed",t)}const d=f(this.db,"staff_transactions"),l=L(d,D("status","==","PENDING_PAYROLL")),g=(await S(l)).docs.map(t=>({id:t.id,...t.data()})).filter(t=>t.date>=s&&t.date<=n).filter(t=>["ALLOWANCE","DEDUCTION"].includes(t.type)),$=f(this.db,"wallet_transactions"),M=L($,D("type","==","EARNING")),W=(await S(M)).docs.map(t=>({id:t.id,...t.data()})).filter(t=>t.isSettled!==!0),h=(o=(await S(f(this.db,"currencies"))).docs.find(t=>t.data().code==="KHR"))==null?void 0:o.data(),G=(h==null?void 0:h.exchangeRate)||4e3,H=f(this.db,"daily_attendance"),K=L(H,D("date",">=",s),D("date","<=",n)),R=(await S(K)).docs.map(t=>t.data()),k=R.filter(t=>t.status==="MISSING_CLOCK_OUT"),b=r.map(t=>{const i=g.filter(e=>e.employeeId===t.id),u=i.filter(e=>e.type==="ALLOWANCE"),T=i.filter(e=>e.type==="DEDUCTION"),w=W.filter(e=>e.userId===t.linkedUserId&&e.date>=s&&e.date<=n);let c=0,m=0,I=0;w.forEach(e=>{e.currency==="KHR"?(m+=e.amount,c+=e.amount/G):(I+=e.amount,c+=e.amount)}),c=Math.round(c*100)/100;const _=[...u.map(e=>({description:e.description||e.category,amount:e.amount,type:"EARNING"}))];if(c>0){let e=`Commissions (${w.length})`;m>0&&I>0?e+=` - $${I.toLocaleString()} + ${m.toLocaleString()} KHR`:m>0&&(e+=` - ${m.toLocaleString()} KHR`),_.push({description:e,amount:c,type:"EARNING"})}const Y=T.map(e=>({description:e.description||e.category,amount:e.amount,type:"DEDUCTION"})),z=new Date(s),F=new Date(n),B=Math.abs(F.getTime()-z.getTime()),A=Math.ceil(B/(1e3*60*60*24));let y=1;const j=a.standardWorkingDays;A<j-4&&(y=A/30,A<=16?y=.5:y=1);const C=t.baseSalaryAmount||t.salary||0,P=C*y,v=u.reduce((e,E)=>e+E.amount,0),x=T.reduce((e,E)=>e+E.amount,0);return{employeeId:t.id,employeeName:t.name,baseSalary:C,proRatedSalary:P,currency:"USD",earnings:_,deductions:Y,totalAllowances:v,totalCommissions:c,totalDeductions:x,netPay:P+v+c-x,transactionIds:i.map(e=>e.id),walletTxnIds:w.map(e=>e.id)}}),q=R.filter(t=>t.status==="LATE").filter(t=>!g.some(u=>u.employeeId===t.employeeId&&u.date===t.date&&(u.category==="LATENESS"||u.category==="LATE")));return{pendingTxns:g,attendanceIssues:k,unprocessedLateness:q,draftPayslips:b,summary:{totalStaff:r.length,totalNetPay:b.reduce((t,i)=>t+i.netPay,0)}}}catch(a){throw console.error("Error summarizing payroll:",a),a}}async createLatenessDeductions(s){const n=new N(this.db,this.storage);let r=1;try{const a=await O(U(this.db,"settings","payroll"));if(a.exists()){const d=a.data();d.latenessDeductionAmount&&(r=d.latenessDeductionAmount)}}catch(a){console.warn("Using default lateness amount",a)}const o=s.map(a=>({id:`ded-late-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,employeeId:a.employeeId,employeeName:a.employeeName,type:"DEDUCTION",category:"LATENESS",amount:r,currency:"USD",date:a.date,description:`Late Arrival on ${a.date}`,status:"PENDING_PAYROLL",branchId:"HEAD_OFFICE",createdAt:Date.now(),createdBy:"SYSTEM"}));for(const a of o)await n.saveDocument("staff_transactions",a);return o.length}async finalizeRun(s,n,r,o){try{const a=s.id||`run-${Date.now()}`;await this.saveDocument("payroll_runs",{...s,id:a});for(const l of n){const p=l.id||`slip-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;await this.saveDocument("payslips",{...l,id:p,payrollRunId:a})}const d=new N(this.db,this.storage);for(const l of r)await d.saveDocument("staff_transactions",{id:l,status:"PAID_IMMEDIATELY",payrollRunId:a},!0);if(o&&o.length>0){for(const p of o)await d.saveDocument("wallet_transactions",{id:p,isSettled:!0,payrollRunId:a},!0);const l=new Set}return a}catch(a){throw console.error("Finalize error:",a),a}}}const st=new V(J,Q);export{V as P,st as p};
