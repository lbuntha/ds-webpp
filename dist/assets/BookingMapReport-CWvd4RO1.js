import{r as o,q as N,m as k,x as E,w as B,j as i,n as S}from"./index-BUL6LB55.js";const U=()=>{const h=o.useRef(null),[c,D]=o.useState(null),[l,j]=o.useState(null),[g,C]=o.useState([]),[f,R]=o.useState([]),[A,w]=o.useState(!0),v={lat:11.5564,lng:104.9282};o.useEffect(()=>{w(!0);const t=N(k(S,"parcel_bookings")),d=E(t,e=>{const n=e.docs.map(r=>({id:r.id,...r.data()})).filter(r=>{const a=(r.status||"").toUpperCase();return!["COMPLETED","CANCELLED","RETURN_TO_SENDER","REJECTED"].includes(a)});C(n)},e=>{console.error("Error watching bookings:",e)}),x=N(k(S,"users"),B("role","in",["driver","fleet-driver"])),y=E(x,e=>{const s=e.docs.map(n=>({uid:n.id,...n.data()}));R(s),w(!1)},e=>{console.error("Error watching drivers:",e),w(!1)});return()=>{d(),y()}},[]),o.useEffect(()=>{if(!document.getElementById("leaflet-css")){const t=document.createElement("link");t.id="leaflet-css",t.rel="stylesheet",t.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",document.head.appendChild(t)}if(window.L)setTimeout(L,100);else{const t=document.createElement("script");t.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",t.async=!0,t.onload=L,document.body.appendChild(t)}},[]);const L=()=>{if(!(!h.current||h.current._leaflet_id))try{const t=window.L.map(h.current).setView([v.lat,v.lng],12);window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(t);const d=window.L.layerGroup().addTo(t);D(t),j(d)}catch(t){console.error("Map init error:",t)}};return o.useEffect(()=>{if(!c||!l)return;l.clearLayers();const t=[],d=window.L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});window.L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});const x=window.L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});if(g.forEach(e=>{var n,r;const s=(e.status||"PENDING").toUpperCase();if(["PENDING","CONFIRMED"].includes(s)){const a=(u,m)=>!isNaN(Number(u))&&!isNaN(Number(m))&&Number(u)!==0&&Number(m)!==0,p=(n=e.pickupLocation)==null?void 0:n.lat,b=(r=e.pickupLocation)==null?void 0:r.lng;if(a(p,b)){const u=e.items?e.items.length:0,m=window.L.marker([p,b],{icon:d});m.bindPopup(`
                         <div class="p-2 min-w-[150px]">
                             <strong class="text-red-700 text-lg">${u} Parcel${u!==1?"s":""}</strong><br/>
                             <div class="mt-1 font-medium">${e.senderName||"Unknown Sender"}</div>
                             <div class="text-xs text-gray-500 mb-1">${e.senderPhone}</div>
                             <div class="text-xs text-gray-600 mb-1">Booking: ${e.id.slice(-6)}</div>
                             <div class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-800 border border-yellow-200">
                                ${s}
                             </div>
                             <p class="text-xs italic mt-2 border-t pt-1 border-gray-100">${e.pickupAddress||""}</p>
                         </div>
                     `),l.addLayer(m),t.push([p,b])}}}),f.filter(e=>e.lastLocation&&(e.lastLocation.lat!==void 0&&e.lastLocation.lng!==void 0||e.lastLocation.latitude!==void 0&&e.lastLocation.longitude!==void 0)).forEach(e=>{const s=e.lastLocation,n=Number((s==null?void 0:s.lat)??(s==null?void 0:s.latitude)),r=Number((s==null?void 0:s.lng)??(s==null?void 0:s.longitude));if(!isNaN(n)&&!isNaN(r)&&n!==0&&r!==0){const a=window.L.marker([n,r],{icon:x}),p=s!=null&&s.timestamp?new Date(s.timestamp).toLocaleTimeString():"?";a.bindPopup(`
                    <div class="p-2">
                        <strong class="text-blue-700">DRIVER: ${e.name}</strong><br/>
                        <span class="text-xs text-gray-500">Phone: ${e.phone||"N/A"}</span><br/>
                        <span class="text-xs">Last Active: ${p}</span>
                    </div>
                `),l.addLayer(a),t.push([n,r])}}),t.length>0&&c)try{const e=window.L.latLngBounds(t);e.isValid()?c.fitBounds(e,{padding:[50,50],maxZoom:15}):console.warn("Invalid bounds generated from points:",t)}catch(e){console.error("Error fitting bounds:",e)}else c&&t.length},[c,l,g,f]),i.jsxs("div",{className:"flex flex-col h-full bg-white rounded-lg shadow-sm",children:[i.jsxs("div",{className:"p-4 border-b border-gray-100 flex justify-between items-center",children:[i.jsx("h2",{className:"text-lg font-bold text-gray-800",children:"Booking Map Report (Live)"}),i.jsxs("div",{className:"text-sm text-gray-500",children:[f.length," Drivers Found | ",g.length," Active Orders"]})]}),i.jsxs("div",{className:"flex-1 relative min-h-[500px]",children:[A&&g.length===0&&f.length===0&&i.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-50 z-10",children:i.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"})}),i.jsx("div",{ref:h,className:"w-full h-full z-0"})]})]})};export{U as BookingMapReport};
