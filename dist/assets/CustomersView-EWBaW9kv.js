import{r,j as e,f as x}from"./index-BUL6LB55.js";import{B as m}from"./Button-CqEssTF4.js";import{M as q}from"./Modal-CwdR8lyW.js";import{t as n}from"./toast-DfW6NkLH.js";const H=({customers:y,users:u,onRefresh:f})=>{const[t,d]=r.useState(null),[c,i]=r.useState(!1),[o,h]=r.useState(""),[g,a]=r.useState(null),[j,N]=r.useState(""),[D,b]=r.useState(""),[A,v]=r.useState(""),[U,w]=r.useState(""),[T,k]=r.useState(""),[E,C]=r.useState("INDIVIDUAL"),[L,S]=r.useState(""),[M,I]=r.useState(""),[F,B]=r.useState(!1);r.useEffect(()=>{t?(N(t.name),b(t.phone||""),v(t.email||""),w(t.address||""),k(t.referralCode||""),C(t.type||"INDIVIDUAL"),S(t.linkedUserId||""),I(t.remark||"")):R()},[t]);const R=()=>{N(""),b(""),v(""),w(""),k(""),C("INDIVIDUAL"),S(""),I("")},P=()=>{d(null),R(),i(!0)},G=s=>{d(s),i(!1)},O=s=>{a(s)},V=async()=>{if(g)try{await x.deleteDocument("customers",g),n.success("Customer deleted successfully"),f()}catch(s){console.error(s),n.error("Failed to delete customer")}finally{a(null)}},$=async s=>{s.preventDefault(),B(!0);try{const l={name:j,phone:D,email:A,address:U,referralCode:T,type:E,remark:M,updatedAt:Date.now()};if(L&&(l.linkedUserId=L),t)await x.updateCustomer({...l,id:t.id}),n.success("Customer updated");else{const p=`cust_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;l.id=p,l.createdAt=Date.now(),await x.createCustomer(l),n.success("Customer created")}f(),d(null),i(!1)}catch(l){console.error(l),n.error("Failed to save customer")}finally{B(!1)}},W=y.filter(s=>{const l=u.find(p=>p.uid===s.linkedUserId);return l&&l.role!=="customer"?!1:(s.name||"").toLowerCase().includes(o.toLowerCase())||(s.phone||"").includes(o)||(s.email||"").toLowerCase().includes(o.toLowerCase())}),z=u.filter(s=>s.status!=="REJECTED");return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-xl",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Customers"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Manage customer records and linkages"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search customers...",className:"pl-10 pr-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500",value:o,onChange:s=>h(s.target.value)}),e.jsx("svg",{className:"w-5 h-5 text-gray-400 absolute left-3 top-2.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]}),e.jsxs(m,{onClick:P,children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Add Customer"]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Contact"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Type"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Telegram"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Linked User"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:W.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500 text-sm",children:"No customers found matching your search."})}):W.map(s=>{const l=u.find(p=>p.uid===s.linkedUserId);return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"h-10 w-10 flex-shrink-0",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 font-bold",children:(s.name||"?").charAt(0).toUpperCase()})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.code||s.id.slice(0,8)})]})]})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:s.phone}),e.jsx("div",{className:"text-sm text-gray-500",children:s.email})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${s.type==="CORPORATE"?"bg-purple-100 text-purple-800":"bg-blue-100 text-blue-800"}`,children:s.type||"INDIVIDUAL"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:s.telegramChatId?e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsx("span",{className:"text-green-600 font-medium",children:s.telegramChatType==="group"||s.telegramChatType==="supergroup"?e.jsx("span",{title:s.telegramGroupName||"Group",children:"Group"}):"Private"})]}):e.jsx("span",{className:"text-gray-400 italic",children:"â€”"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:l?e.jsxs("div",{className:"flex items-center text-green-600",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101"})}),l.name]}):e.jsx("span",{className:"text-gray-400 italic",children:"Unlinked"})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:[e.jsx("button",{onClick:()=>G(s),className:"text-indigo-600 hover:text-indigo-900 mr-4",children:"Edit"}),e.jsx("button",{onClick:()=>O(s.id),className:"text-red-600 hover:text-red-900",children:"Delete"})]})]},s.id)})})]})}),(c||t)&&e.jsx(q,{isOpen:!0,onClose:()=>{i(!1),d(null)},title:c?"Add New Customer":"Edit Customer",maxWidth:"max-w-3xl",children:e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Full Name *"}),e.jsx("input",{type:"text",required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm",value:j,onChange:s=>N(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Phone *"}),e.jsx("input",{type:"tel",required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm",value:D,onChange:s=>b(s.target.value)})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Email Address *"}),e.jsx("input",{type:"email",required:!0,className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm",value:A,onChange:s=>v(s.target.value)})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Address"}),e.jsx("textarea",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm",rows:3,value:U,onChange:s=>w(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Referral Code"}),e.jsx("input",{type:"text",className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm uppercase",value:T,onChange:s=>k(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Account Type"}),e.jsxs("select",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm",value:E,onChange:s=>C(s.target.value),children:[e.jsx("option",{value:"INDIVIDUAL",children:"Individual"}),e.jsx("option",{value:"CORPORATE",children:"Corporate"})]})]}),e.jsxs("div",{className:"col-span-2 border-t pt-4 mt-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Link User Account (Optional)"}),e.jsxs("select",{className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm",value:L,onChange:s=>S(s.target.value),children:[e.jsx("option",{value:"",children:"-- No Linked User --"}),z.map(s=>e.jsxs("option",{value:s.uid,children:[s.name," (",s.email,")"]},s.uid))]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Linking a user enables them to view this customer's data and bookings."})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Remarks (Internal)"}),e.jsx("textarea",{className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm",rows:2,placeholder:"Internal notes about this customer...",value:M,onChange:s=>I(s.target.value)})]}),t&&e.jsxs("div",{className:"col-span-2 border-t pt-4 mt-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Telegram Notifications"}),t.telegramChatId?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"font-medium",children:"Connected to Telegram"})]}),e.jsxs("div",{className:"mt-2 text-sm text-green-600 space-y-1",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Type:"})," ",t.telegramChatType==="group"||t.telegramChatType==="supergroup"?`Group Chat${t.telegramGroupName?` (${t.telegramGroupName})`:""}`:"Private Chat"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Chat ID:"})," ",e.jsx("code",{className:"bg-green-100 px-1 rounded text-xs",children:t.telegramChatId})]}),t.telegramLinkedBy&&e.jsxs("p",{children:[e.jsx("span",{className:"text-gray-500",children:"Linked by:"})," ",t.telegramLinkedBy]})]})]}):e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{className:"font-medium",children:"Not Connected"})]}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Customer can link their Telegram by messaging the bot with:"}),e.jsxs("code",{className:"mt-1 inline-block bg-gray-200 px-2 py-1 rounded text-sm font-mono",children:["/link ",t.code||t.id.slice(0,8)]}),e.jsx("p",{className:"mt-2 text-xs text-gray-400",children:"They can add the bot to a group chat or message it directly."})]})]})]}),e.jsxs("div",{className:"mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3",children:[e.jsx(m,{type:"submit",className:"w-full sm:col-start-2",isLoading:F,children:c?"Create Customer":"Save Changes"}),e.jsx(m,{type:"button",variant:"outline",className:"mt-3 w-full sm:mt-0 sm:col-start-1",onClick:()=>{i(!1),d(null)},children:"Cancel"})]})]})}),g&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 backdrop-blur-sm p-4",children:e.jsx("div",{className:"w-full max-w-sm bg-white rounded-2xl shadow-xl overflow-hidden ring-1 ring-black ring-opacity-5 animate-scale-in",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 mb-4",children:e.jsx("svg",{className:"h-6 w-6 text-red-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsx("h3",{className:"text-lg font-medium leading-6 text-gray-900",children:"Delete Customer"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"Are you sure you want to delete this customer? This action cannot be undone."}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 gap-3",children:[e.jsx(m,{variant:"outline",onClick:()=>a(null),children:"Cancel"}),e.jsx(m,{className:"bg-red-600 hover:bg-red-700 text-white",onClick:V,children:"Delete"})]})]})})})]})};function X(){const[y,u]=r.useState([]),[f,t]=r.useState([]),[d,c]=r.useState(!0),[i,o]=r.useState(!1),h=async()=>{try{c(!0);const[a,j]=await Promise.all([x.getCustomers(),x.getUsers()]);u(a),t(j)}catch(a){console.error("Failed to load customers:",a),n.error("Failed to load customer data")}finally{c(!1)}},g=async()=>{o(!0);try{const a=await x.syncService.syncAllUsersToCustomers();n.success(`Synced ${a.synced} customer(s)`),a.errors.length>0&&console.warn("Sync errors:",a.errors),await h()}catch(a){console.error("Sync failed:",a),n.error("Failed to sync customer data")}finally{o(!1)}};return r.useEffect(()=>{h()},[]),d?e.jsx("div",{className:"flex items-center justify-center p-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-blue-900",children:"Data Sync"}),e.jsx("p",{className:"text-sm text-blue-700",children:"Sync customer data from user profiles to ensure consistency."})]}),e.jsxs(m,{onClick:g,isLoading:i,variant:"primary",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"Sync All"]})]}),e.jsx(H,{customers:y,users:f,onRefresh:h})]})}export{X as default};
