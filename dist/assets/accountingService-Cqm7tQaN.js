import{A}from"./index-BUL6LB55.js";class C{static validateEntry(u){const o=u.lines.reduce((c,r)=>c+r.debit,0),f=u.lines.reduce((c,r)=>c+r.credit,0);return Math.abs(o-f)<.01}static validateLedgerHealth(u,o,f=[],c=[]){const r=[],d=u||[],n=o||[],I=f||[],e=c||[],s=new Set(n.map(t=>t.id)),i=new Map;n.forEach(t=>{const a=i.get(t.code)||[];i.set(t.code,[...a,t])}),i.forEach((t,a)=>{t.length>1&&r.push({severity:"WARNING",type:"DUPLICATE_COA",message:`Duplicate Account Code detected: ${a}. ${t.length} accounts share this code.`,date:new Date().toISOString().split("T")[0],meta:{accounts:t}})});const g=new Date().toISOString().split("T")[0],E=I.filter(t=>t.status==="DRAFT"&&t.date<=g);E.length>0&&r.push({severity:"WARNING",type:"UNPOSTED_DOC",message:`Found ${E.length} unposted Draft Invoices. These are not reflected in financial reports.`,date:g});const p=e.filter(t=>t.status==="DRAFT"&&t.date<=g);return p.length>0&&r.push({severity:"WARNING",type:"UNPOSTED_DOC",message:`Found ${p.length} unposted Draft Bills. These are not reflected in financial reports.`,date:g}),d.forEach(t=>{if(!this.validateEntry(t)){const a=t.lines.reduce((h,y)=>h+y.debit,0),l=t.lines.reduce((h,y)=>h+y.credit,0);r.push({severity:"CRITICAL",type:"UNBALANCED",message:`Transaction ${t.reference||t.id} is unbalanced. Debit: ${a.toFixed(2)}, Credit: ${l.toFixed(2)}`,transactionId:t.id,date:t.date})}t.lines.length===0&&r.push({severity:"WARNING",type:"EMPTY",message:`Transaction ${t.reference||t.id} has no line items.`,transactionId:t.id,date:t.date}),t.lines.forEach(a=>{s.has(a.accountId)||r.push({severity:"CRITICAL",type:"ORPHANED_ACCOUNT",message:`Transaction ${t.reference||t.id} refers to a missing account ID: ${a.accountId}`,transactionId:t.id,date:t.date})})}),r}static generatePeriodClosingEntry(u,o,f,c,r,d){const n=c||[],I=f||[],e=n.filter(a=>a.date>=u&&a.date<=o&&(!d||a.branchId===d)&&!a.isClosingEntry);if(e.length===0)return null;const s={};e.forEach(a=>{a.lines.forEach(l=>{const h=I.find(y=>y.id===l.accountId);if(h&&(h.type===A.REVENUE||h.type===A.EXPENSE)){const y=s[l.accountId]||0;s[l.accountId]=y+(l.debit-l.credit)}})});const i=[];let g=0,E=0;if(Object.entries(s).forEach(([a,l])=>{if(!(Math.abs(l)<.01))if(l>0)i.push({accountId:a,debit:0,credit:l}),E+=l;else{const h=Math.abs(l);i.push({accountId:a,debit:h,credit:0}),g+=h}}),i.length===0)return null;const p=g-E;return Math.abs(p)>.01&&(p>0?i.push({accountId:r,debit:0,credit:p}):i.push({accountId:r,debit:Math.abs(p),credit:0})),{id:`je-close-${o}-${Date.now()}`,date:o,description:`Period Closing Entry (${u} to ${o})`,reference:`CLOSE-${o.replace(/-/g,"")}`,branchId:d||"All",currency:"USD",exchangeRate:1,createdAt:Date.now(),isClosingEntry:!0,lines:i}}static generateTrialBalance(u,o,f){const c=new Map,r=o||[],d=u||[];d.forEach(e=>{c.set(e.id,{accountId:e.id,accountCode:e.code,accountName:e.name,type:e.type,debit:0,credit:0,isHeader:e.isHeader||!1,parentAccountId:e.parentAccountId,depth:0})}),r.forEach(e=>{f&&e.branchId!==f||e.lines.forEach(s=>{const i=c.get(s.accountId);i&&(i.debit+=s.debit,i.credit+=s.credit)})});const n=e=>{const s=d.find(i=>i.id===e);return!s||!s.parentAccountId||s.parentAccountId===e?0:1+n(s.parentAccountId)};return d.forEach(e=>{const s=c.get(e.id);s&&(s.depth=n(e.id))}),[...d].sort((e,s)=>{var E,p;const i=((E=c.get(e.id))==null?void 0:E.depth)||0;return(((p=c.get(s.id))==null?void 0:p.depth)||0)-i}).forEach(e=>{if(e.parentAccountId){const s=c.get(e.id),i=c.get(e.parentAccountId);s&&i&&(i.debit+=s.debit,i.credit+=s.credit)}}),Array.from(c.values()).filter(e=>e.debit>.001||e.credit>.001||e.isHeader).sort((e,s)=>e.accountCode.localeCompare(s.accountCode))}static generateGeneralLedger(u,o){const f=[];let c=0;return[...o||[]].sort((n,I)=>new Date(n.date).getTime()-new Date(I.date).getTime()).forEach(n=>{n.lines.filter(e=>e.accountId===u).forEach(e=>{c+=e.debit-e.credit,f.push({date:n.date,journalId:n.id,description:e.description||n.description,reference:n.reference,debit:e.debit,credit:e.credit,balance:c,displayedBalance:c})})}),f}static calculateNetIncome(u,o,f){const c=this.generateTrialBalance(u,o,f);let r=0,d=0;return c.forEach(n=>{n.depth===0&&(n.type===A.REVENUE?r+=n.credit-n.debit:n.type===A.EXPENSE&&(d+=n.debit-n.credit))}),r-d}}export{C as A};
