
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 1. CORE USERS & CRM ---
    match /users/{userId} {
      // DEV MODE: Allow unauthenticated lookup by phone for reset flow (GET and LIST)
      allow get: if true; 
      allow list: if request.query.limit == 1;
      
      // Allow users to create their own document (for signup) OR system-admin for others
      allow create: if isSystemAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow delete: if isSystemAdmin();
      
      // Allow authenticated updates OR unauthenticated PIN reset (DEV MODE)
      // In production, PIN reset should go through a secure backend
      allow update: if isSystemAdmin() || isOwner(userId) || isAuthenticated() 
                    || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pin', 'hasPin', 'updatedAt']));
    }

    // OTP Codes - Allow unauthenticated access for phone signup/login
    // Rate limiting should be handled in application code
    match /otp_codes/{phone} {
      allow read, write: if true;
    }

    // --- 1. HELPER FUNCTIONS (kept for reference) ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == role;
    }

    function isSystemAdmin() { return hasRole('system-admin'); }
    function isFinance() { return hasRole('finance-manager') || hasRole('accountant') || isSystemAdmin(); }
    function isWarehouse() { return hasRole('warehouse') || isSystemAdmin(); }
    function isDriver() { return hasRole('driver'); }
    function isCustomer() { return hasRole('customer'); }
    
    function isOwner(userId) { return isAuthenticated() && request.auth.uid == userId; }


    // --- 2. CRM ---
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow write: if isFinance() || isSystemAdmin();
      allow create: if isAuthenticated();
    }

    // --- 3. LOGISTICS ENGINE ---
    match /parcel_bookings/{bookingId} {
      allow read: if isSystemAdmin() || isWarehouse() || isFinance()
                  || (isCustomer() && (resource.data.senderId == getUserData().linkedCustomerId || resource.data.senderName == getUserData().name))
                  || (isDriver() && (resource.data.driverId == request.auth.uid || resource.data.status == 'PENDING'));

      allow create: if isAuthenticated();

      allow update: if isSystemAdmin() || isWarehouse() || isFinance()
          || (isDriver() && resource.data.driverId == request.auth.uid)
          || (isDriver() && resource.data.involvedDriverIds.hasAny([request.auth.uid]))
          || (isDriver() && (resource.data.get('driverId', '') == '') && request.resource.data.driverId == request.auth.uid)
          || (isCustomer() && resource.data.status == 'PENDING' && request.resource.data.status == 'CANCELLED');
              
      allow delete: if isSystemAdmin();
    }

    // --- 4. FINANCIAL LEDGER ---
    match /transactions/{txnId} {
      allow read: if isFinance();
      allow write: if isFinance();
      allow delete: if isSystemAdmin();
    }
    
    match /accounts/{accountId} {
      allow read: if isAuthenticated();
      allow write: if isFinance();
    }

    match /invoices/{docId} {
      allow read: if isFinance() || (isCustomer() && resource.data.customerId == getUserData().linkedCustomerId);
      allow write: if isFinance();
    }
    
    match /bills/{docId} { allow read, write: if isFinance(); }
    match /bill_payments/{docId} { allow read, write: if isFinance(); }
    match /payments/{docId} { allow read, write: if isFinance(); }
    match /vendors/{docId} { allow read, write: if isFinance(); }
    match /fixed_assets/{id} { allow read, write: if isFinance(); }
    match /fixed_asset_categories/{id} { allow read, write: if isFinance(); }

    // --- 5. WALLET SYSTEM ---
    match /wallet_transactions/{txnId} {
      allow read: if isOwner(resource.data.userId) || isFinance();
      allow create: if isAuthenticated();
      allow update: if isFinance();
      allow delete: if isSystemAdmin();
    }

    // --- 6. SYSTEM CONFIGURATION ---
    match /settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }
    
    match /branches/{docId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }
    
    match /parcel_services/{id} { allow read: if isAuthenticated(); allow write: if isSystemAdmin(); }
    match /parcel_statuses/{id} { allow read: if isAuthenticated(); allow write: if isSystemAdmin(); }
    match /parcel_promotions/{id} { allow read: if isAuthenticated(); allow write: if isSystemAdmin(); }
    match /driver_commissions/{id} { allow read: if isAuthenticated(); allow write: if isSystemAdmin(); }
    match /referral_rules/{id} { allow read: if isAuthenticated(); allow write: if isSystemAdmin(); }
    match /customer_rates/{id} { allow read: if isAuthenticated(); allow write: if isSystemAdmin() || isFinance(); }
    
    match /currencies/{code} { allow read: if isAuthenticated(); allow write: if isFinance(); }
    match /tax_rates/{id} { allow read: if isAuthenticated(); allow write: if isFinance(); }

    // --- 7. HR & STAFF ---
    match /employees/{id} { allow read: if isAuthenticated(); allow write: if isSystemAdmin() || isFinance(); }
    match /staff_loans/{id} { allow read, write: if isFinance(); }
    match /loan_repayments/{id} { allow read, write: if isFinance(); }
    
    // --- 8. COMMUNICATION ---
    match /chat_messages/{msgId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow delete: if isSystemAdmin();
    }
    
    match /notifications/{notifId} {
      allow read: if isAuthenticated() && (
        resource.data.targetAudience == request.auth.uid || 
        resource.data.targetAudience == getUserData().role ||
        resource.data.targetAudience == 'ALL'
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isSystemAdmin();
    }
    
    // --- 9. MAPS & PLACES ---
    match /place/{placeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isSystemAdmin() || isWarehouse();
    }

    // --- 10. DYNAMIC NAVIGATION ---
    match /navigation_menu/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }
    
    match /app_routes/{routeId} {
      allow read: if isAuthenticated();
      allow write: if isSystemAdmin();
    }
    // --- FINAL FALLBACK: AUTHENTICATED USERS ---
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
